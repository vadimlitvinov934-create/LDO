{% extends "base.html" %}
{% block title %}Журнал (Просмотр) — {{ group }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
  :root {
    --bg-page: #f3f4f6;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5;
    --border-color: #e5e7eb;
    
    --radius-md: 12px;
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    
    /* Статусы */
    --color-present-bg: #dcfce7; --color-present-text: #166534;
    --color-late-bg: #ffedd5; --color-late-text: #9a3412;
    --color-absent-bg: #fee2e2; --color-absent-text: #991b1b;
    --color-excused-bg: #dbeafe; --color-excused-text: #1e40af;
    --color-skip-bg: #f3f4f6; --color-skip-text: #9ca3af;
  }

  body { background: var(--bg-page); color: var(--text-primary); font-family: 'Inter', sans-serif; }

  /* ЗАГОЛОВОК И НАВИГАЦИЯ */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-title h1 { font-size: 24px; font-weight: 700; margin: 0; }
  .page-title .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
  
  .nav-form {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #fff;
    padding: 6px 12px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }
  
  .date-input {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 14px;
    background: #f9fafb;
    color: var(--text-primary);
  }
  
  .btn-action {
    background: var(--primary-color);
    color: #fff;
    border: none;
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-action:hover { background: #4338ca; }
  
  .btn-back {
    background: #fff;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    display: flex; align-items: center; gap: 6px;
    transition: 0.2s;
  }
  .btn-back:hover { background: #f3f4f6; color: var(--text-primary); }

  /* ТАБЛИЦА ЖУРНАЛА */
  .journal-card {
    background: #fff;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-bottom: 24px;
  }
  
  .table-responsive {
    overflow-x: auto;
    scrollbar-width: thin;
    max-height: 500px; /* Вертикальный скролл если много студентов */
  }

  .journal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap;
  }

  .journal-table thead th {
    position: sticky; top: 0; z-index: 10;
    background: #f9fafb;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
    box-shadow: 0 1px 0 rgba(0,0,0,0.05); /* Тень от хедера */
  }
  .journal-table thead th:nth-child(2), .journal-table thead th:nth-child(3) { text-align: left; } /* UID и ФИО */
  
  .journal-table tbody td {
    padding: 10px 16px;
    border-bottom: 1px solid #f3f4f6;
    color: var(--text-primary);
    vertical-align: middle;
  }
  .journal-table tbody tr:hover { background: #f8fafc; }

  .col-uid { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-secondary); }
  .col-name { font-weight: 500; }

  /* Бейджи статусов */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    gap: 4px;
  }
  .badge.present { background: var(--color-present-bg); color: var(--color-present-text); }
  .badge.late { background: var(--color-late-bg); color: var(--color-late-text); }
  .badge.absent { background: var(--color-absent-bg); color: var(--color-absent-text); }
  .badge.excused { background: var(--color-excused-bg); color: var(--color-excused-text); }
  .badge.skip { background: var(--color-skip-bg); color: var(--color-skip-text); opacity: 0.7; }
  .badge.empty { color: #d1d5db; font-size: 16px; font-weight: 400; padding: 0; }

  .th-skipped { opacity: 0.5; text-decoration: line-through; }
  .reason-text { font-weight: 400; opacity: 0.7; margin-left: 4px; font-size: 10px; }


  /* НИЖНЯЯ СЕКЦИЯ (Диаграмма + Рейтинг) */
  .grid-bottom {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 24px;
    align-items: start;
  }
  @media (max-width: 900px) { .grid-bottom { grid-template-columns: 1fr; } }

  .stats-card {
    background: #fff;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    padding: 20px;
  }
  .stats-card h3 {
    font-size: 15px; font-weight: 700; margin: 0 0 16px 0; color: var(--text-primary);
    padding-bottom: 10px; border-bottom: 1px solid #f3f4f6;
  }

  .chart-container { height: 220px; position: relative; width: 100%; display: flex; justify-content: center; }

  .legend {
    display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; justify-content: center;
  }
  .legend-item {
    font-size: 11px; font-weight: 500; color: var(--text-secondary);
    display: flex; align-items: center; gap: 4px;
    background: #f9fafb; padding: 4px 8px; border-radius: 4px;
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  /* Рейтинг таблица */
  .rating-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .rating-table th { text-align: left; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; padding: 8px; border-bottom: 1px solid var(--border-color); }
  .rating-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; }
  .rating-val { font-weight: 700; color: var(--primary-color); }

</style>

<div class="page-header">
  <div class="page-title">
    <h1>Журнал: {{ group }}</h1>
    <div class="subtitle">Дата просмотра: {{ selected_date }}</div>
  </div>

  <form class="nav-form" method="get" action="{{ url_for('head_bp.head_journal') }}">
    <input type="hidden" name="g" value="{{ group }}">
    <a class="btn-back" href="{{ url_for('head_bp.head_groups') }}">
      <i class="fas fa-arrow-left"></i> Назад
    </a>
    <input class="date-input" type="date" name="d" value="{{ selected_date }}" max="{{ today }}" required />
    <button type="submit" class="btn-action">Обновить</button>
  </form>
</div>

<div class="journal-card">
  <div class="table-responsive">
    <table class="journal-table">
      <thead>
        <tr>
          <th>#</th>
          <th>UID</th>
          <th>ФИО Студента</th>
          {% for p in schedule %}
            {% set is_skipped = skipped_codes and (p.code in skipped_codes) and p.code.startswith('p') %}
            <th class="{% if is_skipped %}th-skipped{% endif %}">
              <div style="display:flex; flex-direction:column; align-items:center;">
                <span>{{ p.title }}</span>
                <span style="font-weight:400; font-size:10px; opacity:0.7;">{{ p.start }}–{{ p.end }}</span>
              </div>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in table %}
          <tr>
            <td style="text-align:center; color:var(--text-secondary);">{{ r.num }}</td>
            <td class="col-uid">{{ r.uid }}</td>
            <td class="col-name">{{ r.full_name }}</td>
            
            {% for c in r.cells %}
              {% set _raw = c.status or '' %}
              {% set _parts = _raw.split(':') %}
              {% set status_key = _parts[0] if _parts and _parts[0] else '' %}
              {% set _sub = _parts[1] if _parts|length > 1 else '' %}
              
              {% set label = "—" %}
              {% if status_key == 'present' %}{% set label = "Был" %}{% endif %}
              {% if status_key == 'late' %}{% set label = "Опоздал" %}{% endif %}
              {% if status_key == 'absent' %}{% set label = "Н/Б" %}{% endif %}
              {% if status_key == 'excused' %}{% set label = "Уваж." %}{% endif %}
              {% if status_key == 'skip' %}{% set label = "Нет пары" %}{% endif %}

              <td style="text-align:center;">
                {% if status_key and status_key != 'empty' %}
                   <span class="badge {{ status_key }}">
                     {{ label }}
                     {% if _sub and status_key == 'excused' %}
                       <span class="reason-text">({{ _sub|capitalize }})</span>
                     {% endif %}
                     {% if c.mark %} <span class="reason-text">· {{ c.mark }}</span> {% endif %}
                   </span>
                {% else %}
                   <span class="badge empty">·</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid-bottom">
  
  <div class="stats-card">
    <h3>Итоги дня (%)</h3>
    <div class="chart-container">
      <canvas id="dayPie"></canvas>
    </div>
    
    <script type="application/json" id="day-pcts-json">{{ day_percentages | tojson }}</script>
    
    <div class="legend">
      <div class="legend-item"><span class="dot" style="background:#10b981"></span> Присут.</div>
      <div class="legend-item"><span class="dot" style="background:#f59e0b"></span> Опозд.</div>
      <div class="legend-item"><span class="dot" style="background:#ef4444"></span> Отсут.</div>
      <div class="legend-item"><span class="dot" style="background:#3b82f6"></span> Уваж.</div>
    </div>
    <div style="text-align:center; margin-top:10px; font-size:12px; color:var(--text-secondary);">
      Всего ячеек: {{ day_percentages.total }}
    </div>
  </div>

  <div class="stats-card">
    <h3>Рейтинг посещаемости (за сегодня)</h3>
    <div style="overflow-y:auto; max-height:280px; scrollbar-width:thin;">
      <table class="rating-table">
        <thead>
          <tr>
            <th style="width:40px;">#</th>
            <th>Студент</th>
            <th style="text-align:right;">Посещено</th>
            <th style="text-align:right;">%</th>
          </tr>
        </thead>
        <tbody>
          {% for row in ranking %}
            <tr>
              <td style="color:var(--text-secondary); text-align:center;">{{ loop.index }}</td>
              <td>{{ row.name }}</td>
              <td style="text-align:right;">{{ row.attended }}/{{ row.total }}</td>
              <td style="text-align:right;" class="rating-val">{{ "%.0f"|format(row.percent) }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
(function(){
  // Авто-сабмит при смене даты
  const input = document.querySelector('.date-input');
  if(input) {
    input.addEventListener('change', () => input.form.requestSubmit());
  }

  // Диаграмма
  const jsonEl = document.getElementById('day-pcts-json');
  let d = {present:0, late:0, absent:0, excused_sick:0, excused_other:0, total:0};
  try{ if(jsonEl?.textContent){ d = JSON.parse(jsonEl.textContent); } }catch(e){}
  
  const ctx = document.getElementById('dayPie');
  if (ctx && window.Chart){
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Присут.', 'Опозд.', 'Отсут.', 'Болеют', 'Др. уваж.'],
        datasets: [{
          data: [d.present, d.late, d.absent, d.excused_sick, d.excused_other],
          backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#6366f1'],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
          legend: { display: false } // Легенду сделали свою кастомную
        }
      }
    });
  }
})();
</script>

{% endblock %}