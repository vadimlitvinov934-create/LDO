
--- FILE: .\app.py ---
from datetime import timedelta
from flask import Flask, redirect, session

from config import Config
from core.db_init import init_database

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Blueprint-Ñ‹ (Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¸Ğ¼ĞµĞ½Ğ° Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²!)
from core.auth_bp import auth_bp
from core.checkin_bp import checkin_bp
from core.journal_bp import journal_bp
from core.student_bp import student_bp
from core.admin_bp import admin_bp
# admin_console_bp Ğ¼Ñ‹ ÑƒĞ´Ğ°Ğ»Ğ¸Ğ»Ğ¸, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ½Ğµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼
from core.api_bp import api_bp
from core.complaints_bp import complaints_bp
from core.head_bp import head_bp
from core.curator_bp import curator_bp
from core.starosta import starosta_bp # Ğ¤Ğ°Ğ¹Ğ» Ğ¿ĞµÑ€ĞµĞ½ĞµÑĞµĞ½ Ğ² core/starosta.py


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers Ğ´Ğ»Ñ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def status_label(value: str) -> str:
    """
    Ğ§ĞµĞ»Ğ¾Ğ²ĞµĞºĞ¾Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸.
    Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ğ² ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°Ñ… ĞºĞ°Ğº Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€: {{ r.status|status_label }}.
    """
    if not value:
        return ""
    v = value.lower()
    mapping = {
        "present": "ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
        "late": "ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»",
        "absent": "ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
        "excused": "Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ",
    }
    return mapping.get(v, value)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

app = Flask(__name__)
app.config.from_object(Config)

# ĞµÑĞ»Ğ¸ Ğ² Config Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ ÑĞµĞºÑ€ĞµÑ‚ â€” Ğ¿Ğ¾Ğ´ÑÑ‚Ñ€Ğ°Ñ…ÑƒĞµĞ¼ÑÑ
if not app.secret_key:
    app.secret_key = "change-me-ldo-secret-key"

app.permanent_session_lifetime = timedelta(days=30)

# Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹
init_database()

# Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ±Ğ»ÑĞ¿Ñ€Ğ¸Ğ½Ñ‚Ğ¾Ğ²
app.register_blueprint(auth_bp)
app.register_blueprint(checkin_bp)
app.register_blueprint(journal_bp)
app.register_blueprint(student_bp)
app.register_blueprint(admin_bp)
# app.register_blueprint(admin_console_bp) â€” ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾
app.register_blueprint(api_bp)
app.register_blueprint(complaints_bp)
app.register_blueprint(head_bp)
app.register_blueprint(curator_bp)
app.register_blueprint(starosta_bp)

# Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Jinja-Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²
app.jinja_env.filters["status_label"] = status_label


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

@app.route("/")
def index():
    """
    Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ: Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ñ€Ğ¾Ğ»Ğ¸.
    """
    role = (session.get("user") or {}).get("role")

    if role == "admin":
        return redirect("/admin/students/upload") # ĞšĞ¾Ğ½ÑĞ¾Ğ»ÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ğ»Ğ¸, Ğ²ĞµĞ´ĞµĞ¼ Ğ½Ğ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ
    if role == "head":
        return redirect("/head")
    if role == "starosta":
        return redirect("/starosta")
    if role == "student":
        return redirect("/student")
    if role == "curator":
        return redirect("/curator") # Ğ’ĞµĞ´ĞµĞ¼ Ğ½Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹

    # Ğ½ĞµÑ‚ Ñ€Ğ¾Ğ»Ğ¸ â†’ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ»Ğ¾Ğ³Ğ¸Ğ½Ğ°
    return redirect("/login")


if __name__ == "__main__":
    app.run(debug=True)
--- FILE: .\config.py ---
# config.py
from __future__ import annotations
from datetime import datetime, date
import os
from pathlib import Path

# ==== Ğ‘Ğ›ĞĞš ĞĞĞ¡Ğ¢Ğ ĞĞ•Ğš Ğ ĞĞ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ¯ / Ğ’Ğ Ğ•ĞœĞ•ĞĞ˜ ====

LATE_GRACE_MIN: int = 0  # Ğ»ÑŒĞ³Ğ¾Ñ‚Ğ° Ğ¾Ğ¿Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ² Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°Ñ…


def today_key(dt: datetime | None = None) -> str:
    d = dt or datetime.now()
    return d.strftime("%Y-%m-%d")


def to_minutes(hhmm: str) -> int:
    h, m = hhmm.split(":")
    return int(h) * 60 + int(m)


def now_minutes(dt: datetime | None = None) -> int:
    d = dt or datetime.now()
    return d.hour * 60 + d.minute


# ĞŸĞĞĞ•Ğ”Ğ•Ğ›Ğ¬ĞĞ˜Ğš â€” Ñ ĞºĞ»Ğ°ÑÑĞ½Ñ‹Ğ¼ Ñ‡Ğ°ÑĞ¾Ğ¼
MONDAY = [
    {"code": "kh", "title": "ĞšĞ». Ñ‡Ğ°Ñ", "start": "07:45", "end": "08:05"},
    {"code": "p1", "title": "ĞŸĞ°Ñ€Ğ° 1", "start": "08:10", "end": "09:30"},
    {"code": "p2", "title": "ĞŸĞ°Ñ€Ğ° 2", "start": "09:40", "end": "11:00"},
    {"code": "p3", "title": "ĞŸĞ°Ñ€Ğ° 3", "start": "11:40", "end": "13:00"},
    {"code": "p4", "title": "ĞŸĞ°Ñ€Ğ° 4", "start": "13:15", "end": "14:35"},
    {"code": "p5", "title": "ĞŸĞ°Ñ€Ğ° 5", "start": "14:45", "end": "16:05"},
    {"code": "p6", "title": "ĞŸĞ°Ñ€Ğ° 6", "start": "16:15", "end": "17:35"},
    {"code": "p7", "title": "ĞŸĞ°Ñ€Ğ° 7", "start": "17:40", "end": "19:00"},
]

# Ğ’Ğ¢â€“ĞŸĞ¢
TUE_FRI = [
    {"code": "p1", "title": "ĞŸĞ°Ñ€Ğ° 1", "start": "07:45", "end": "09:05"},
    {"code": "p2", "title": "ĞŸĞ°Ñ€Ğ° 2", "start": "09:15", "end": "10:35"},
    {"code": "p3", "title": "ĞŸĞ°Ñ€Ğ° 3", "start": "11:15", "end": "12:35"},
    {"code": "p4", "title": "ĞŸĞ°Ñ€Ğ° 4", "start": "12:50", "end": "14:10"},
    {"code": "p5", "title": "ĞŸĞ°Ñ€Ğ° 5", "start": "14:20", "end": "15:40"},
    {"code": "p6", "title": "ĞŸĞ°Ñ€Ğ° 6", "start": "15:45", "end": "17:05"},
    {"code": "p7", "title": "ĞŸĞ°Ñ€Ğ° 7", "start": "17:10", "end": "18:30"},
]

SATURDAY: list[dict] = []
SUNDAY: list[dict] = []

WEEKLY_SCHEDULE = {
    0: MONDAY,
    1: TUE_FRI,
    2: TUE_FRI,
    3: TUE_FRI,
    4: TUE_FRI,
    5: SATURDAY,
    6: SUNDAY,
}


def get_schedule_for(dt: date | datetime | None = None) -> list[dict]:
    d = dt or datetime.now()
    wd = d.weekday()
    return WEEKLY_SCHEDULE.get(wd, [])


# ==== Ğ‘Ğ›ĞĞš ĞšĞĞĞ¤Ğ˜Ğ“Ğ FLASK-ĞŸĞ Ğ˜Ğ›ĞĞ–Ğ•ĞĞ˜Ğ¯ ====

BASE_DIR = Path(__file__).resolve().parent

# ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸Ñ‚ÑŒ Ñ‡ĞµÑ€ĞµĞ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ:
#   SECRET_KEY, DATABASE_URL, FLASK_DEBUG
SECRET_KEY = os.getenv("SECRET_KEY", "change-me-ldo-secret-key")
# SQLite-Ñ„Ğ°Ğ¹Ğ» ldo.db Ñ€ÑĞ´Ğ¾Ğ¼ Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼
DATABASE_URL = os.getenv(
    "DATABASE_URL",
    f"sqlite:///{(BASE_DIR / 'ldo.db').as_posix()}",
)


class Config:
    """
    ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ´Ğ»Ñ Flask: app.config.from_object(Config)
    """

    # Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Flask
    SECRET_KEY = SECRET_KEY
    DEBUG = os.getenv("FLASK_DEBUG", "1") == "1"

    SESSION_COOKIE_HTTPONLY = True
    SESSION_COOKIE_SAMESITE = "Lax"
    SESSION_PERMANENT = True

    # ĞµÑĞ»Ğ¸ Ğ³Ğ´Ğµ-Ñ‚Ğ¾ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ±Ñ€Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ· app.config
    DATABASE_URL = DATABASE_URL

--- FILE: .\full.py ---
import os

extensions = ['.py', '.html', '.css', '.js'] # Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ñ, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±ĞµÑ€ĞµĞ¼
output_file = 'full_project.txt'

with open(output_file, 'w', encoding='utf-8') as outfile:
    for root, dirs, files in os.walk("."):
        # Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ¸ git
        if 'venv' in root or '.git' in root or '__pycache__' in root:
            continue
        for file in files:
            if any(file.endswith(ext) for ext in extensions):
                path = os.path.join(root, file)
                outfile.write(f"\n--- FILE: {path} ---\n") # Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ÑŒ
                try:
                    with open(path, 'r', encoding='utf-8') as infile:
                        outfile.write(infile.read())
                except Exception as e:
                    outfile.write(f"Error reading file: {e}")

print(f"Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ’ĞµÑÑŒ ĞºĞ¾Ğ´ Ğ² Ñ„Ğ°Ğ¹Ğ»Ğµ {output_file}")
--- FILE: .\mass_update_and_export.py ---
import os
from datetime import datetime
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from werkzeug.security import generate_password_hash
from models import SessionLocal, User, Student

# ==========================================
# 1. Ğ¡ĞŸĞ˜Ğ¡ĞšĞ˜ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ•Ğ™ Ğ˜ ĞĞĞ’Ğ«Ğ¥ ĞŸĞĞ ĞĞ›Ğ•Ğ™
# ==========================================

# Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸
STAFF = [
    {"role": "admin",    "fio": "ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€",                  "pass": "admin123"},
    {"role": "head",     "fio": "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ° Ğ“Ğ°Ğ»Ğ¸Ğ½Ğ° ĞŸĞµÑ‚Ñ€Ğ¾Ğ²Ğ½Ğ°",        "pass": "HEADPO"},
    {"role": "curator",  "fio": "Ğ¡ÑƒĞ»Ñ‚Ğ°Ğ½Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¾Ğ²Ğ° Ğ”Ğ¸Ğ°Ğ½Ğ° Ğ¡ĞµÑ€Ğ¸ĞºĞ¾Ğ²Ğ½Ğ°", "pass": "SDS2025PO115"},
    {"role": "curator",  "fio": "Ğ‘Ñ€ÑƒÑĞµĞ½ĞºĞ¾ Ğ’Ğ»Ğ°Ğ´Ğ¸ÑĞ»Ğ°Ğ² Ğ¡ĞµÑ€Ğ³ĞµĞµĞ²Ğ¸Ñ‡",   "pass": "BRU2025PO175"},
    {"role": "starosta", "fio": "Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ° ĞŸĞ175",                 "pass": "STAR175"},
]

# Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚Ñ‹ (Ğ¤Ğ˜Ğ: ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ)
STUDENTS_PASS = {
    "ĞĞ³ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğ¹ ĞœĞ¸Ñ€Ğ¾ÑĞ»Ğ°Ğ² ĞĞ¸ĞºĞ¾Ğ»Ğ°ĞµĞ²Ğ¸Ñ‡": "mirA24x",
    "ĞÑˆĞ¸Ğ¼Ğ±ĞµĞºĞ¾Ğ² ĞĞ»Ğ¸Ğ±ĞµĞº Ğ•Ñ€Ğ»Ğ°Ğ½Ğ±ĞµĞºĞ¾Ğ²Ğ¸Ñ‡": "ashEr09",
    "Ğ‘Ğ¸Ğ¼ÑƒÑ€Ğ·Ğ¸Ğ½ ĞĞ»Ğ¸ÑˆĞµÑ€ ĞÑÑ…Ğ°Ñ‚Ğ¾Ğ²Ğ¸Ñ‡": "bimAli27",
    "Ğ›Ğ¸Ñ‚Ğ²Ğ¸Ğ½Ğ¾Ğ² Ğ’Ğ°Ğ´Ğ¸Ğ¼ Ğ˜Ğ³Ğ¾Ñ€ĞµĞ²Ğ¸Ñ‡": "lv2009",
    # ... Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒ ÑÑĞ´Ğ° Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² ...
}

# ==========================================
# 2. Ğ¡ĞšĞ Ğ˜ĞŸĞ¢ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ¯ Ğ˜ Ğ­ĞšĞ¡ĞŸĞĞ Ğ¢Ğ
# ==========================================

def main():
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ passwords, ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ½ĞµÑ‚
    output_dir = "passwords"
    os.makedirs(output_dir, exist_ok=True)

    # Ğ˜Ğ¼Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ Ğ´Ğ°Ñ‚Ğ¾Ğ¹ Ğ¸ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼
    timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M")
    filename = f"{output_dir}/new_passwords_{timestamp}.xlsx"

    # ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ Excel
    wb = Workbook()
    ws = wb.active
    ws.title = "Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ñ‹"
    
    # Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸
    headers = ["Ğ¤Ğ˜Ğ", "Ğ Ğ¾Ğ»ÑŒ / Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°", "Ğ›Ğ¾Ğ³Ğ¸Ğ½ (Ğ¤Ğ˜Ğ)", "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ"]
    ws.append(headers)

    # Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¾Ñ‚Ñ‹
    header_font = Font(bold=True, color="FFFFFF")
    header_fill = PatternFill(start_color="4F46E5", end_color="4F46E5", fill_type="solid")
    thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))

    # ĞšÑ€Ğ°ÑĞ¸Ğ¼ ÑˆĞ°Ğ¿ĞºÑƒ
    for cell in ws[1]:
        cell.font = header_font
        cell.fill = header_fill
        cell.alignment = Alignment(horizontal="center")

    session = SessionLocal()
    count = 0

    print("--- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² ---")
    for u in STAFF:
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ‘Ğ”
        user_db = session.query(User).filter_by(fio=u["fio"]).first()
        p_hash = generate_password_hash(u["pass"])
        
        if not user_db:
            user_db = User(username=u["fio"], fio=u["fio"], role=u["role"], password_hash=p_hash)
            session.add(user_db)
        else:
            user_db.password_hash = p_hash
            user_db.role = u["role"]
        
        # ĞŸĞ¸ÑˆĞµĞ¼ Ğ² Excel
        ws.append([u["fio"], u["role"], u["fio"], u["pass"]])
        count += 1
        print(f"âœ”ï¸ {u['fio']}")

    print("\n--- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² ---")
    for fio, raw_pass in STUDENTS_PASS.items():
        st_db = session.query(Student).filter_by(full_name=fio).first()
        
        group_info = "Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚"
        if st_db:
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ Ğ² Ğ‘Ğ”
            st_db.password_hash = generate_password_hash(raw_pass)
            if st_db.group_code:
                group_info = st_db.group_code
            
            # ĞŸĞ¸ÑˆĞµĞ¼ Ğ² Excel
            ws.append([fio, group_info, fio, raw_pass])
            count += 1
            print(f"âœ”ï¸ {fio}")
        else:
            # Ğ•ÑĞ»Ğ¸ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¿Ğ¸ÑˆĞµĞ¼ Ğ² Excel Ğ¿Ğ¾Ğ¼ĞµÑ‚ĞºÑƒ (Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼)
            ws.append([fio, "ĞĞ•Ğ¢ Ğ’ Ğ‘ĞĞ—Ğ•", fio, raw_pass])
            print(f"âš ï¸ {fio} â€” Ğ½ĞµÑ‚ Ğ² Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…!")

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Ğ‘Ğ”
    session.commit()
    session.close()

    # ĞĞ²Ñ‚Ğ¾ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº Ğ² Excel
    for col in ws.columns:
        max_length = 0
        column = col[0].column_letter
        for cell in col:
            try:
                if len(str(cell.value)) > max_length:
                    max_length = len(str(cell.value))
            except:
                pass
        adjusted_width = (max_length + 2)
        ws.column_dimensions[column].width = adjusted_width
        
        # Ğ Ğ°Ğ¼ĞºĞ¸ Ğ²ÑĞµĞ¼ ÑÑ‡ĞµĞ¹ĞºĞ°Ğ¼
        for cell in col:
            cell.border = thin_border

    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»
    wb.save(filename)
    print(f"\nâœ… Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! Ğ¤Ğ°Ğ¹Ğ» ÑĞ¾Ğ·Ğ´Ğ°Ğ½: {filename}")

if __name__ == "__main__":
    main()
--- FILE: .\models.py ---
import os
from typing import Optional
from datetime import date, time as dtime, datetime

from sqlalchemy import (
    create_engine, Column, Integer, String, Date, Time, DateTime, Text, ForeignKey,
    UniqueConstraint, Index
)
from sqlalchemy.orm import (
    DeclarativeBase, Mapped, mapped_column, relationship,
    sessionmaker, scoped_session
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ Ğ‘Ğ”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DB_URL = os.getenv("DB_URL", "sqlite:///ldo.db")


class Base(DeclarativeBase):
    pass


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ¡Ğ¢Ğ£Ğ”Ğ•ĞĞ¢Ğ«
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Student(Base):
    __tablename__ = "students"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    uid: Mapped[str] = mapped_column(String(64), unique=True, index=True)
    full_name: Mapped[str] = mapped_column(String(255), index=True)
    # ĞšĞ¾Ğ´ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: "K-21", "IS-302")
    group_code: Mapped[Optional[str]] = mapped_column(String(32), index=True, nullable=True)
    
    # ĞĞĞ’ĞĞ• ĞŸĞĞ›Ğ•: Ğ¥ĞµÑˆ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ (Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ² Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ ĞºĞ°Ğ±Ğ¸Ğ½ĞµÑ‚)
    password_hash: Mapped[Optional[str]] = mapped_column(String(255), nullable=True)

    # Ğ’ÑĞµ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°
    records: Mapped[list["Attendance"]] = relationship(
        back_populates="student",
        cascade="all, delete-orphan"
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ–Ğ£Ğ ĞĞĞ› ĞŸĞĞ¡Ğ•Ğ©ĞĞ•ĞœĞĞ¡Ğ¢Ğ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Attendance(Base):
    __tablename__ = "attendance"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    date: Mapped[date] = mapped_column(Date, index=True)
    period_code: Mapped[str] = mapped_column(String(8), index=True)
    time: Mapped[Optional[dtime]] = mapped_column(Time, nullable=True)
    status: Mapped[Optional[str]] = mapped_column(String(16), nullable=True)
    reason: Mapped[Optional[str]] = mapped_column(String(64), nullable=True)

    student_id: Mapped[int] = mapped_column(Integer, ForeignKey("students.id"), index=True)
    student: Mapped["Student"] = relationship(back_populates="records")

    __table_args__ = (
        UniqueConstraint(
            "date",
            "period_code",
            "student_id",
            name="uq_attendance_date_period_student"
        ),
        Index("ix_attendance_student_date", "student_id", "date"),
        Index("ix_attendance_status", "status"),
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞĞ¢ĞœĞ•ĞĞ Ğ£Ğ§ĞĞ¢Ğ ĞĞ¢Ğ”Ğ•Ğ›Ğ¬ĞĞ«Ğ¥ ĞŸĞĞ  (ĞĞ• Ğ£Ğ§Ğ˜Ğ¢Ğ«Ğ’ĞĞ¢Ğ¬ ĞŸĞĞ Ğ£)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class PeriodSkip(Base):
    __tablename__ = "period_skips"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    date: Mapped[date] = mapped_column(Date, index=True, nullable=False)
    period_code: Mapped[str] = mapped_column(String(8), index=True, nullable=False)
    # Ğ’ĞĞ–ĞĞ: Ñ‚ĞµĞ¿ĞµÑ€ÑŒ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ, Ğ´Ğ»Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°
    group_code: Mapped[str] = mapped_column(String(32), index=True, nullable=False)

    __table_args__ = (
        # Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚: ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾ Ğ¢Ğ ĞĞœ Ğ¿Ğ¾Ğ»ÑĞ¼,
        # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ñƒ Ğ¸ Ñ‚Ñƒ Ğ¶Ğµ Ğ¿Ğ°Ñ€Ñƒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñƒ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿
        UniqueConstraint(
            "date",
            "period_code",
            "group_code",
            name="uq_period_skip_date_code_group",
        ),
        Index("ix_period_skip_group_date", "group_code", "date"),
    )

    def __repr__(self) -> str:
        return f"<PeriodSkip {self.date} {self.period_code} {self.group_code}>"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ’¬ Ğ–ĞĞ›ĞĞ‘Ğ« (Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ñ‹ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class Complaint(Base):
    __tablename__ = "complaints"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    created_at: Mapped[datetime] = mapped_column(
        DateTime, default=datetime.utcnow, nullable=False
    )

    # ĞšÑ‚Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ» (Ñ€Ğ¾Ğ»ÑŒ Ğ¸ Ğ¸Ğ¼Ñ)
    from_role: Mapped[str] = mapped_column(String(20), nullable=False)
    from_name: Mapped[str] = mapped_column(String(255), nullable=False)

    # ĞĞ° ĞºĞ¾Ğ³Ğ¾ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ğ° Ğ¸ Ğ½Ğ° ĞºĞ°ĞºÑƒÑ Ğ¿Ğ°Ñ€Ñƒ
    target_name: Mapped[str] = mapped_column(String(255), nullable=False)
    period_index: Mapped[int] = mapped_column(Integer, nullable=False)

    # ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñ‹
    reason: Mapped[str] = mapped_column(Text, nullable=False)

    # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¶Ğ°Ğ»Ğ¾Ğ±Ñ‹ (new/seen/resolved)
    status: Mapped[str] = mapped_column(String(32), default="new", nullable=False)

    def __repr__(self):
        return f"<Complaint id={self.id} on={self.target_name} pair={self.period_index}>"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ”’ Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹ (Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ½Ğ° Ğ¿Ğ°Ñ€Ñƒ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class StarostaLock(Base):
    __tablename__ = "starosta_locks"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    date: Mapped[date] = mapped_column(Date, index=True, nullable=False)
    period_code: Mapped[str] = mapped_column(String(8), index=True, nullable=False)
    group_code: Mapped[str] = mapped_column(String(32), index=True, nullable=False)
    submitted_by: Mapped[str] = mapped_column(String(255), nullable=False)  # Ğ¤Ğ˜Ğ ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ñ‹
    created_at: Mapped[datetime] = mapped_column(
        DateTime, default=datetime.utcnow, nullable=False
    )

    __table_args__ = (
        UniqueConstraint("date", "period_code", "group_code", name="uq_starosta_lock"),
        Index("ix_starosta_lock_group_date", "group_code", "date"),
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class User(Base):
    __tablename__ = "users"

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    username: Mapped[str] = mapped_column(
        String(64), unique=True, index=True, nullable=False
    )
    password_hash: Mapped[str] = mapped_column(String(255), nullable=False)
    role: Mapped[str] = mapped_column(
        String(32), index=True, nullable=False, default="curator"
    )
    fio: Mapped[str] = mapped_column(String(255), nullable=False, default="")

    __table_args__ = (
        UniqueConstraint("username", name="uq_users_username"),
        Index("ix_users_role", "role"),
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ğ˜ĞĞ˜Ğ¦Ğ˜ĞĞ›Ğ˜Ğ—ĞĞ¦Ğ˜Ğ¯/Ğ¡Ğ•Ğ¡Ğ¡Ğ˜Ğ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
engine = create_engine(DB_URL, echo=False, future=True)
SessionLocal = scoped_session(
    sessionmaker(bind=engine, autoflush=False, autocommit=False, future=True)
)


def init_db() -> None:
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ÑÑ…ĞµĞ¼Ñ‹ Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹.

    Ğ’ĞĞ–ĞĞ: Ğ¿ĞµÑ€ĞµĞ´ create_all Ğ¼Ñ‹ Ğ´Ñ€Ğ¾Ğ¿Ğ°ĞµĞ¼ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ period_skips,
    Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ğ»Ğ¾ÑÑŒ ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ (date, period_code, group_code).
    """
    if DB_URL.startswith("sqlite"):
        with engine.connect() as conn:
            conn.exec_driver_sql("PRAGMA foreign_keys=ON;")
            conn.commit()

    # ğŸ”„ Ğ¿ĞµÑ€ĞµÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´-ÑĞºĞ¸Ğ¿Ñ‹ (ÑÑ‚Ğ°Ñ€Ğ¾Ğµ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ³Ğ»Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ date+period_code)
    from sqlalchemy import inspect

    insp = inspect(engine)
    if "period_skips" in insp.get_table_names():
        PeriodSkip.__table__.drop(engine, checkfirst=True)

    # ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ²ÑĞµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ (ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚)
    Base.metadata.create_all(engine)

    # Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ Ğ´Ğ»Ñ attendance (ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾)
    if DB_URL.startswith("sqlite"):
        with engine.connect() as conn:
            conn.exec_driver_sql(
                "CREATE UNIQUE INDEX IF NOT EXISTS ux_attendance_date_period_student "
                "ON attendance(date, period_code, student_id);"
            )
            conn.exec_driver_sql(
                "CREATE INDEX IF NOT EXISTS ix_attendance_student_date "
                "ON attendance(student_id, date);"
            )
            conn.exec_driver_sql(
                "CREATE INDEX IF NOT EXISTS ix_attendance_status_dup "
                "ON attendance(status);"
            )
            conn.commit()
--- FILE: .\core\admin_bp.py ---
# core/routes_admin.py
import csv
from io import TextIOWrapper
from flask import Blueprint, render_template, request, redirect, url_for, flash
from models import SessionLocal, Student

admin_bp = Blueprint("admin_bp", __name__)

@admin_bp.route("/admin/students/upload", methods=["GET", "POST"])
def students_upload():
    """Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸Ğ· CSV: ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ uid,full_name (Ğ² Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞµ)."""
    if request.method == "GET":
        with SessionLocal() as s:
            count = s.query(Student).count()
        return render_template("students_upload.html", count=count)

    # POST: Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ„Ğ°Ğ¹Ğ»Ğ°
    file = request.files.get("file")
    if not file or file.filename == "":
        flash("Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½", "error")
        return redirect(url_for("admin_bp.students_upload"))

    # Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ°Ğº Ñ‚ĞµĞºÑÑ‚ UTF-8
    try:
        wrapper = TextIOWrapper(file.stream, encoding="utf-8")
        reader = csv.DictReader(wrapper)
    except Exception as e:
        flash(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ CSV: {e}", "error")
        return redirect(url_for("admin_bp.students_upload"))

    added, skipped = 0, 0
    with SessionLocal() as s:
        for row in reader:
            uid = (row.get("uid") or "").strip()
            full_name = (row.get("full_name") or "").strip()
            if not uid or not full_name:
                skipped += 1
                continue
            exists = s.query(Student).filter(Student.uid == uid).first()
            if exists:
                skipped += 1
                continue
            s.add(Student(uid=uid, full_name=full_name))
            added += 1
        s.commit()
    flash(f"Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½: Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ {added}, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾ {skipped}", "ok")
    return redirect(url_for("admin_bp.students_upload"))

@admin_bp.route("/admin/students/seed_demo", methods=["POST"])
def students_seed_demo():
    """Ğ Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°ÑĞµÌĞ²ĞºĞ° Ğ´ĞµĞ¼Ğ¾-ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² (ĞµÑĞ»Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ UI)."""
    demo = [
        ("1001", "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‡"),
        ("1002", "ĞŸĞµÑ‚Ñ€Ğ¾Ğ² ĞŸÑ‘Ñ‚Ñ€ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²Ğ¸Ñ‡"),
        ("1003", "Ğ¡Ğ¸Ğ´Ğ¾Ñ€Ğ¾Ğ²Ğ° ĞĞ½Ğ½Ğ° Ğ¡ĞµÑ€Ğ³ĞµĞµĞ²Ğ½Ğ°"),
        ("1004", "ĞšĞ¸Ğ¼ Ğ”Ğ°ÑƒÑ€ĞµĞ½ Ğ•Ñ€Ğ»Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‡"),
    ]
    with SessionLocal() as s:
        added = 0
        for uid, name in demo:
            if not s.query(Student).filter(Student.uid == uid).first():
                s.add(Student(uid=uid, full_name=name))
                added += 1
        s.commit()
    flash(f"Ğ”ĞµĞ¼Ğ¾-Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ: ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ {added} Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹", "ok")
    return redirect(url_for("admin_bp.students_upload"))

--- FILE: .\core\api_bp.py ---
from flask import Blueprint, jsonify, request, session
from models import SessionLocal, Student, Attendance
from datetime import datetime, date
from config import get_schedule_for, to_minutes, LATE_GRACE_MIN
from core.helpers import current_period_index
from core.permissions import student_in_curator_scope

api_bp = Blueprint("api_bp", __name__)

# ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ ÑĞºĞ°Ğ½ĞµÑ€Ğ° (/scanner, /scan) Ğ¸ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ QR (/qr/...) Ğ£Ğ”ĞĞ›Ğ•ĞĞ«.

@api_bp.route("/api/checkin", methods=["POST"])
def api_checkin():
    """
    API Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸.
    ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ JSON: {"uid": "...", "period_code": "..."}
    """
    data = request.get_json(silent=True) or {}
    uid = (data.get("uid") or "").strip()
    period_code = (data.get("period_code") or "").strip() or None

    today_d = date.today()
    now_t = datetime.now().time()
    schedule = get_schedule_for(today_d)

    with SessionLocal() as s:
        st = s.query(Student).filter_by(uid=uid).first()
        if not st:
            return jsonify({"ok": False, "error": "Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"}), 404

        # Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ·Ğ°Ğ»Ğ¾Ğ³Ğ¸Ğ½ĞµĞ½Ğ½Ñ‹Ğ¹ ĞšĞ£Ğ ĞĞ¢ĞĞ  â€” Ğ·Ğ°Ğ¿Ñ€ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°Ñ‚ÑŒ Â«Ñ‡ÑƒĞ¶Ğ¸Ñ…Â»
        user = session.get("user") or {}
        if user.get("role") == "curator":
            if not student_in_curator_scope(user.get("fio", ""), st.id):
                return jsonify({"ok": False, "error": "not_allowed"}), 403

        if not period_code:
            idx = current_period_index(schedule=schedule)
            if idx < 0:
                return jsonify({"ok": False, "error": "Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹."}), 400
            period_code = schedule[idx]["code"]

        rec = s.query(Attendance).filter_by(date=today_d, period_code=period_code, student_id=st.id).first()
        if not rec:
            rec = Attendance(date=today_d, period_code=period_code, time=now_t, student_id=st.id)
            s.add(rec)
        else:
            rec.time = now_t
        s.commit()

        p = next((pp for pp in schedule if pp["code"] == period_code), None)
        status = "present"
        if p:
            start_m, end_m = to_minutes(p["start"]), to_minutes(p["end"])
            t_m = now_t.hour*60 + now_t.minute
            if t_m <= start_m + LATE_GRACE_MIN: status = "present"
            elif t_m <= end_m: status = "late"
            else: status = "absent"

        return jsonify({
            "ok": True,
            "student": {"id": st.id, "uid": st.uid, "name": st.full_name},
            "period": period_code,
            "time": now_t.strftime("%H:%M"),
            "status": status
        }), 200
--- FILE: .\core\auth_bp.py ---
# core/auth_bp.py
from flask import Blueprint, render_template, request, redirect, url_for, session, flash
from functools import wraps
from werkzeug.security import check_password_hash
from models import SessionLocal, User, Student

auth_bp = Blueprint("auth_bp", __name__)

def require_role(*roles):
    """Ğ”ĞµĞºĞ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°."""
    def _wrap(view):
        @wraps(view)
        def _inner(*a, **kw):
            user = session.get("user")
            # Ğ•ÑĞ»Ğ¸ Ñ€Ğ¾Ğ»Ğ¸ Ğ½ĞµÑ‚ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ½Ñ‹Ñ…
            if not user or user.get("role") not in roles:
                flash("Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½ Ğ¸Ğ»Ğ¸ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ²Ñ…Ğ¾Ğ´.", "error")
                return redirect(url_for("auth_bp.login"))
            return view(*a, **kw)
        return _inner
    return _wrap

@auth_bp.route("/")
def root():
    return redirect(url_for("auth_bp.login"))

@auth_bp.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "POST":
        fio = (request.form.get("fio") or "").strip()
        password = (request.form.get("password") or "").strip()

        if not fio or not password:
            flash("Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¤Ğ˜Ğ Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ", "error")
            return render_template("login.html")

        session_db = SessionLocal()
        try:
            # 1. Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¸Ñ‰ĞµĞ¼ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ° (User)
            # ĞœÑ‹ Ğ¸Ñ‰ĞµĞ¼ Ğ¿Ğ¾ Ğ¿Ğ¾Ğ»Ñ fio, Ñ‚Ğ°Ğº ĞºĞ°Ğº Ğ² Ğ»Ğ¾Ğ³Ğ¸Ğ½ Ñ„Ğ¾Ñ€Ğ¼Ğµ Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ fio
            user = session_db.query(User).filter(User.fio == fio).first()
            
            if user and check_password_hash(user.password_hash, password):
                # Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ°
                home_url = "/journal" # default
                if user.role == "head": home_url = "/head"
                if user.role == "starosta": home_url = "/starosta"
                if user.role == "admin": home_url = "/admin/console"

                session["user"] = {"role": user.role, "fio": user.fio}
                session.permanent = True
                return redirect(home_url)

            # 2. Ğ•ÑĞ»Ğ¸ ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸Ğº Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ¸Ñ‰ĞµĞ¼ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° (Student)
            student = session_db.query(Student).filter(Student.full_name == fio).first()
            
            if student and student.password_hash and check_password_hash(student.password_hash, password):
                # Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ²Ñ…Ğ¾Ğ´ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°
                session["user"] = {"role": "student", "fio": student.full_name}
                session.permanent = True
                return redirect("/student")

            flash("ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğµ Ğ¤Ğ˜Ğ Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ", "error")
        
        finally:
            session_db.close()

    return render_template("login.html")

@auth_bp.route("/logout")
def logout():
    session.pop("user", None)
    return redirect(url_for("auth_bp.login"))
--- FILE: .\core\checkin_bp.py ---
# core/routes_checkin.py
from flask import Blueprint, render_template, request, redirect, url_for, flash, jsonify, session
from models import SessionLocal, Student, Attendance
from datetime import date, datetime
from core.helpers import current_period_index
from config import get_schedule_for, today_key
from core.auth_bp import require_role
from .permissions import get_curator_groups, student_in_curator_scope
from sqlalchemy import func

checkin_bp = Blueprint("checkin_bp", __name__)

# ---------- Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞĞ• ----------
VALID_STATUSES = ("present", "late", "absent", "excused")

def _upsert_attendance(s, *, d, student_id, period_code, status, reason, now_time):
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚/Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºÑƒ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ½Ğ° Ğ´Ğ°Ñ‚Ñƒ/Ğ¿Ğ°Ñ€Ñƒ/ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°."""
    rec = (
        s.query(Attendance)
        .filter(
            Attendance.date == d,
            Attendance.period_code == period_code,
            Attendance.student_id == student_id,
        )
        .first()
    )
    if not rec:
        rec = Attendance(
            date=d,
            period_code=period_code,
            time=now_time,
            student_id=student_id,
            status=status,
            reason=reason,
        )
        s.add(rec)
    else:
        rec.time = now_time
        rec.status = status
        rec.reason = reason

# ---------- Ğ¡Ğ¢Ğ ĞĞĞ˜Ğ¦Ğ ----------
@checkin_bp.route("/checkin")
@require_role("curator")
def checkin_page():
    d = date.today()
    schedule = get_schedule_for(d)

    # Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ¸ ĞµĞ³Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
    fio = (session.get("user") or {}).get("fio", "")
    curator_groups = [g.strip() for g in (get_curator_groups(fio) or []) if g and g.strip()]

    # Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ° ?g=PO-175 (Ğ¸Ğ»Ğ¸ Ğ¿ÑƒÑÑ‚Ğ¾ = Ğ²ÑĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°)
    selected_group = (request.args.get("g") or "").strip()

    with SessionLocal() as s:
        # Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ñ‹ Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        q = s.query(Student)
        if curator_groups:
            q = q.filter(func.trim(Student.group_code).in_(curator_groups))
        else:
            q = q.filter(Student.id == -1)  # ĞµÑĞ»Ğ¸ Ñƒ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ â€” Ğ¿ÑƒÑÑ‚Ğ¾

        # ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¿Ğ¾ Ñ„Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼
        groups_available = [
            g for (g,) in s.query(func.trim(Student.group_code))
                           .filter(func.trim(Student.group_code).in_(curator_groups))
                           .distinct()
                           .order_by(func.trim(Student.group_code))
        ]

        # ĞµÑĞ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° â€” Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑÑƒĞ·Ğ¸Ğ¼
        if selected_group:
            if selected_group in curator_groups:
                q = q.filter(func.trim(Student.group_code) == selected_group)
            else:
                q = q.filter(Student.id == -1)

        students = q.order_by(Student.full_name).all()

    cur_idx = current_period_index(schedule=schedule)

    return render_template(
        "checkin.html",
        students=students,
        schedule=schedule,
        current_index=cur_idx,
        today=today_key(),
        valid_statuses=VALID_STATUSES,
        excused_reasons=["sick", "competition", "family", "other"],
        # Ğ½Ğ¾Ğ²Ğ¾Ğµ:
        groups_available=groups_available,
        selected_group=selected_group,
    )

# ---------- ĞĞ”Ğ˜ĞĞĞ§ĞĞĞ¯ (Ğ½Ğ°ÑĞ»ĞµĞ´Ğ¸Ğµ: Ğ¾Ğ´Ğ½Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ) ----------
@checkin_bp.route("/checkin", methods=["POST"])
@require_role("curator")
def do_checkin():
    """Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼: Ğ¾Ğ´Ğ½Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ (Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ)."""
    try:
        student_id = int(request.form.get("student_id") or "0")
    except ValueError:
        student_id = 0
    period_code = (request.form.get("period_code") or "").strip()
    status = (request.form.get("status") or "").strip()
    reason = (request.form.get("reason") or "").strip() if status == "excused" else None

    if not student_id or not period_code or status not in VALID_STATUSES:
        flash("ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ²Ñ‹Ğ±Ğ¾Ñ€: ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚, Ğ¿Ğ°Ñ€Ğ°, ÑÑ‚Ğ°Ñ‚ÑƒÑ", "error")
        return redirect(url_for("checkin_bp.checkin_page"))

    # Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°Ñ‚ÑŒ Ñ‡ÑƒĞ¶Ğ¸Ñ… ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²
    user = session.get("user") or {}
    if user.get("role") == "curator" and not student_in_curator_scope(user.get("fio", ""), student_id):
        flash("ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°", "error")
        return redirect(url_for("checkin_bp.checkin_page"))

    today_d = date.today()
    now_t = datetime.now().time()
    with SessionLocal() as s:
        st = s.query(Student).filter(Student.id == student_id).first()
        if not st:
            flash("Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½", "error")
            return redirect(url_for("checkin_bp.checkin_page"))
        _upsert_attendance(
            s,
            d=today_d,
            student_id=student_id,
            period_code=period_code,
            status=status,
            reason=reason,
            now_time=now_t,
        )
        s.commit()
    flash("âœ… ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°", "ok")
    return redirect(url_for("checkin_bp.checkin_page"))

# ---------- ĞœĞĞ¡Ğ¡ĞĞ’Ğ: Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ã— Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ°Ñ€ ----------
@checkin_bp.route("/checkin/bulk", methods=["POST"])
@require_role("curator")
def do_checkin_bulk():
    today_d = date.today()
    now_t = datetime.now().time()

    # ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ñ‹
    all_students_flag = request.form.get("all_students") == "1"
    sel_student_ids = request.form.getlist("student_ids")
    # Ğ¿Ğ°Ñ€Ñ‹
    all_periods_flag = request.form.get("all_periods") == "1"
    sel_periods = request.form.getlist("period_codes")
    # ÑÑ‚Ğ°Ñ‚ÑƒÑ
    status = (request.form.get("status") or "").strip()
    reason = (request.form.get("reason") or "").strip() if status == "excused" else None
    # Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° (ÑĞºÑ€Ñ‹Ñ‚Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ Ğ¸Ğ· Ñ„Ğ¾Ñ€Ğ¼Ñ‹)
    selected_group = (request.form.get("g") or "").strip()

    if status not in VALID_STATUSES:
        flash("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ", "error")
        return redirect(url_for("checkin_bp.checkin_page", g=selected_group))

    user = session.get("user") or {}
    fio = user.get("fio", "")

    with SessionLocal() as s:
        if all_students_flag:
            # ĞµÑĞ»Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ â€” Ğ±ĞµÑ€Ñ‘Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑ‘
            if selected_group:
                q = s.query(Student).filter(func.trim(Student.group_code) == selected_group)
            else:
                curator_groups = [g.strip() for g in (get_curator_groups(fio) or []) if g and g.strip()]
                q = s.query(Student)
                if curator_groups:
                    q = q.filter(func.trim(Student.group_code).in_(curator_groups))
                else:
                    q = q.filter(Student.id == -1)
            students = q.order_by(Student.full_name).all()
            student_ids = [st.id for st in students]
        else:
            try:
                candidate_ids = [int(x) for x in sel_student_ids]
            except ValueError:
                candidate_ids = []
            # Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğµ, ĞºÑ‚Ğ¾ Ğ² Ğ·Ğ¾Ğ½Ğµ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
            student_ids = [sid for sid in candidate_ids if student_in_curator_scope(fio, sid)]

        if not student_ids:
            flash("ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ñ‹ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ñ‹", "error")
            return redirect(url_for("checkin_bp.checkin_page", g=selected_group))

        # Ğ¿Ğ°Ñ€Ñ‹
        schedule = get_schedule_for(today_d)
        if all_periods_flag:
            period_codes = [p["code"] for p in schedule if p["code"].startswith("p")]
        else:
            period_codes = [p for p in sel_periods if p.startswith("p")]
        if not period_codes:
            flash("ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ñ‹ Ğ¿Ğ°Ñ€Ñ‹", "error")
            return redirect(url_for("checkin_bp.checkin_page", g=selected_group))

        for sid in student_ids:
            for pc in period_codes:
                _upsert_attendance(
                    s,
                    d=today_d,
                    student_id=sid,
                    period_code=pc,
                    status=status,
                    reason=reason,
                    now_time=now_t,
                )
        s.commit()

    flash(f"âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸: {len(student_ids)} ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚(Ğ¾Ğ²) Ã— {len(period_codes)} Ğ¿Ğ°Ñ€(Ñ‹)", "ok")
    # ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ¿Ğ¾ÑĞ»Ğµ POST
    return redirect(url_for("checkin_bp.checkin_page", g=selected_group))

# ---------- Ğ‘Ğ«Ğ¡Ğ¢Ğ Ğ: ĞºĞ»Ğ¸Ğº Ğ¿Ğ¾ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ â†’ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½Ğ° Ğ¢Ğ•ĞšĞ£Ğ©Ğ£Ğ® Ğ¿Ğ°Ñ€Ñƒ (AJAX) ----------
@checkin_bp.route("/checkin/quick", methods=["POST"])
@require_role("curator")
def do_checkin_quick():
    """AJAX: Ğ²Ñ‹ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ñƒ Ğ½Ğ° Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ Ğ¿Ğ°Ñ€Ñƒ (Ğ¸Ğ· ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸)."""
    try:
        student_id = int(request.form.get("student_id") or "0")
    except ValueError:
        student_id = 0
    status = (request.form.get("status") or "").strip()
    reason = (request.form.get("reason") or "").strip() if status == "excused" else None

    if not student_id or status not in VALID_STATUSES:
        return jsonify({"ok": False, "error": "bad params"}), 400

    # Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°: ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµÑ‡Ğ°Ñ‚ÑŒ Ñ‡ÑƒĞ¶Ğ¸Ñ… ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²
    user = session.get("user") or {}
    if user.get("role") == "curator" and not student_in_curator_scope(user.get("fio", ""), student_id):
        return jsonify({"ok": False, "error": "not_allowed"}), 403

    today_d = date.today()
    now_t = datetime.now().time()
    schedule = get_schedule_for(today_d)
    idx = current_period_index(schedule=schedule)
    if idx is None or idx < 0:
        return jsonify({"ok": False, "error": "no current period"}), 400
    period_code = schedule[idx]["code"]

    with SessionLocal() as s:
        st = s.query(Student).filter(Student.id == student_id).first()
        if not st:
            return jsonify({"ok": False, "error": "student not found"}), 404
        _upsert_attendance(
            s,
            d=today_d,
            student_id=student_id,
            period_code=period_code,
            status=status,
            reason=reason,
            now_time=now_t,
        )
        s.commit()
    return jsonify({"ok": True, "period_code": period_code, "status": status})

--- FILE: .\core\complaints_bp.py ---
# core/routes_complaints.py
from flask import Blueprint, request, jsonify, render_template, session
from datetime import datetime
from queue import Queue
from threading import Lock
import json

from models import SessionLocal
from models import Complaint  # ÑĞ¼. ĞºĞ»Ğ°ÑÑ Ğ½Ğ¸Ğ¶Ğµ (Ğ¿.4)
from core.auth_bp import require_role

complaints_bp = Blueprint("complaints_bp", __name__)

# ---- Ğ¿Ñ€Ğ¾ÑÑ‚ĞµĞ¹ÑˆĞ¸Ğ¹ broadcaster Ğ´Ğ»Ñ SSE ----
_listeners = []
_lock = Lock()

def _subscribe():
    q = Queue()
    with _lock:
        _listeners.append(q)
    return q

def _publish(payload: dict):
    with _lock:
        lst = list(_listeners)
    for q in lst:
        q.put(payload)

@complaints_bp.route("/api/complaints", methods=["POST"])
@require_role("starosta")
def create_complaint():
    data = {
        "target_name": (request.form.get("target_name") or "").strip(),
        "period_index": int(request.form.get("period_index") or 0),
        "reason": (request.form.get("reason") or "").strip(),
        "from_name": session.get("user", {}).get("fio", "Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ°"),
        "from_role": "starosta",
        "created_at": datetime.utcnow(),
        "status": "new",
    }
    if not data["target_name"] or not (1 <= data["period_index"] <= 7) or not data["reason"]:
        return jsonify({"ok": False, "error": "Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ²ÑĞµ Ğ¿Ğ¾Ğ»Ñ"}), 400

    with SessionLocal() as s:
        c = Complaint(
            target_name=data["target_name"],
            period_index=data["period_index"],
            reason=data["reason"],
            from_role=data["from_role"],
            from_name=data["from_name"],
            created_at=data["created_at"],
            status=data["status"],
        )
        s.add(c)
        s.commit()
        s.refresh(c)

        payload = {
            "id": c.id,
            "target_name": c.target_name,
            "period_index": c.period_index,
            "reason": c.reason,
            "from_role": c.from_role,
            "from_name": c.from_name,
            "created_at": c.created_at.isoformat() + "Z",
            "status": c.status,
        }
        _publish(payload)

    return jsonify({"ok": True, "id": c.id})

@complaints_bp.route("/complaints")
@require_role("curator")
def complaints_page():
    with SessionLocal() as s:
        items = s.query(Complaint).order_by(Complaint.created_at.desc()).all()
    return render_template("complaints.html", items=items)

@complaints_bp.route("/complaints/stream")
@require_role("curator")
def complaints_stream():
    def event_stream():
        q = _subscribe()
        try:
            # Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ¼ Â«Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ¸Ğ½Ğ³Â», Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ€Ğ°Ğ·Ñƒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ
            yield "event: ping\ndata: {}\n\n"
            while True:
                payload = q.get()
                yield f"data: {json.dumps(payload, ensure_ascii=False)}\n\n"
        finally:
            with _lock:
                try:
                    _listeners.remove(q)
                except ValueError:
                    pass

    return complaints_bp.response_class(event_stream(), mimetype="text/event-stream")

--- FILE: .\core\curator_bp.py ---
# core/curator_bp.py
from datetime import date
from flask import Blueprint, render_template, request, redirect, url_for, session, flash

from core.auth_bp import require_role
from core.permissions import get_curator_groups
from core.head_bp import (
    _parse_day,
    _month_range,
    _semester_range,
    _load_students,
    _load_day_attendance,
    _load_skips_for_day,
    _attendance_stats,
    _detailed_student_table,
)

curator_bp = Blueprint("curator_bp", __name__, url_prefix="/curator")


@curator_bp.route("/")
@require_role("curator")
def choose_group():
    """Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ´Ğ»Ñ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°."""
    user = session.get("user") or {}
    fio = user.get("fio", "")

    groups = get_curator_groups(fio)

    if not groups:
        flash(
            "Ğ”Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.",
            "error",
        )
        return render_template(
            "curator_groups.html",
            groups=[],
            title="ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ â€” Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹",
        )

    return render_template(
        "curator_groups.html",
        groups=groups,
        title="ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ â€” Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹",
    )


@curator_bp.route("/group")
@require_role("curator")
def group_view():
    """
    Ğ¡Ñ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ¿Ğ¾ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ.

    ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚:
    - Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ Ğ¸ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ (Ğ´ĞµĞ½ÑŒ / Ğ¼ĞµÑÑÑ† / ÑĞµĞ¼ĞµÑÑ‚Ñ€),
    - Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ "ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼" (ĞºĞ°Ğº Ñƒ Ğ·Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰ĞµĞ¹).
    """
    user = session.get("user") or {}
    fio = user.get("fio", "")

    g = (request.args.get("g") or "").strip()
    if not g:
        return redirect(url_for("curator_bp.choose_group"))

    # Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ğ·Ğ¾Ğ½Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
    groups = get_curator_groups(fio)
    if g not in groups:
        flash("Ğ­Ñ‚Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ½Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ğ²Ğ°ÑˆÑƒ Ğ·Ğ¾Ğ½Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸.", "error")
        return redirect(url_for("curator_bp.choose_group"))

    # Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
    day = _parse_day(request.args.get("day"))
    mode = (request.args.get("mode") or "day")  # day|month|semester

    if mode == "month":
        start, end = _month_range(day)
    elif mode == "semester":
        start, end = _semester_range(day)
    else:
        start = end = day

    students = _load_students(g)
    day_map = _load_day_attendance(g, day) if mode == "day" else {}
    skips = _load_skips_for_day(g, day)
    stats = _attendance_stats(g, start, end)
    detail = _detailed_student_table(g, start, end)

    return render_template(
        "curator_group.html",
        group=g,
        day=day,
        mode=mode,
        students=students,
        day_map=day_map,   # Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ğ´Ğ¸Ñ‚ÑÑ, ĞµÑĞ»Ğ¸ Ğ·Ğ°Ñ…Ğ¾Ñ‚Ğ¸Ğ¼ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸-Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»
        skips=skips,
        stats=stats,
        detail=detail,     # Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ‡ĞºĞ° Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼
        start=start,
        end=end,
        today=date.today(),
    )

--- FILE: .\core\db_init.py ---
# core/db_init.py
from models import init_db, SessionLocal

def init_database():
    """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½ĞµĞ´Ğ¾ÑÑ‚Ğ°ÑÑ‰Ğ¸Ğµ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ Ğ² attendance."""
    init_db()
    with SessionLocal() as s:
        conn = s.bind.raw_connection()
        cur = conn.cursor()
        cur.execute("PRAGMA table_info(attendance)")
        cols = {row[1] for row in cur.fetchall()}
        alters = []
        if "status" not in cols:
            alters.append("ALTER TABLE attendance ADD COLUMN status TEXT")
        if "reason" not in cols:
            alters.append("ALTER TABLE attendance ADD COLUMN reason TEXT")
        for q in alters:
            cur.execute(q)
        if alters:
            conn.commit()
        cur.close()
        conn.close()

--- FILE: .\core\head_bp.py ---
from datetime import date, datetime, timedelta
from io import BytesIO

from flask import (
    Blueprint,
    render_template,
    request,
    redirect,
    url_for,
    session,
    flash,
    send_file,
)
from core.auth_bp import require_role
from core.permissions import (
    get_head_allowed_prefixes,
    head_list_groups_for_prefixes,
    head_group_allowed,
)
from models import SessionLocal, Student, Attendance, PeriodSkip
from sqlalchemy import func, and_

head_bp = Blueprint("head_bp", __name__, url_prefix="/head")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


def _today():
    return date.today()


def _parse_day(s: str | None) -> date:
    if not s:
        return _today()
    try:
        return datetime.strptime(s, "%Y-%m-%d").date()
    except Exception:
        return _today()


def _month_range(d: date):
    start = d.replace(day=1)
    if start.month == 12:
        end = start.replace(year=start.year + 1, month=1, day=1) - timedelta(days=1)
    else:
        end = start.replace(month=start.month + 1, day=1) - timedelta(days=1)
    return start, end


# ĞŸÑ€Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ğ²: ÑĞµĞ¼ĞµÑÑ‚Ñ€ â€” 01.09..31.12 Ğ¸ 01.01..31.05 (Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ Ğ¿Ğ¾Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ¿Ğ¾Ğ´ ÑĞ²Ğ¾Ğ¹ ĞºĞ¾Ğ»Ğ»ĞµĞ´Ğ¶)
def _semester_range(d: date):
    if d.month >= 9:  # Ğ¾ÑĞµĞ½Ğ½Ğ¸Ğ¹
        start = date(d.year, 9, 1)
        end = date(d.year, 12, 31)
    else:  # Ğ²ĞµÑĞµĞ½Ğ½Ğ¸Ğ¹
        start = date(d.year, 1, 1)
        end = date(d.year, 5, 31)
    return start, end


def _attendance_stats(group_code: str, start: date, end: date):
    """ĞĞ³Ñ€ĞµĞ³Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°Ğ¼ Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»Ğµ [start..end].

    Ğ’ĞĞ–ĞĞ: ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ‚Ğµ Ğ¿Ğ°Ñ€Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¸ Ğ² Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğ¸
    (ĞµÑĞ»Ğ¸ Ğ½Ğ° Ğ´ĞµĞ½ÑŒ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ĞµÑÑ‚ÑŒ PeriodSkip Ğ¿Ğ¾ Ğ¿Ğ°Ñ€Ğµ, ÑÑ‚Ğ° Ğ¿Ğ°Ñ€Ğ° Ğ¸Ğ· ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸
    Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ, Ğ´Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ Ğ¿Ğ¾ Ğ½ĞµĞ¹ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ).
    """
    with SessionLocal() as s:
        q = (
            s.query(
                Attendance.status,
                func.count(Attendance.id),
            )
            .join(Student, Student.id == Attendance.student_id)
            .outerjoin(
                PeriodSkip,
                and_(
                    func.date(PeriodSkip.date) == func.date(Attendance.date),
                    PeriodSkip.period_code == Attendance.period_code,
                    func.trim(PeriodSkip.group_code) == func.trim(Student.group_code),
                ),
            )
            .filter(
                func.date(Attendance.date) >= start,
                func.date(Attendance.date) <= end,
                func.trim(Student.group_code) == group_code,
                Attendance.status.in_(["present", "late", "absent", "excused"]),
                PeriodSkip.id.is_(None),  # Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ°Ñ€Ñ‹
            )
            .group_by(Attendance.status)
        )

        counts = {"present": 0, "late": 0, "absent": 0, "excused": 0}
        total = 0
        for st, cnt in q.all():
            if st in counts:
                counts[st] += cnt
                total += cnt

        pct = {}
        for k, v in counts.items():
            pct[k] = (v * 100.0 / total) if total else 0.0

        return {"counts": counts, "total": total, "pct": pct}


def _detailed_student_table(group_code: str, start: date, end: date):
    """Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼ Ğ² ÑÑ‚Ğ¸Ğ»Ğµ Excel-Ğ¿Ñ€Ğ¾Ñ‚Ğ¾Ñ‚Ğ¸Ğ¿Ğ° (Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ start..end).

    Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼:
    - Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¾Ğ² Ğ² Ğ°ĞºĞ°Ğ´ĞµĞ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ‡Ğ°ÑĞ°Ñ… (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ 2 Ñ‡Ğ°ÑĞ° Ğ·Ğ° Ğ¿Ğ°Ñ€Ñƒ),
    - Ñ€Ğ°Ğ·Ğ±Ğ¸Ğ²ĞºÑƒ Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°Ğ¼ (Ğ·Ğ°ÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ / Ğ¿Ğ¾ Ğ±Ğ¾Ğ»ĞµĞ·Ğ½Ğ¸ / ÑĞ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ / Ğ´Ñ€ÑƒĞ³Ğ¾Ğµ / Ğ½ĞµÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ),
    - Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ñƒ Ğ¸ ÑÑ€ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ.
    """
    HOURS_PER_LESSON = 2  # ĞµÑĞ»Ğ¸ Ğ² ĞºĞ¾Ğ»Ğ»ĞµĞ´Ğ¶Ğµ Ğ´Ñ€ÑƒĞ³Ğ°Ñ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ°Ñ€Ñ‹ â€” Ğ¿Ğ¾Ğ¼ĞµĞ½ÑĞ¹ ÑÑ‚Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ

    with SessionLocal() as s:
        students = (
            s.query(Student)
            .filter(func.trim(Student.group_code) == group_code)
            .order_by(Student.full_name)
            .all()
        )

        if not students:
            return {"rows": [], "group_pct": 0.0}

        # Ğ‘ĞµÑ€Ñ‘Ğ¼ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´, ĞĞ ÑÑ€Ğ°Ğ·Ñƒ Ğ¸ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ°Ñ€Ñ‹, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ±Ñ‹Ğ»Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹
        records = (
            s.query(Attendance)
            .join(Student, Student.id == Attendance.student_id)
            .outerjoin(
                PeriodSkip,
                and_(
                    func.date(PeriodSkip.date) == func.date(Attendance.date),
                    PeriodSkip.period_code == Attendance.period_code,
                    func.trim(PeriodSkip.group_code) == func.trim(Student.group_code),
                ),
            )
            .filter(
                func.trim(Student.group_code) == group_code,
                func.date(Attendance.date) >= start,
                func.date(Attendance.date) <= end,
                Attendance.status.in_(["present", "absent", "late", "excused"]),
                PeriodSkip.id.is_(None),  # ĞµÑĞ»Ğ¸ Ğ¿Ğ¾ Ğ¿Ğ°Ñ€Ğµ ÑÑ‚Ğ¾Ğ¸Ñ‚ "Ñ‚Ğ°ĞºĞ¸Ñ… Ğ¿Ğ°Ñ€ Ğ½ĞµÑ‚Ñƒ" â€” Ğ½Ğµ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ ĞµÑ‘
            )
            .all()
        )

    # Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ñƒ
    by_student: dict[int, list[Attendance]] = {}
    for r in records:
        by_student.setdefault(r.student_id, []).append(r)

    rows: list[dict] = []

    for idx, st in enumerate(students, start=1):
        recs = by_student.get(st.id, [])

        total_lessons = len(recs)
        missed_lessons = 0

        by_statement = 0
        by_sick = 0
        by_competition = 0
        by_other = 0
        by_unexcused = 0

        for r in recs:
            status = (r.status or "").strip().lower()
            reason = (r.reason or "").strip().lower()

            # ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¸ (Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ» Ğ¸Ğ»Ğ¸ ÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ)
            if status not in ("absent", "excused"):
                continue

            missed_lessons += 1

            # Ğ“Ñ€ÑƒĞ±Ğ°Ñ ÑĞ²Ñ€Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°Ğ¼ â€” Ğ¿Ğ¾Ğ´ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ
            if "Ğ·Ğ°ÑĞ²" in reason or reason in ("application",):
                by_statement += 1
            elif "Ğ±Ğ¾Ğ»" in reason or reason in ("sick",):
                by_sick += 1
            elif "ÑĞ¾Ñ€ĞµĞ²Ğ½" in reason or reason in ("competition", "contest"):
                by_competition += 1
            elif status == "absent" and not reason:
                # Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ±ĞµĞ· Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ â†’ Ğ½ĞµÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ
                by_unexcused += 1
            elif status == "absent" and reason:
                # Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ñ Ğ½ĞµĞ¿Ğ¾Ğ½ÑÑ‚Ğ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ¾Ğ¹ â†’ Ñ‚Ğ¾Ğ¶Ğµ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ°Ğº Ğ½ĞµÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ,
                # ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ»Ğ¸ Ğ² ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¸ Ğ²Ñ‹ÑˆĞµ
                by_unexcused += 1
            else:
                # Ğ²ÑĞµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ
                by_other += 1

        # Ğ¿ĞµÑ€ĞµĞ²ĞµĞ´Ñ‘Ğ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ¿Ğ°Ñ€ Ğ² Ğ°ĞºĞ°Ğ´ĞµĞ¼Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ñ‡Ğ°ÑÑ‹
        total_hours = missed_lessons * HOURS_PER_LESSON

        row = {
            "num": idx,
            "full_name": st.full_name,
            "total": total_hours,
            "statement": by_statement * HOURS_PER_LESSON,
            "sick": by_sick * HOURS_PER_LESSON,
            "competition": by_competition * HOURS_PER_LESSON,
            "other": by_other * HOURS_PER_LESSON,
            "unexcused": by_unexcused * HOURS_PER_LESSON,
        }

        if total_lessons:
            attended = total_lessons - missed_lessons
            row["pct"] = attended * 100.0 / total_lessons
        else:
            # ĞµÑĞ»Ğ¸ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ñƒ Ğ½ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¾Ğº â€” ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ 100% Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ
            row["pct"] = 100.0

        rows.append(row)

    group_pct = sum(r["pct"] for r in rows) / len(rows) if rows else 0.0

    return {
        "rows": rows,
        "group_pct": group_pct,
    }


def _load_students(group_code: str):
    with SessionLocal() as s:
        return (
            s.query(Student)
            .filter(func.trim(Student.group_code) == group_code)
            .order_by(Student.full_name)
            .all()
        )


def _load_day_attendance(group_code: str, d: date):
    """Ğ—Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ d (Ğ´Ğ»Ñ Ğ¼Ğ¸Ğ½Ğ¸-Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ°)."""
    with SessionLocal() as s:
        rows = (
            s.query(Attendance)
            .join(Student, Student.id == Attendance.student_id)
            .filter(
                func.trim(Student.group_code) == group_code,
                func.date(Attendance.date) == d,
            )
            .all()
        )
        # Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼: (student_id -> list of records)
        by_st = {}
        for r in rows:
            by_st.setdefault(r.student_id, []).append(r)
        return by_st


def _load_skips_for_day(group_code: str, d: date):
    with SessionLocal() as s:
        return (
            s.query(PeriodSkip)
            .filter(
                func.date(PeriodSkip.date) == d,
                func.trim(PeriodSkip.group_code) == group_code,
            )
            .all()
        )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ routes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


@head_bp.route("/")
@require_role("head")
def choose_group():
    user = session.get("user") or {}
    fio = user.get("fio", "")
    prefixes = get_head_allowed_prefixes(fio)

    if not prefixes:
        flash(
            "Ğ”Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑÑ‹ Ğ³Ñ€ÑƒĞ¿Ğ¿. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.",
            "error",
        )
        return render_template(
            "head_groups.html",
            groups=[],
            title="Ğ—Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰Ğ°Ñ â€” Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹",
        )

    groups = head_list_groups_for_prefixes(prefixes)
    return render_template(
        "head_groups.html",
        groups=groups,
        title="Ğ—Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰Ğ°Ñ â€” Ğ²Ñ‹Ğ±Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹",
    )


@head_bp.route("/group")
@require_role("head")
def group_view():
    user = session.get("user") or {}
    fio = user.get("fio", "")
    g = (request.args.get("g") or "").strip()
    if not g:
        return redirect(url_for("head_bp.choose_group"))

    if not head_group_allowed(fio, g):
        flash("Ğ­Ñ‚Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ½Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ğ²Ğ°ÑˆÑƒ Ğ·Ğ¾Ğ½Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸.", "error")
        return redirect(url_for("head_bp.choose_group"))

    # Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹
    day = _parse_day(request.args.get("day"))
    mode = (request.args.get("mode") or "day")  # day|month|semester

    if mode == "month":
        start, end = _month_range(day)
    elif mode == "semester":
        start, end = _semester_range(day)
    else:
        start = end = day

    students = _load_students(g)
    day_map = _load_day_attendance(g, day) if mode == "day" else {}
    skips = _load_skips_for_day(g, day)
    stats = _attendance_stats(g, start, end)
    detail = _detailed_student_table(g, start, end)

    return render_template(
        "head_group.html",
        group=g,
        day=day,
        mode=mode,
        students=students,
        day_map=day_map,  # {student_id: [Attendance,...]}
        skips=skips,  # PeriodSkip Ğ·Ğ° Ğ´ĞµĞ½ÑŒ
        stats=stats,  # Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ‚Ñ‹ Ğ½Ğ° Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´
        detail=detail,  # Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ‡ĞºĞ° Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼
        start=start,
        end=end,
        today=_today(),
    )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ° Excel Â«Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


@head_bp.route("/group/export_excel")
@require_role("head")
def group_export_excel():
    """
    Ğ’Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ° Excel Ğ´Ğ»Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ‡ĞºĞ¸ Â«Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼Â»
    Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ, Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾Ñ…Ğ¾Ğ¶ĞµĞ¼ Ğ½Ğ° Ñ‚Ğ²Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ»
    Â«ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ ĞŸĞ-175 ÑĞµĞ½Ñ‚ÑĞ±Ñ€ÑŒ.xlsxÂ».

    ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹:
        g    â€” Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°
        day  â€” Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ğ´Ğ°Ñ‚Ğ° (ĞºĞ°Ğº Ğ² group_view)
        mode â€” day / month / semester  (Ğ·Ğ° ĞºĞ°ĞºĞ¾Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚)
    """
    user = session.get("user") or {}
    fio = user.get("fio", "")
    g = (request.args.get("g") or "").strip()
    if not g:
        return redirect(url_for("head_bp.choose_group"))

    if not head_group_allowed(fio, g):
        flash("Ğ­Ñ‚Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ½Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² Ğ²Ğ°ÑˆÑƒ Ğ·Ğ¾Ğ½Ñƒ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸.", "error")
        return redirect(url_for("head_bp.choose_group"))

    day = _parse_day(request.args.get("day"))
    mode = (request.args.get("mode") or "day")

    if mode == "month":
        start, end = _month_range(day)
        period_title = f"Ğ·Ğ° Ğ¼ĞµÑÑÑ† ({start:%d.%m.%Y}â€“{end:%d.%m.%Y})"
    elif mode == "semester":
        start, end = _semester_range(day)
        period_title = f"Ğ·Ğ° ÑĞµĞ¼ĞµÑÑ‚Ñ€ ({start:%d.%m.%Y}â€“{end:%d.%m.%Y})"
    else:
        start = end = day
        period_title = f"Ğ·Ğ° {day:%d.%m.%Y}"

    detail = _detailed_student_table(g, start, end)
    rows = detail["rows"]
    group_pct = detail["group_pct"]

    # â”€ Excel â”€
    from openpyxl import Workbook
    from openpyxl.styles import Alignment, Font, Border, Side

    wb = Workbook()
    ws = wb.active
    ws.title = "ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ"

    bold = Font(bold=True)
    thin = Side(style="thin")
    border_all = Border(left=thin, right=thin, top=thin, bottom=thin)
    center = Alignment(horizontal="center", vertical="center", wrap_text=True)
    left = Alignment(horizontal="left", vertical="center", wrap_text=True)

    # Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº
    title = f"ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ {g} {period_title}"
    ws.merge_cells("A2:I2")
    cell = ws["A2"]
    cell.value = title
    cell.font = Font(bold=True, size=14)
    cell.alignment = center

    # Ğ¨Ğ°Ğ¿ĞºĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ (ĞºĞ°Ğº Ğ² Ñ‚Ğ²Ğ¾Ñ‘Ğ¼ Excel)
    ws["A5"].value = "â„–"
    ws["B5"].value = "ĞÑ‚Ñ‹ Ğ¶Ó©Ğ½Ñ–"
    ws["C5"].value = "Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¾Ğ²(ĞºĞ¾Ğ»-Ğ²Ğ¾ Ñ‡Ğ°ÑĞ¾Ğ²)"
    ws["D5"].value = "Ğ’ Ñ‚Ğ¾Ğ¼ Ñ‡Ğ¸ÑĞ»Ğµ"
    ws["I5"].value = "ĞŸÑ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸"

    ws["D6"].value = "Ğ—Ğ°ÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ"
    ws["E6"].value = "ĞŸĞ¾ Ğ±Ğ¾Ğ»ĞµĞ·Ğ½Ğ¸"
    ws["F6"].value = "Ğ¡Ğ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"
    ws["G6"].value = "Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ"
    ws["H6"].value = "ĞŸĞ¾ Ğ½ĞµÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğµ"

    # ÑĞ»Ğ¸ÑĞ½Ğ¸Ñ
    ws.merge_cells("A5:A6")
    ws.merge_cells("B5:B6")
    ws.merge_cells("C5:C6")
    ws.merge_cells("D5:H5")
    ws.merge_cells("I5:I6")

    # ÑÑ‚Ğ¸Ğ»Ğ¸ ÑˆĞ°Ğ¿ĞºĞ¸
    for row in (5, 6):
        for col in range(1, 10):
            cell = ws.cell(row=row, column=col)
            cell.font = bold
            cell.alignment = center
            cell.border = border_all

    # ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ° ĞºĞ¾Ğ»Ğ¾Ğ½Ğ¾Ğº
    ws.column_dimensions["A"].width = 4
    ws.column_dimensions["B"].width = 30
    ws.column_dimensions["C"].width = 18
    ws.column_dimensions["D"].width = 12
    ws.column_dimensions["E"].width = 12
    ws.column_dimensions["F"].width = 14
    ws.column_dimensions["G"].width = 12
    ws.column_dimensions["H"].width = 22
    ws.column_dimensions["I"].width = 18

    # Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼
    row_idx = 7
    for r in rows:
        ws.cell(row=row_idx, column=1, value=r["num"]).alignment = center
        ws.cell(row=row_idx, column=2, value=r["full_name"]).alignment = left

        ws.cell(row=row_idx, column=3, value=r["total"]).alignment = center
        ws.cell(row=row_idx, column=4, value=r["statement"]).alignment = center
        ws.cell(row=row_idx, column=5, value=r["sick"]).alignment = center
        ws.cell(row=row_idx, column=6, value=r["competition"]).alignment = center
        ws.cell(row=row_idx, column=7, value=r["other"]).alignment = center
        ws.cell(row=row_idx, column=8, value=r["unexcused"]).alignment = center
        ws.cell(row=row_idx, column=9, value=round(r["pct"], 2)).alignment = center

        for col in range(1, 10):
            ws.cell(row=row_idx, column=col).border = border_all

        row_idx += 1

    # Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° "ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ"
    ws.merge_cells(start_row=row_idx, start_column=1, end_row=row_idx, end_column=8)
    ws.cell(row=row_idx, column=1, value="ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ Ğ¿Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ").alignment = left
    ws.cell(row=row_idx, column=1).font = bold
    ws.cell(row=row_idx, column=9, value=round(group_pct, 2)).alignment = center
    ws.cell(row=row_idx, column=9).font = bold

    for col in range(1, 10):
        ws.cell(row=row_idx, column=col).border = border_all

    # Ñ„Ğ°Ğ¹Ğ» Ğ² Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ
    output = BytesIO()
    wb.save(output)
    output.seek(0)

    filename = f"ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ {g} {start:%Y-%m-%d}_{end:%Y-%m-%d}.xlsx"
    return send_file(
        output,
        as_attachment=True,
        download_name=filename,
        mimetype="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    )

--- FILE: .\core\helpers.py ---
# core/helpers.py
from datetime import datetime, date
from typing import Optional, Dict, Any, List
from config import get_schedule_for, LATE_GRACE_MIN, to_minutes, now_minutes

STATUS_LABELS = {
    "present": "ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
    "late": "ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»",
    "absent": "ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
    "excused": "Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°",
    "skip": "ĞĞµ ÑƒÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ",
    "": "â€”",
}

REASON_LABELS = {
    "sick": "Ğ‘Ğ¾Ğ»ĞµĞ·Ğ½ÑŒ",
    "competition": "Ğ¡Ğ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ",
    "family": "Ğ¡ĞµĞ¼ĞµĞ¹Ğ½Ñ‹Ğµ Ğ¾Ğ±ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ°",
    "other": "Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ",
    None: "",
}

def parse_date_param(s: Optional[str]) -> date:
    if not s:
        return date.today()
    try:
        return datetime.strptime(s, "%Y-%m-%d").date()
    except Exception:
        return date.today()

def current_period_index(now_mins: Optional[int] = None, schedule: Optional[List[Dict[str, Any]]] = None) -> int:
    nm = now_mins if now_mins is not None else now_minutes()
    schedule = schedule or get_schedule_for()
    for i, p in enumerate(schedule):
        if to_minutes(p["start"]) <= nm <= to_minutes(p["end"]):
            return i
    return -1

def compute_status(mark_hhmm: Optional[str], period: Dict[str, Any], now_m: Optional[int] = None) -> str:
    """ĞĞ½Ğ»Ğ°Ğ¹Ğ½-ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ, ĞµÑĞ»Ğ¸ Ğ² Ğ‘Ğ” Ğ½ĞµÑ‚ status."""
    nowm = now_m if now_m is not None else now_minutes()
    start = to_minutes(period["start"])
    end = to_minutes(period["end"])
    late_border = start + LATE_GRACE_MIN
    if not mark_hhmm:
        if nowm < start: return ""
        if nowm <= end: return ""
        return "absent"
    m = to_minutes(mark_hhmm)
    if m <= start: return "present"
    if start < m <= end:
        return "late" if m > late_border else "present"
    return "late"

def compute_status_by_mark(mark_hhmm: Optional[str], period: Dict[str, Any]) -> str:
    """ĞÑ„Ñ„Ğ»Ğ°Ğ¹Ğ½-ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞ¸Ñ… Ğ´Ğ°Ñ‚, ĞµÑĞ»Ğ¸ Ğ² Ğ‘Ğ” Ğ½ĞµÑ‚ status."""
    if not mark_hhmm:
        return "absent"
    start = to_minutes(period["start"])
    end   = to_minutes(period["end"])
    m     = to_minutes(mark_hhmm)
    if m <= start: return "present"
    if start < m <= end:
        return "late" if m > start + LATE_GRACE_MIN else "present"
    return "late"

--- FILE: .\core\i18n.py ---
from flask import session

# Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ñ… ÑĞ·Ñ‹ĞºĞ¾Ğ²
LANGUAGES = ["ru", "kz", "en"]

# Ğ¡Ğ»Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ¾Ğ²
TRANSLATIONS = {
    "ru": {
        "site_title": "LDO ĞŸĞ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚ÑŒ",
        "nav_home": "Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ",
        "nav_checkin": "ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸",
        "nav_journal": "Ğ–ÑƒÑ€Ğ½Ğ°Ğ»",
        "nav_head": "Ğ—Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰Ğ°Ñ",
        "nav_starosta": "Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ°",
        "nav_student": "Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚",
        "nav_admin": "ĞĞ´Ğ¼Ğ¸Ğ½",
        "nav_logout": "Ğ’Ñ‹Ñ…Ğ¾Ğ´",

        "login_title": "Ğ’Ñ…Ğ¾Ğ´ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ",
        "login_username": "Ğ›Ğ¾Ğ³Ğ¸Ğ½",
        "login_password": "ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ",
        "login_button": "Ğ’Ğ¾Ğ¹Ñ‚Ğ¸",

        "group": "Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°",
        "statistics": "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°",
        "attendance_table": "Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼",
        "daily_journal": "Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ·Ğ° Ğ´ĞµĞ½ÑŒ",

        "present": "ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
        "late": "ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»",
        "absent": "ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
        "excused": "Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ",
    },
    "kz": {
        "site_title": "LDO ÒšĞ°Ñ‚Ñ‹ÑÑƒ Ğ¶Ò¯Ğ¹ĞµÑÑ–",
        "nav_home": "Ğ‘Ğ°ÑÑ‚Ñ‹ Ğ±ĞµÑ‚",
        "nav_checkin": "ÒšĞ°Ñ‚Ñ‹ÑÑƒĞ´Ñ‹ Ğ±ĞµĞ»Ğ³Ñ–Ğ»ĞµÑƒ",
        "nav_journal": "Ğ–ÑƒÑ€Ğ½Ğ°Ğ»",
        "nav_head": "Ğ‘Ó©Ğ»Ñ–Ğ¼ Ğ¼ĞµÒ£Ğ³ĞµÑ€ÑƒÑˆÑ–ÑÑ–",
        "nav_starosta": "Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ°",
        "nav_student": "Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚",
        "nav_admin": "ĞĞ´Ğ¼Ğ¸Ğ½",
        "nav_logout": "Ğ¨Ñ‹Ò“Ñƒ",

        "login_title": "Ğ–Ò¯Ğ¹ĞµĞ³Ğµ ĞºÑ–Ñ€Ñƒ",
        "login_username": "Ğ›Ğ¾Ğ³Ğ¸Ğ½",
        "login_password": "ÒšÒ±Ğ¿Ğ¸Ñ ÑÓ©Ğ·",
        "login_button": "ĞšÑ–Ñ€Ñƒ",

        "group": "Ğ¢Ğ¾Ğ¿",
        "statistics": "Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°",
        "attendance_table": "Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚Ñ‚ĞµÑ€Ğ´Ñ–Ò£ Ò›Ğ°Ñ‚Ñ‹ÑÑƒ ĞºĞµÑÑ‚ĞµÑÑ–",
        "daily_journal": "ĞšÒ¯Ğ½Ğ´Ñ–Ğº Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»",

        "present": "ÒšĞ°Ñ‚Ñ‹ÑÑ‚Ñ‹",
        "late": "ĞšĞµÑˆÑ–ĞºÑ‚Ñ–",
        "absent": "ÒšĞ°Ñ‚Ñ‹ÑĞ¿Ğ°Ğ´Ñ‹",
        "excused": "Ğ¡ĞµĞ±ĞµĞ¿Ñ‚Ñ–",
    },
    "en": {
        "site_title": "LDO Attendance",
        "nav_home": "Home",
        "nav_checkin": "Check-in",
        "nav_journal": "Journal",
        "nav_head": "Head",
        "nav_starosta": "Starosta",
        "nav_student": "Student",
        "nav_admin": "Admin",
        "nav_logout": "Logout",

        "login_title": "Sign in",
        "login_username": "Username",
        "login_password": "Password",
        "login_button": "Sign in",

        "group": "Group",
        "statistics": "Statistics",
        "attendance_table": "Attendance table",
        "daily_journal": "Daily journal",

        "present": "Present",
        "late": "Late",
        "absent": "Absent",
        "excused": "Excused",
    },
}


def get_lang() -> str:
    """Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğ¹ ÑĞ·Ñ‹Ğº Ğ¸Ğ· ÑĞµÑÑĞ¸Ğ¸ (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ ru)."""
    lang = session.get("lang", "ru")
    if lang not in LANGUAGES:
        lang = "ru"
    return lang


def _(key: str) -> str:
    """Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ğ°: _(key). Ğ•ÑĞ»Ğ¸ Ğ½ĞµÑ‚ ĞºĞ»ÑÑ‡Ğ° â€” Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ ÑĞ°Ğ¼ key."""
    lang = get_lang()
    return TRANSLATIONS.get(lang, TRANSLATIONS["ru"]).get(key, key)

--- FILE: .\core\journal_bp.py ---
from flask import Blueprint, render_template, jsonify, request, session
from models import SessionLocal, Student, Attendance, PeriodSkip
from datetime import date, datetime, timedelta
from config import get_schedule_for, today_key, now_minutes
from core.helpers import (
    parse_date_param,
    compute_status_by_mark,
    compute_status,
    STATUS_LABELS,
    REASON_LABELS,
)
from core.auth_bp import require_role
from core.permissions import get_curator_groups
from sqlalchemy import func

journal_bp = Blueprint("journal_bp", __name__)

VALID_STATUSES = {"present", "late", "absent", "excused"}


@journal_bp.route("/journal")
@require_role("curator")
def journal():
    d = parse_date_param(request.args.get("d"))
    today_d = date.today()

    # Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ° (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ = Ğ²ÑĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°)
    selected_group = (request.args.get("g") or "").strip()

    schedule = get_schedule_for(d)
    with SessionLocal() as s:
        # ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ñ‹ Ğº ÑÑ‚Ğ¾Ğ¼Ñƒ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ
        fio = (session.get("user") or {}).get("fio", "")
        curator_groups = [g.strip() for g in (get_curator_groups(fio) or []) if g and g.strip()]

        # Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼
        q_st = s.query(Student)

        if curator_groups:
            q_st = q_st.filter(func.trim(Student.group_code).in_(curator_groups))
        else:
            # Ñƒ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ â†’ Ğ¸ÑĞºÑƒÑÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ Ğ¿ÑƒÑÑ‚Ğ¾Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
            q_st = q_st.filter(Student.id == -1)

        # ĞµÑĞ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ° ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°, ÑÑƒĞ·Ğ¸Ğ¼ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾
        if selected_group:
            q_st = q_st.filter(func.trim(Student.group_code) == selected_group)

        students = q_st.order_by(Student.full_name).all()

        # ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ¿Ğ°Ğ´Ğ°ÑÑ‰ĞµĞ³Ğ¾ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°
        groups_available = [
            g for (g,) in (
                s.query(func.trim(Student.group_code))
                .filter(func.trim(Student.group_code).in_(curator_groups))
                .distinct()
                .order_by(func.trim(Student.group_code))
            )
        ]

        # Ğ²ÑĞµ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ (Ğ¿Ğ¾ Ğ²ÑĞµĞ¼ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ğ¼ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°)
        recs = s.query(Attendance).filter(Attendance.date == d).all()

        # Ğ²ÑĞµ skip'Ñ‹ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿ ÑÑ‚Ğ¾Ğ³Ğ¾ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
        q_sk = s.query(PeriodSkip).filter(PeriodSkip.date == d)
        if curator_groups:
            q_sk = q_sk.filter(func.trim(PeriodSkip.group_code).in_(curator_groups))
        skips = q_sk.all()

    # Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ğ¼ ĞºĞ°Ñ€Ñ‚Ñƒ: group_code -> set(period_code)
    skips_by_group = {}
    for r in skips:
        g_code = (r.group_code or "").strip()
        if not g_code:
            continue
        skips_by_group.setdefault(g_code, set()).add(r.period_code)

    # Ğ´Ğ»Ñ ÑˆĞ°Ğ¿ĞºĞ¸: ĞµÑĞ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°, ĞµÑ‘ skip'Ñ‹
    if selected_group:
        skipped_codes = skips_by_group.get(selected_group, set())
    else:
        skipped_codes = set()

    # ĞºĞ°Ñ€Ñ‚Ğ° Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸
    rec_map = {(r.student_id, r.period_code): r for r in recs}

    is_today = (d == today_d)
    nowm = now_minutes()

    table = []
    valid_statuses = {"present", "late", "absent", "excused"}
    day_counts = {"present": 0, "late": 0, "absent": 0, "excused_sick": 0, "excused_other": 0}
    per_student_stats = {}

    # ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ°Ñ€ Ğ² Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ·Ğ° Ğ´ĞµĞ½ÑŒ (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ²/Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·Ğ¾Ğº)
    if selected_group:
        group_skips_for_pairs = skips_by_group.get(selected_group, set())
        pairs_considered = sum(
            1 for p in schedule
            if p["code"].startswith("p") and p["code"] not in group_skips_for_pairs
        )
    else:
        # ĞµÑĞ»Ğ¸ ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸Ğ¼ Ğ²ÑĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ÑÑ€Ğ°Ğ·Ñƒ â€” ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ¿Ğ¾ Ñ‡Ğ¸ÑÑ‚Ğ¾Ğ¼Ñƒ Ñ€Ğ°ÑĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ
        pairs_considered = sum(1 for p in schedule if p["code"].startswith("p"))

    for i, st in enumerate(students, start=1):
        row = {
            "num": i,
            "id": st.id,
            "uid": st.uid,
            "full_name": st.full_name,
            "cells": [],
        }

        # ĞºĞ°ĞºĞ¸Ğµ Ğ¿Ğ°Ñ€Ñ‹ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ñ‹ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñƒ Ğ­Ğ¢ĞĞ™ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
        st_group = (st.group_code or "").strip()
        group_skipped_codes = skips_by_group.get(st_group, set())

        attended = 0
        total = 0

        for p in schedule:
            code = p["code"]
            rec = rec_map.get((st.id, code))

            if rec:
                stored_status = (rec.status or "").strip()
                reason = (rec.reason or None)
                mark = rec.time.strftime("%H:%M") if rec.time else None
                status = stored_status or (
                    compute_status(mark, p, nowm) if is_today else compute_status_by_mark(mark, p)
                )
            else:
                reason = None
                mark = None
                status = compute_status(mark, p, nowm) if is_today else ""

            is_skipped = False
            # Ğ•ÑĞ»Ğ¸ Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° ÑÑ‚Ğ° Ğ¿Ğ°Ñ€Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ° â†’ Ğ¿Ñ€Ğ¸Ğ½ÑƒĞ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ skip
            if code in group_skipped_codes and code.startswith("p"):
                status = "skip"
                mark = None
                reason = None
                is_skipped = True

            row["cells"].append(
                {
                    "code": code,
                    "status": status,
                    "reason": reason,
                    "mark": mark,
                    "is_skipped": is_skipped,
                }
            )

            if status in valid_statuses:
                total += 1
                if status in {"present", "late"}:
                    attended += 1
                if status == "present":
                    day_counts["present"] += 1
                elif status == "late":
                    day_counts["late"] += 1
                elif status == "absent":
                    day_counts["absent"] += 1
                elif status == "excused":
                    rtxt = (reason or "").strip().lower()
                    if rtxt in {"sick", "Ğ±Ğ¾Ğ»ĞµĞ»", "Ğ±Ğ¾Ğ»ĞµĞµÑ‚", "ill", "illness"}:
                        day_counts["excused_sick"] += 1
                    else:
                        day_counts["excused_other"] += 1

        table.append(row)
        per_student_stats[st.id] = {
            "name": st.full_name,
            "uid": st.uid,
            "attended": attended,
            "total": total,
        }

    day_total_considered = sum(day_counts.values())
    pct = lambda x: round((x / day_total_considered) * 100, 1) if day_total_considered else 0.0

    # Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµĞ¼ Ğ¿Ñ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ + Ğ¾Ğ¿Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ
    present_all = day_counts["present"] + day_counts["late"]

    day_percentages = {
        "present": pct(day_counts["present"]),
        "late": pct(day_counts["late"]),
        "present_all": pct(present_all),   # Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ÑŒ
        "absent": pct(day_counts["absent"]),
        "excused_sick": pct(day_counts["excused_sick"]),
        "excused_other": pct(day_counts["excused_other"]),
        "total": day_total_considered,
    }

    ranking = []
    for st_id, stv in per_student_stats.items():
        total = stv["total"]
        attended = stv["attended"]  # late Ğ·Ğ°ÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ
        percent = round((attended / total) * 100, 1) if total else 0.0
        ranking.append(
            {
                "name": stv["name"],
                "uid": stv["uid"],
                "attended": attended,
                "total": total,
                "percent": percent,
            }
        )
    ranking.sort(key=lambda r: (-r["percent"], -r["attended"], r["name"]))

    nav_prev = (d - timedelta(days=1)).strftime("%Y-%m-%d")
    nav_next = min(today_d, d + timedelta(days=1)).strftime("%Y-%m-%d")

    return render_template(
        "journal.html",
        schedule=schedule,
        table=table,
        today=today_key(),
        selected_date=d.strftime("%Y-%m-%d"),
        status_labels=STATUS_LABELS,
        reason_labels=REASON_LABELS,
        skipped_codes=skipped_codes,     # Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ° (ĞµÑĞ»Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°)
        day_counts=day_counts,
        day_percentages=day_percentages,
        ranking=ranking,
        has_data=(day_total_considered > 0),
        total_students=len(students),
        pairs_considered=pairs_considered,
        nav_prev=nav_prev,
        nav_next=nav_next,
        # Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿
        groups_available=groups_available,
        selected_group=selected_group,
    )


@journal_bp.route("/journal/skip", methods=["POST"])
@require_role("curator")
def journal_skip_toggle():
    d = parse_date_param(request.form.get("d"))
    code = (request.form.get("code") or "").strip()
    on = request.form.get("on") == "1"
    g = (request.form.get("g") or "").strip()

    if not code or not code.startswith("p"):
        return jsonify({"ok": False, "error": "ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ period_code"}), 400

    fio = (session.get("user") or {}).get("fio", "")
    curator_groups = [gg.strip() for gg in (get_curator_groups(fio) or []) if gg and gg.strip()]

    if not curator_groups:
        return jsonify({"ok": False, "error": "ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿"}), 400

    with SessionLocal() as s:
        if g == "__ALL__":
            # Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ ĞºĞ¾ Ğ²ÑĞµĞ¼ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ğ¼ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°
            for grp in curator_groups:
                ex = (
                    s.query(PeriodSkip)
                    .filter_by(date=d, period_code=code, group_code=grp)
                    .first()
                )
                if on and not ex:
                    s.add(PeriodSkip(date=d, period_code=code, group_code=grp))
                elif not on and ex:
                    s.delete(ex)
            s.commit()
        else:
            if not g:
                return jsonify({"ok": False, "error": "ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°"}), 400
            if g not in curator_groups:
                return jsonify({"ok": False, "error": "ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ"}), 403

            ex = (
                s.query(PeriodSkip)
                .filter_by(date=d, period_code=code, group_code=g)
                .first()
            )
            if on and not ex:
                s.add(PeriodSkip(date=d, period_code=code, group_code=g))
                s.commit()
            elif not on and ex:
                s.delete(ex)
                s.commit()

    return jsonify({"ok": True})


@journal_bp.route("/journal/set", methods=["POST"])
@require_role("curator")
def journal_set_status():
    try:
        d = parse_date_param(request.form.get("d"))
    except Exception:
        return jsonify({"ok": False, "error": "bad date"}), 400

    try:
        student_id = int(request.form.get("student_id") or "0")
    except ValueError:
        student_id = 0
    period_code = (request.form.get("period_code") or "").strip()
    status = (request.form.get("status") or "").strip()
    reason = (request.form.get("reason") or "").strip() or None

    if not (student_id and period_code.startswith("p") and status in VALID_STATUSES):
        return jsonify({"ok": False, "error": "bad params"}), 400

    now_t = datetime.now().time()
    with SessionLocal() as s:
        rec = (
            s.query(Attendance)
            .filter(
                Attendance.date == d,
                Attendance.period_code == period_code,
                Attendance.student_id == student_id,
            )
            .first()
        )
        if not rec:
            rec = Attendance(
                date=d,
                period_code=period_code,
                student_id=student_id,
                time=now_t,
            )
            s.add(rec)
        rec.status = status
        rec.reason = reason if status == "excused" else None
        if not rec.time:
            rec.time = now_t
        s.commit()
        time_str = rec.time.strftime("%H:%M") if rec.time else ""
        label = STATUS_LABELS.get(status, status)
        reason_label = REASON_LABELS.get(reason) if reason else None

    return jsonify(
        {
            "ok": True,
            "status": status,
            "label": label,
            "time": time_str,
            "reason": reason_label,
        }
    ), 200

--- FILE: .\core\permissions.py ---
# core/permissions.py
from typing import List
from models import SessionLocal, Student
from sqlalchemy import func

# ĞšĞ°Ñ€Ñ‚Ğ° ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ² -> ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿ (ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ñ‚Ğµ Ğ¶Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸, Ñ‡Ñ‚Ğ¾ Ğ² students.group_code)
CURATOR_GROUPS = {
    "Ğ¡ÑƒĞ»Ñ‚Ğ°Ğ½Ğ³Ğ°Ğ·Ğ¸Ğ½Ğ¾Ğ²Ğ° Ğ”Ğ¸Ğ°Ğ½Ğ° Ğ¡ĞµÑ€Ğ¸ĞºĞ¾Ğ²Ğ½Ğ°": ["PO-115", "PO-393"],  # Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒĞ±ĞµÑ€Ğ¸
    "Ğ‘Ñ€ÑƒÑĞµĞ½ĞºĞ¾ Ğ’Ğ»Ğ°Ğ´Ğ¸ÑĞ»Ğ°Ğ² Ğ¡ĞµÑ€Ğ³ĞµĞµĞ²Ğ¸Ñ‡": ["PO-175", "PO-323"],
}

def get_curator_groups(curator_fio: str) -> List[str]:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿, Ğ·Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€."""
    return CURATOR_GROUPS.get(curator_fio, [])

def student_in_curator_scope(curator_fio: str, student_id: int) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ Ğº Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ğ°."""
    groups = get_curator_groups(curator_fio)
    if not groups:
        return False
    with SessionLocal() as s:
        st = s.query(Student).filter(Student.id == student_id).first()
        if not st:
            return False
        return (st.group_code or "") in groups


# ĞšĞ°Ñ€Ñ‚Ğ° ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚ -> ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¸Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿
STAROSTA_GROUPS = {
    "Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ° ĞŸĞ175": ["PO-175"],
}

def get_starosta_groups(starosta_fio: str) -> list[str]:
    """Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿, Ğ·Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°ĞµÑ‚ ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ°."""
    return STAROSTA_GROUPS.get(starosta_fio, [])

def student_in_starosta_scope(starosta_fio: str, student_id: int) -> bool:
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, Ñ‡Ñ‚Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ñ‹."""
    groups = get_starosta_groups(starosta_fio)
    if not groups:
        return False
    with SessionLocal() as s:
        st = s.query(Student).filter(Student.id == student_id).first()
        if not st:
            return False
        return (st.group_code or "") in groups

HEAD_PREFIXES = {
    # "Ğ¤Ğ˜Ğ Ğ·Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰ĞµĞ¹": ["PO-"],
    "Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ° Ğ“Ğ°Ğ»Ğ¸Ğ½Ğ° ĞŸĞµÑ‚Ñ€Ğ¾Ğ²Ğ½Ğ°": ["PO-"],
}

def get_head_allowed_prefixes(head_fio: str) -> list[str]:
    return HEAD_PREFIXES.get(head_fio, [])

def head_list_groups_for_prefixes(prefixes: list[str]) -> list[str]:
    """Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ¸Ğ· Ğ‘Ğ”, Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ¸Ñ…ÑÑ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ¾Ğ²."""
    if not prefixes:
        return []
    with SessionLocal() as s:
        q = s.query(func.trim(Student.group_code)).filter(Student.group_code.isnot(None))
        # ÑĞºĞ»ĞµĞ¸Ğ²Ğ°ĞµĞ¼ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ Ğ¿Ğ¾ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑĞ°Ğ¼
        cond = None
        for pfx in prefixes:
            like_expr = f"{pfx}%"
            part = Student.group_code.like(like_expr)
            cond = part if cond is None else (cond | part)
        if cond is not None:
            q = q.filter(cond)
        groups = sorted({(g or "").strip() for (g,) in q.distinct().all() if (g or "").strip()})
        return groups

def head_group_allowed(head_fio: str, group_code: str) -> bool:
    """ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ»Ğ¸ Ğ·Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½ÑƒÑ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ."""
    prefixes = get_head_allowed_prefixes(head_fio)
    if not prefixes:
        return False
    g = (group_code or "").strip()
    return any(g.startswith(p) for p in prefixes)
--- FILE: .\core\starosta.py ---
from __future__ import annotations
from datetime import date, datetime, time as dtime
from flask import Blueprint, render_template, request, redirect, url_for, flash, session
from sqlalchemy import select
from models import SessionLocal, Student, Attendance, StarostaLock
from core.auth_bp import require_role
from core.permissions import get_starosta_groups
from config import get_schedule_for
from core.helpers import current_period_index

starosta_bp = Blueprint("starosta", __name__, template_folder="../templates")


def _starosta_group() -> str | None:
    fio = (session.get("user") or {}).get("fio", "")
    groups = [g.strip() for g in get_starosta_groups(fio) if g and g.strip()]
    if not groups:
        return None
    # ĞŸÑ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼ 1 Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ñƒ; ĞµÑĞ»Ğ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ â€” Ğ²Ğ¾Ğ·ÑŒĞ¼Ñ‘Ğ¼ Ğ¿ĞµÑ€Ğ²ÑƒÑ
    return groups[0]


@starosta_bp.route("/starosta", methods=["GET"])
@require_role("starosta")
def starosta_form():
    g = _starosta_group()
    if not g:
        flash("Ğ”Ğ»Ñ Ğ²Ğ°ÑˆĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ½Ğµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº ĞºÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ.", "error")
        return render_template(
            "starosta.html",
            students=[],
            schedule=[],
            current_index=None,
            group_code=None,
            locked=True,
        )

    today_d = date.today()
    schedule = get_schedule_for(today_d)
    cur_idx = current_period_index(schedule=schedule)
    if cur_idx is None or cur_idx < 0 or cur_idx >= len(schedule):
        cur_idx = None

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ğ¼ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑĞ²Ğ¾ĞµĞ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
    with SessionLocal() as s:
        students = (
            s.query(Student)
            .filter(Student.group_code == g)
            .order_by(Student.full_name)
            .all()
        )

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ğ¼ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞ»Ğ¸ Ğ»Ğ¸ ÑƒĞ¶Ğµ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ½Ğ° ÑÑ‚Ñƒ Ğ¿Ğ°Ñ€Ñƒ
        locked = False
        period_code = None
        if cur_idx is not None:
            period_code = schedule[cur_idx]["code"]
            lock = (
                s.query(StarostaLock)
                .filter(
                    StarostaLock.date == today_d,
                    StarostaLock.period_code == period_code,
                    StarostaLock.group_code == g,
                )
                .first()
            )
            locked = bool(lock)

    return render_template(
        "starosta.html",
        students=students,
        schedule=schedule,
        current_index=cur_idx,
        group_code=g,
        locked=locked,
        excused_reasons=["sick", "competition", "family", "other"],
    )


@starosta_bp.route("/starosta/submit", methods=["POST"])
@require_role("starosta")
def starosta_submit():
    g = _starosta_group()
    if not g:
        flash("ĞĞµ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ñ‹.", "error")
        return redirect(url_for("starosta.starosta_form"))

    today_d = date.today()
    schedule = get_schedule_for(today_d)
    cur_idx = current_period_index(schedule=schedule)
    if cur_idx is None or cur_idx < 0 or cur_idx >= len(schedule):
        flash("Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½ĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸.", "error")
        return redirect(url_for("starosta.starosta_form"))
    period_code = schedule[cur_idx]["code"]

    status = (request.form.get("status") or "").strip()
    if status not in {"present", "absent", "excused"}:
        flash("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑ‚Ğ°Ñ‚ÑƒÑ (Ğ±Ñ‹Ğ»/Ğ½Ğµ Ğ±Ñ‹Ğ»/ÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ).", "error")
        return redirect(url_for("starosta.starosta_form"))
    reason = (request.form.get("reason") or "").strip() if status == "excused" else None

    # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²
    ids = request.form.getlist("student_ids")
    ids = [int(x) for x in ids if str(x).isdigit()]
    if not ids:
        flash("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°.", "error")
        return redirect(url_for("starosta.starosta_form"))

    fio = (session.get("user") or {}).get("fio", "")

    with SessionLocal() as s:
        # Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½Ğ°
        exists = (
            s.query(StarostaLock)
            .filter(
                StarostaLock.date == today_d,
                StarostaLock.period_code == period_code,
                StarostaLock.group_code == g,
            )
            .first()
        )
        if exists:
            flash("ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ° ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ»Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹. ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€ Ğ·Ğ°Ğ¿Ñ€ĞµÑ‰ĞµĞ½.", "error")
            return redirect(url_for("starosta.starosta_form"))

        now_t = datetime.now().time()
        # Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ ĞºĞ¾ Ğ²ÑĞµĞ¼ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¼
        for sid in ids:
            st = (
                s.query(Student)
                .filter(Student.id == sid, Student.group_code == g)
                .first()
            )
            if not st:
                continue
            rec = (
                s.query(Attendance)
                .filter(
                    Attendance.date == today_d,
                    Attendance.period_code == period_code,
                    Attendance.student_id == sid,
                )
                .first()
            )
            if not rec:
                rec = Attendance(date=today_d, period_code=period_code, student_id=sid)
                s.add(rec)
            rec.status = status
            rec.reason = reason
            rec.time = now_t

        # ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ
        lock = StarostaLock(
            date=today_d, period_code=period_code, group_code=g, submitted_by=fio
        )
        s.add(lock)
        s.commit()

    flash("ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹ Ğ¸ Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ â€” Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°.", "success")
    return redirect(url_for("starosta.starosta_form"))
--- FILE: .\core\student_bp.py ---
# core/routes_student.py
from flask import Blueprint, render_template, request, redirect, url_for, session, flash
from datetime import date, datetime, timedelta
from models import SessionLocal, Student, Attendance
from core.auth_bp import require_role
from config import get_schedule_for, today_key
from core.helpers import current_period_index

student_bp = Blueprint("student_bp", __name__)

def _week_range(center: date):
    start = center - timedelta(days=center.weekday())  # Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº
    return [start + timedelta(days=i) for i in range(7)]

@student_bp.route("/student")
@require_role("student")
def dashboard():
    fio = session.get("user", {}).get("fio")
    if not fio:
        flash("Ğ¡ĞµÑÑĞ¸Ñ Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°", "error")
        return redirect(url_for("auth_bp.login"))

    today = date.today()
    schedule_today = get_schedule_for(today)

    with SessionLocal() as s:
        st = s.query(Student).filter(Student.full_name == fio).first()
        if not st:
            flash("Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ", "error")
            return redirect(url_for("auth_bp.logout"))

        week_days = _week_range(today)
        recs = (
            s.query(Attendance)
             .filter(Attendance.student_id == st.id,
                     Attendance.date.in_(week_days))
             .all()
        )

    # Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğ°Ğ¼ Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼
    week_map = {d: {} for d in week_days}  # {date: {p1: status, ...}}
    for r in recs:
        week_map.setdefault(r.date, {})[r.period_code] = r.status or ""

    # Ğ¿Ñ€Ğ¸Ğ²Ğ¾Ğ´Ğ¸Ğ¼ Ğº ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾Ğ¼Ñƒ Ğ²Ğ¸Ğ´Ñƒ Ğ´Ğ»Ñ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°
    week_view = []
    for d in week_days:
        week_view.append({
            "date": d,
            "date_text": d.strftime("%Y-%m-%d"),
            "items": week_map.get(d, {})
        })

    return render_template(
        "student.html",
        fio=fio,
        today=today_key(),
        schedule_today=schedule_today,
        week=week_view
    )

@student_bp.route("/student/checkin", methods=["POST"])
@require_role("student")
def student_checkin():
    fio = session.get("user", {}).get("fio")
    if not fio:
        flash("Ğ¡ĞµÑÑĞ¸Ñ Ğ½ĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°", "error")
        return redirect(url_for("auth_bp.login"))

    today = date.today()
    now = datetime.now().time()
    schedule = get_schedule_for(today)
    idx = current_period_index(schedule=schedule)

    if idx is None:
        flash("Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ¿Ğ°Ñ€Ñ‹, Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ° Ğ½Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°.", "error")
        return redirect(url_for("student_bp.dashboard"))

    period_code = schedule[idx]["code"]

    with SessionLocal() as s:
        st = s.query(Student).filter(Student.full_name == fio).first()
        if not st:
            flash("Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ±Ğ°Ğ·Ğµ", "error")
            return redirect(url_for("auth_bp.logout"))

        rec = (
            s.query(Attendance)
             .filter(Attendance.date == today,
                     Attendance.period_code == period_code,
                     Attendance.student_id == st.id)
             .first()
        )
        if not rec:
            rec = Attendance(
                date=today,
                period_code=period_code,
                time=now,
                student_id=st.id,
                status="present",
                reason=None
            )
            s.add(rec)
        else:
            rec.time = now
            rec.status = "present"
            rec.reason = None
        s.commit()

    flash("ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ° Â«Ğ¯ Ğ¿Ñ€Ğ¸ÑˆÑ‘Ğ»Â» ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°", "success")
    return redirect(url_for("student_bp.dashboard"))

--- FILE: .\core\utils.py ---
# core/utils.py
STATUS_LABELS = {
    "present": "ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
    "late": "ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»",
    "absent": "ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»",
    "excused": "Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°",
    "skip": "ĞŸĞ°Ñ€Ñ‹ Ğ½ĞµÑ‚",
}

def status_label(code: str) -> str:
    """Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€ÑƒÑÑĞºĞ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸."""
    return STATUS_LABELS.get(code, code)

--- FILE: .\core\__init__.py ---

--- FILE: .\static\style.css ---
:root {
  --border:#e5e7eb;
  --muted:#6b7280;
  --primary:#ff7b00;
  --primary-700:#e86f00;
  --primary-800:#cc6100;
  --radius:14px;
  --surface:#fff;
  --text:#111827;
  --shadow:0 10px 28px rgba(0,0,0,.08);
  --space-1:6px;
  --space-2:10px;
  --space-3:14px;
  --space-4:18px;
}

body {
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
  background: #f8fafc;
  color: var(--text);
  -webkit-text-size-adjust: 100%;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.site-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
  color: var(--text);
  padding: 12px 20px;
  gap: 12px;
  border-bottom: 1px solid var(--border);
  box-shadow: 0 2px 8px rgba(0,0,0,.05);
}

.site-header .brand { font-weight: 600; letter-spacing: .2px; }

.site-header nav {
  display: flex;
  gap: 8px;
  overflow: auto hidden;
  -webkit-overflow-scrolling: touch;
}

/* ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ñ‹Ğµ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ² Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ğ¸ */
.site-header nav a {
  background: var(--primary);
  color: #fff;
  text-decoration: none;
  padding: 7px 12px;
  border-radius: 8px;
  white-space: nowrap;
  flex: 0 0 auto;
  box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  transition: none; /* ÑƒĞ±Ñ€Ğ°Ğ»Ğ¸ Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ */
}
.site-header nav a:hover { background: var(--primary-700); }
.site-header nav a:active { background: var(--primary-800); }
.site-header nav a.active { background: var(--primary-700); }

main { padding: 18px; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.flash { padding:10px 12px; border-radius:10px; margin:8px 0; }
.flash.ok { background:#f0fdf4; border:1px solid #16a34a33; }
.flash.error { background:#fef2f2; border:1px solid #ef444433; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ JOURNAL TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.table-wrap { overflow:auto; -webkit-overflow-scrolling:touch; }
table.journal { width:100%; border-collapse:separate; border-spacing:0 6px; }
table.journal thead th {
  position:sticky; top:0; z-index:1;
  background:#fff; border-bottom:1px solid var(--border);
  padding:8px 10px; text-align:left;
}
table.journal tbody td {
  background:#fff; border:1px solid var(--border);
  padding:8px 10px;
}

/* ĞºĞ»ĞµÑ‚ĞºĞ¸/Ğ±ĞµĞ¹Ğ´Ğ¶Ğ¸ */
.cell-wrap { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
.badge {
  display:inline-flex; align-items:center; gap:4px;
  padding:2px 8px; border-radius:999px; border:1px solid var(--border);
  font-size:12px; background:#fff;
}
.badge.ok { border-color:#16a34a33; background:#f0fdf4; }
.badge.late { border-color:#f59e0b33; background:#fffbeb; }
.badge.absent { border-color:#ef444433; background:#fef2f2; }
.badge.excused { border-color:#3b82f633; background:#eff6ff; }
.badge.skip { border-color:#94a3b833; background:#f1f5f9; }
.badge.empty { opacity:.6; }
.reason { font-size:12px; color:#6b7280; }
.marktime { font-size:12px; color:#334155; }
.th-skipped { opacity:.6; text-decoration:line-through; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SKIPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.skipbar {
  background:#fff; border:1px solid var(--border);
  border-radius:14px; padding:12px; margin:12px 0;
  box-shadow:0 2px 10px rgba(0,0,0,.04);
}
.skip-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
.skip-item {
  display:flex; align-items:center; gap:8px;
  border:1px solid var(--border); border-radius:10px;
  padding:8px; background:#fff;
}
.skip-item input[type="checkbox"] { width:18px; height:18px; }
.skip-item .lbl { display:flex; flex-direction:column; font-weight:700; }
.skip-item .lbl small { font-weight:500; color:var(--muted); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PROFILE CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-card {
  background: var(--surface,#fff);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding:16px 20px;
  max-width:800px;
  margin:12px auto 24px;
}
.profile-card h2 { font-size:20px; margin-bottom:6px; color:var(--text); }
.profile-card p { margin:4px 0; color:var(--muted); font-size:15px; }
.title { font-size:26px; font-weight:600; margin-bottom:10px; text-align:center; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MOBILE â‰¤ 740px â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width:740px) {
  main { padding: var(--space-3); }
  .title { font-size:22px; line-height:1.25; padding:0 var(--space-2); }

  .site-header {
    flex-direction:column;
    align-items:flex-start;
    padding:12px var(--space-3);
  }
  .site-header nav { width:100%; }
  .site-header nav a { padding:8px 12px; }

  .profile-card {
    margin:10px auto 18px;
    padding:14px var(--space-3);
    max-width:100%;
  }
  .profile-card h2 { font-size:18px; }
  .profile-card p { font-size:14px; }

  table.journal thead th, table.journal tbody td { padding:8px; }
  .badge { font-size:11px; padding:2px 8px; }
  .reason, .marktime { font-size:11px; }

  .skip-grid { grid-template-columns:repeat(3,1fr); }
  .skip-item { padding:8px; }
  .skip-item input[type="checkbox"] { width:20px; height:20px; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VERY SMALL â‰¤ 420px â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width:420px) {
  .title { font-size:20px; }

  .site-header { gap:8px; }
  .site-header nav { gap:6px; }
  .site-header nav a { padding:7px 10px; font-size:14px; }

  main { padding: var(--space-2); }

  .profile-card {
    padding:12px var(--space-2);
    border-radius:12px;
  }
  .profile-card h2 { font-size:17px; }
  .profile-card p { font-size:13px; }

  table.journal thead th, table.journal tbody td { padding:6px 8px; font-size:13px; }
  .cell-wrap { gap:4px; }
  .badge { font-size:10.5px; padding:2px 7px; }
  .reason, .marktime { font-size:10.5px; }

  .skip-grid { grid-template-columns:repeat(2,1fr); gap:6px; }
  .skip-item { padding:10px; }
  .skip-item .lbl { font-size:14px; }
  .skip-item .lbl small { font-size:12px; }
  .skip-item input[type="checkbox"] { width:22px; height:22px; }

  .table-wrap { margin:0 -12px; padding:0 12px; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ULTRA COMPACT â‰¤ 360px â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width:360px) {
  .title { font-size:18px; }
  .profile-card h2 { font-size:16px; }
  .profile-card p { font-size:12.5px; }
  .skip-item .lbl { font-size:13.5px; }
}

/* Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿ Ğ½Ğ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğµ Ğ²Ñ…Ğ¾Ğ´Ğ° */
.login-logo {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 40px;
}

.login-logo img {
  width: 180px;
  height: 180px;
  object-fit: contain;
  border-radius: 50%;
  box-shadow: 0 0 15px rgba(0,0,0,0.08);
}

--- FILE: .\templates\admin_console.html ---
{% extends "base.html" %}
{% block title %}ĞĞ´Ğ¼Ğ¸Ğ½-ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ{% endblock %}
{% block content %}

<style>
  :root{
    --bg:#0b1020; --card:#121830; --mut:#a0a7bf; --text:#e8ecff;
    --br:#1f2a4a; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --info:#3b82f6;
    --chip:#1b2442;
  }
  body{ background:var(--bg); color:var(--text); }
  .wrap{ max-width:860px; margin:0 auto; padding:10px 10px 90px; }
  .h1{ font-size:20px; font-weight:800; margin:10px 0 8px; }

  .bar{
    position: sticky; top:0; z-index:10;
    display:flex; gap:8px; align-items:center; padding:10px;
    background:var(--card); border-bottom:1px solid var(--br);
  }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:var(--chip); border:1px solid var(--br); color:var(--text); font-size:12px;}
  select, button{ height:36px; border-radius:8px; border:1px solid var(--br); background:#0f152b; color:var(--text); padding:0 10px; }
  button{ cursor:pointer; }
  .live{ margin-left:auto; display:flex; align-items:center; gap:8px; }
  .live input{ width:18px; height:18px; accent-color:var(--info); }

  .list{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
  .item{ background:var(--card); border:1px solid var(--br); border-radius:12px; padding:10px; }
  .head{ display:flex; gap:8px; align-items:baseline; justify-content:space-between; }
  .lvl{ font-weight:800; text-transform:uppercase; font-size:12px; padding:2px 8px; border-radius:999px; }
  .lvl.log{ background:#0b2a1a; color:#a7f3d0; border:1px solid #064e3b; }
  .lvl.info{ background:#0b2348; color:#93c5fd; border:1px solid #1d4ed8; }
  .lvl.warn{ background:#3a2806; color:#fde68a; border:1px solid #b45309; }
  .lvl.error{ background:#3a0d10; color:#fecaca; border:1px solid #b91c1c; }
  .time{ color:var(--mut); font-size:12px; }
  .msg{ white-space:pre-wrap; margin-top:6px; }
  .meta{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .meta .chip{ font-size:11px; opacity:.9; }

  /* Ğ½Ğ¸Ğ¶Ğ½ÑÑ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¿Ğ¾Ğ´ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ */
  .dock{
    position: fixed; left:0; right:0; bottom:0; z-index:20;
    background:var(--card); border-top:1px solid var(--br);
    display:flex; gap:8px; padding:8px 10px;
  }
  .dock .chip{ flex:1; justify-content:center; }
</style>

<div class="wrap">
  <div class="h1">ĞĞ´Ğ¼Ğ¸Ğ½-ĞºĞ¾Ğ½ÑĞ¾Ğ»ÑŒ (live)</div>

  <div class="bar">
    <label>Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ:</label>
    <select id="level">
      <option value="*">Ğ’ÑĞµ</option>
      <option value="error">error</option>
      <option value="warn">warn</option>
      <option value="info">info</option>
      <option value="log">log</option>
      <option value="hello">hello</option>
    </select>

    <div class="live">
      <label class="chip"><input type="checkbox" id="autoref" checked> Ğ°Ğ²Ñ‚Ğ¾-Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ</label>
      <button id="reload">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
      <button id="clear">ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾</button>
    </div>
  </div>

  <div id="list" class="list"></div>
</div>

<!-- Ğ½Ğ¸Ğ¶Ğ½ÑÑ Ğ´Ğ¾Ğº-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ: ĞºÑ€Ğ°Ñ‚ĞºĞ°Ñ Ğ¸Ğ½Ñ„Ğ° Ğ¾Ğ± ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğµ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° -->
<div class="dock">
  <div class="chip" id="me-ua">UA: â€”</div>
  <div class="chip" id="me-res">Screen: â€”</div>
</div>

<script>
(function(){
  const list = document.getElementById('list');
  const levelSel = document.getElementById('level');
  const btnReload = document.getElementById('reload');
  const btnClear = document.getElementById('clear');
  const chkAuto = document.getElementById('autoref');
  let since = 0;
  let timer = null;

  // ĞºÑ€Ğ°Ñ‚ĞºĞ°Ñ Ğ¸Ğ½Ñ„Ğ° Ğ¾ Ğ¢Ğ•ĞšĞ£Ğ©Ğ•Ğœ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°
  document.getElementById('me-ua').textContent = 'UA: ' + (navigator.userAgent || 'â€”');
  document.getElementById('me-res').textContent = 'Screen: ' + (window.screen.width + 'x' + window.screen.height);

  function badge(level){
    return `<span class="lvl ${level}">${level}</span>`;
  }

  function itemView(ev){
    const d = ev.device || {};
    const meta = [
      ev.user_fio ? `ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: ${ev.user_fio}` : null,
      ev.ip ? `IP: ${ev.ip}` : null,
      ev.path ? `URL: ${ev.path}` : null,
      d.viewport ? `Viewport: ${d.viewport}` : null,
      d.screen ? `Screen: ${d.screen}` : null,
      (d.cpu ? `CPU: ${d.cpu} cores` : null),
      (d.memory ? `RAM: ${d.memory} GB` : null),
      d.platform ? `Platform: ${d.platform}` : null,
      d.tz ? `TZ: ${d.tz}` : null,
      d.language ? `Lang: ${d.language}` : null,
      ev.session ? `Session: ${ev.session}` : null,
    ].filter(Boolean).map(x => `<span class="chip">${x}</span>`).join("");

    return `
      <div class="item">
        <div class="head">
          <div>${badge(ev.level)}</div>
          <div class="time">${ev.ts}</div>
        </div>
        <div class="msg">${(ev.message || '').replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</div>
        <div class="meta">
          <span class="chip">${(ev.ua || '').split(' ').slice(0,6).join(' ')}</span>
          ${meta}
        </div>
      </div>
    `;
  }

  async function fetchEvents() {
    const params = new URLSearchParams();
    if (since) params.set('since_id', String(since));
    const level = levelSel.value || '*';
    if (level && level !== '*') params.set('level', level);
    try{
      const res = await fetch(`/admin/console/events?${params.toString()}`, {cache:'no-store'});
      const j = await res.json();
      if (!res.ok || !j.ok) throw new Error('fetch failed');
      const evs = j.events || [];
      if (evs.length){
        const frag = document.createDocumentFragment();
        evs.forEach(ev => {
          since = Math.max(since, ev.id);
          const div = document.createElement('div');
          div.innerHTML = itemView(ev);
          frag.appendChild(div.firstElementChild);
        });
        list.appendChild(frag);
        // Ğ°Ğ²Ñ‚Ğ¾-ÑĞºÑ€Ğ¾Ğ»Ğ» Ğ²Ğ½Ğ¸Ğ· Ğ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğµ
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      }
    }catch(e){
      // Ğ¼Ğ¾Ğ»Ñ‡Ğ° â€” Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ°Ğ´Ğ¼Ğ¸Ğ½ĞºĞ° Ğ½Ğµ "Ğ¼Ğ¸Ğ³Ğ°Ğ»Ğ°"
    }
  }

  function start(){
    stop();
    fetchEvents();
    if (chkAuto.checked){
      timer = setInterval(fetchEvents, 3000);
    }
  }
  function stop(){
    if (timer){ clearInterval(timer); timer = null; }
  }

  levelSel.addEventListener('change', () => { since = 0; list.innerHTML = ""; start(); });
  chkAuto.addEventListener('change', () => start());
  btnReload.addEventListener('click', () => { fetchEvents(); });
  btnClear.addEventListener('click', () => { list.innerHTML = ""; since = 0; });

  // Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  start();
})();
</script>

{% endblock %}

--- FILE: .\templates\base.html ---
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>{% block title %}Ğ›Ğ”Ğ{% endblock %}</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  {% block head %}{% endblock %}

  <style>
    /* Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; /* Ğ¡ĞºÑ€Ğ¾Ğ»Ğ»Ğ¸Ğ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚ */
      background-color: #f8f9fa;
    }
    
    /* ĞĞ±ĞµÑ€Ñ‚ĞºĞ° */
    .main-wrapper {
      display: flex;
      height: 100vh;
      width: 100%;
      flex-direction: column; /* ĞĞ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğµ Ğ²ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ğ¾ */
    }

    /* Ğ¡Ğ°Ğ¹Ğ´Ğ±Ğ°Ñ€ (Ğ”ĞµÑĞºÑ‚Ğ¾Ğ¿) */
    .desktop-sidebar {
      width: 280px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    /* ĞœĞ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ğ°Ñ ÑˆĞ°Ğ¿ĞºĞ° */
    .mobile-navbar {
      display: none; /* Ğ¡ĞºÑ€Ñ‹Ñ‚Ğ° Ğ½Ğ° ĞŸĞš */
      padding: 10px 16px;
      background: #212529; /* Dark bg */
      color: white;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    /* ĞĞ±Ğ»Ğ°ÑÑ‚ÑŒ ĞºĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚Ğ° */
    .content-area {
      flex-grow: 1;
      overflow-y: auto; /* Ğ¡ĞºÑ€Ğ¾Ğ»Ğ» Ğ·Ğ´ĞµÑÑŒ */
      padding: 20px;
      background-color: #f8f9fa;
      position: relative;
    }

    /* ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ (ĞŸĞš -> ĞœĞ¾Ğ±Ğ¸Ğ»ĞºĞ°) */
    @media (min-width: 768px) {
      .main-wrapper { flex-direction: row; } /* ĞĞ° ĞŸĞš Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»ÑŒĞ½Ğ¾ */
      .mobile-navbar { display: none; }      /* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼Ğ¾Ğ±. ÑˆĞ°Ğ¿ĞºÑƒ */
      .desktop-sidebar { display: flex; }    /* ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ°Ğ¹Ğ´Ğ±Ğ°Ñ€ */
    }

    @media (max-width: 767.98px) {
      .desktop-sidebar { display: none; }    /* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ°Ğ¹Ğ´Ğ±Ğ°Ñ€ Ğ½Ğ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğµ */
      .mobile-navbar { display: flex; }      /* ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑˆĞ°Ğ¿ĞºÑƒ */
      .content-area { padding: 12px; padding-bottom: 80px; } /* ĞÑ‚ÑÑ‚ÑƒĞ¿Ñ‹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ» */
    }

    /* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ ÑÑÑ‹Ğ»Ğ¾Ğº */
    .nav-pills .nav-link.active { background-color: #ff7b00 !important; }
    .nav-link { color: white; }
    .nav-link:hover { color: #ff7b00; }

    /* Flash ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ */
    .flash-container { margin-bottom: 20px; }
    .flash { padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
    .flash.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .flash.success { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
  </style>
</head>
<body>

{% macro render_menu() %}
  <ul class="nav nav-pills flex-column mb-auto">
    {% set user = session.get('user') %}
    
    {% if user %}
      {% set role = user.role %}

      {% if role == 'curator' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€</small></li>
        <li><a href="/journal" class="nav-link text-white"><i class="bi bi-journal-text me-2"></i> Ğ–ÑƒÑ€Ğ½Ğ°Ğ»</a></li>
        <li><a href="/checkin" class="nav-link text-white"><i class="bi bi-check-square me-2"></i> ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ°</a></li>
        <li><a href="/curator" class="nav-link text-white"><i class="bi bi-graph-up me-2"></i> Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°</a></li>
        <li><a href="/complaints" class="nav-link text-white"><i class="bi bi-exclamation-triangle me-2"></i> Ğ–Ğ°Ğ»Ğ¾Ğ±Ñ‹</a></li>
      {% endif %}

      {% if role == 'starosta' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ°</small></li>
        <li><a href="/starosta" class="nav-link text-white"><i class="bi bi-clipboard-check me-2"></i> ĞÑ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ</a></li>
      {% endif %}

      {% if role == 'student' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Ğ›Ğ¸Ñ‡Ğ½Ğ¾Ğµ</small></li>
        <li><a href="/student" class="nav-link text-white"><i class="bi bi-person-circle me-2"></i> ĞšĞ°Ğ±Ğ¸Ğ½ĞµÑ‚</a></li>
      {% endif %}

      {% if role == 'head' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Ğ—Ğ°Ğ². Ğ¾Ñ‚Ğ´ĞµĞ»ĞµĞ½Ğ¸ĞµĞ¼</small></li>
        <li><a href="/head" class="nav-link text-white"><i class="bi bi-building me-2"></i> Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹</a></li>
      {% endif %}

      {% if role == 'admin' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">ĞĞ´Ğ¼Ğ¸Ğ½</small></li>
        <li><a href="/admin/console" class="nav-link text-white"><i class="bi bi-terminal me-2"></i> ĞšĞ¾Ğ½ÑĞ¾Ğ»ÑŒ</a></li>
        <li><a href="/admin/students/upload" class="nav-link text-white"><i class="bi bi-upload me-2"></i> Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚</a></li>
      {% endif %}

    {% else %}
      <li><a href="{{ url_for('auth_bp.login') }}" class="nav-link text-white"><i class="bi bi-box-arrow-in-right me-2"></i> Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</a></li>
    {% endif %}
  </ul>
{% endmacro %}

{% macro render_profile() %}
  <div class="dropdown">
    {% set user = session.get('user') %}
    {% if user %}
      <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img src="https://ui-avatars.com/api/?name={{ user.fio }}&background=random&color=fff" alt="" width="32" height="32" class="rounded-circle me-2">
        <div class="d-flex flex-column text-truncate">
          <strong class="text-truncate">{{ user.fio.split()[0] }} {{ user.fio.split()[1]|default('') }}</strong>
          <small style="font-size: 11px; opacity: 0.7;">
              {{ {
                  'curator': 'ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€',
                  'student': 'Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚',
                  'starosta': 'Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ°',
                  'head': 'Ğ—Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰Ğ°Ñ',
                  'admin': 'ĞĞ´Ğ¼Ğ¸Ğ½'
              }.get(user.role, user.role) }}
          </small>
        </div>
      </a>
      <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
        <li><a class="dropdown-item" href="{{ url_for('auth_bp.logout') }}">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</a></li>
      </ul>
    {% else %}
       <span class="text-white small">Ğ“Ğ¾ÑÑ‚ÑŒ</span>
    {% endif %}
  </div>
{% endmacro %}


<div class="main-wrapper">

  <div class="mobile-navbar">
    <div class="d-flex align-items-center gap-2">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" width="28" height="28" class="rounded-circle bg-white">
      <span class="fw-bold fs-5">LDO</span>
    </div>
    <button class="btn btn-dark border-secondary p-1 px-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
      <i class="bi bi-list fs-4"></i>
    </button>
  </div>

  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mobileMenu" style="width: 280px;">
    <div class="offcanvas-header border-bottom border-secondary">
      <h5 class="offcanvas-title d-flex align-items-center gap-2">
        <img src="{{ url_for('static', filename='img/logo.png') }}" width="24" class="rounded-circle bg-white"> ĞœĞµĞ½Ñ
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column justify-content-between">
      {{ render_menu() }}
      <hr>
      {{ render_profile() }}
    </div>
  </div>

  <div class="desktop-sidebar p-3 text-bg-dark">
    <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" width="32" height="32" class="rounded-circle me-2" style="background: white;">
      <span class="fs-4">LDO Attendance</span>
    </a>
    <hr>
    {{ render_menu() }}
    <hr>
    {{ render_profile() }}
  </div>

  <div class="content-area">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">
              {% if cat == 'error' %}âš ï¸{% else %}âœ…{% endif %}
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% block body_end %}{% endblock %}

</body>
</html>
--- FILE: .\templates\checkin.html ---
{% extends "base.html" %}
{% block title %}ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ° Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ°{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

<style>
  :root {
    --font-main: 'Inter', sans-serif;
    --bg-page: #f3f4f6;
    --bg-card: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    
    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);

    /* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑĞ½Ñ‹Ğµ Ñ†Ğ²ĞµÑ‚Ğ° */
    --color-present: #10b981;
    --color-late: #f59e0b;
    --color-absent: #ef4444;
    --color-excused: #3b82f6;
  }

  body { background: var(--bg-page); color: var(--text-primary); font-family: var(--font-main); }

  /* Ğ—ĞĞ“ĞĞ›ĞĞ’ĞĞš */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-title h1 { font-size: 24px; font-weight: 700; margin: 0; }
  .page-title span { color: var(--text-secondary); font-size: 14px; }

  .filter-select {
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
    background: #fff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    min-width: 200px;
  }

  /* ĞĞ¡ĞĞĞ’ĞĞĞ¯ Ğ¡Ğ•Ğ¢ĞšĞ */
  .layout-grid {
    display: grid;
    grid-template-columns: 1fr 340px; /* Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚Ñ‹ ÑĞ»ĞµĞ²Ğ°, Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ ÑĞ¿Ñ€Ğ°Ğ²Ğ° */
    gap: 24px;
    align-items: start;
  }
  @media (max-width: 1000px) { .layout-grid { grid-template-columns: 1fr; } }

  /* ĞšĞĞ Ğ¢ĞĞ§ĞšĞ˜ Ğ¡Ğ¢Ğ£Ğ”Ğ•ĞĞ¢ĞĞ’ */
  .students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }

  .student-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 16px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer; /* Ğ’ÑÑ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° ĞºĞ»Ğ¸ĞºĞ°Ğ±ĞµĞ»ÑŒĞ½Ğ° Ğ´Ğ»Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° */
    user-select: none;
  }
  
  /* Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ */
  .student-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #c7d2fe; }
  
  /* ĞšĞ¾Ğ³Ğ´Ğ° Ñ‡ĞµĞºĞ±Ğ¾ĞºÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ */
  .student-card.selected {
    border-color: var(--primary-color);
    background-color: #eef2ff;
    box-shadow: 0 0 0 1px var(--primary-color);
  }

  .st-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
  
  .st-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: #f3f4f6;
    color: var(--primary-color);
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px;
    flex-shrink: 0;
  }
  .student-card.selected .st-avatar { background: var(--primary-color); color: #fff; }

  .st-info { display: flex; flex-direction: column; overflow: hidden; }
  .st-name { font-weight: 600; font-size: 15px; line-height: 1.2; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .st-uid { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.04); padding: 2px 6px; border-radius: 4px; align-self: flex-start; }

  .st-footer { margin-top: auto; display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px solid #f3f4f6; }
  
  /* Ğ¡ĞºÑ€Ñ‹Ñ‚Ñ‹Ğ¹ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑ, Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµĞ¼ Ñ‡ĞµÑ€ĞµĞ· ĞºĞ»Ğ°ÑÑ .selected Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»Ñ */
  .st-checkbox { width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer; }
  
  .btn-quick-status {
    background: #fff;
    border: 1px solid var(--border-color);
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    display: flex; align-items: center; gap: 6px;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-quick-status:hover { background: #f9fafb; color: var(--text-primary); border-color: #d1d5db; }
  
  /* ĞŸĞ ĞĞ’ĞĞ¯ ĞŸĞĞĞ•Ğ›Ğ¬ (Sticky) */
  .control-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .panel-section-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    font-weight: 700;
    margin-bottom: 10px;
    display: flex; align-items: center; justify-content: space-between;
  }

  /* Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¿Ğ°Ñ€Ğ° */
  .current-lesson-card {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    color: white;
    padding: 16px;
    border-radius: var(--radius-md);
    margin-bottom: 8px;
  }
  .cl-label { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.05em; }
  .cl-title { font-size: 16px; font-weight: 700; margin: 4px 0 2px; }
  .cl-time { font-size: 13px; font-weight: 500; opacity: 0.9; }

  /* Toggle Switch (Select All) */
  .toggle-label {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; font-weight: 500; cursor: pointer;
  }

  /* Period Chips */
  .periods-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
  .period-chip {
    display: inline-flex;
    cursor: pointer;
    position: relative;
  }
  .period-chip input { display: none; }
  .period-chip span {
    padding: 6px 12px;
    background: #f3f4f6;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    transition: 0.2s;
    border: 1px solid transparent;
  }
  .period-chip input:checked + span {
    background: var(--text-primary);
    color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* Status Selector Grid */
  .status-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  
  .status-option { cursor: pointer; position: relative; }
  .status-option input { display: none; }
  
  .status-box {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: #fff;
    transition: 0.2s;
    height: 100%;
  }
  .status-box i { font-size: 18px; margin-bottom: 4px; }
  .status-box span { font-size: 12px; font-weight: 600; }

  /* Ğ¦Ğ²ĞµÑ‚Ğ° Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ */
  .status-option input[value="present"]:checked + .status-box { background: #ecfdf5; border-color: var(--color-present); color: var(--color-present); }
  .status-option input[value="late"]:checked + .status-box { background: #fffbeb; border-color: var(--color-late); color: var(--color-late); }
  .status-option input[value="absent"]:checked + .status-box { background: #fef2f2; border-color: var(--color-absent); color: var(--color-absent); }
  .status-option input[value="excused"]:checked + .status-box { background: #eff6ff; border-color: var(--color-excused); color: var(--color-excused); }

  .btn-submit-bulk {
    width: 100%;
    padding: 12px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
    transition: 0.2s;
    margin-top: 10px;
  }
  .btn-submit-bulk:hover { background: var(--primary-hover); transform: translateY(-1px); }

  /* ĞœĞµĞ½Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° (Dropdown) */
  .popover-menu {
    position: absolute;
    bottom: 45px; right: 0; /* ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ğ²ĞµÑ€Ñ…, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑƒÑ…Ğ¾Ğ´Ğ¸Ğ»Ğ¾ Ğ·Ğ° ÑĞºÑ€Ğ°Ğ½ */
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 50;
    min-width: 180px;
    display: none;
    padding: 4px;
    animation: fadeIn 0.15s ease;
  }
  .popover-menu.open { display: block; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

  .popover-item {
    width: 100%; text-align: left;
    background: transparent; border: none;
    padding: 8px 12px;
    font-size: 13px; font-weight: 500; color: var(--text-primary);
    cursor: pointer; border-radius: 6px;
    display: flex; align-items: center; gap: 8px;
  }
  .popover-item:hover { background: #f3f4f6; }
  
  .reason-select {
    width: 100%;
    margin-top: 8px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 13px;
    background: #fff;
  }

</style>

<div class="page-header">
  <div class="page-title">
    <h1>ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ° Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ°</h1>
    <span>Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ: {{ today }}</span>
  </div>

  <form method="get" action="{{ url_for('checkin_bp.checkin_page') }}">
    <select class="filter-select" name="g" onchange="this.form.requestSubmit()">
      <option value="" {{ (selected_group or '') == '' and 'selected' or '' }}>Ğ’ÑĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹</option>
      {% for g in groups_available or [] %}
        <option value="{{ g }}" {{ g == (selected_group or '') and 'selected' or '' }}>{{ g }}</option>
      {% endfor %}
    </select>
  </form>
</div>

<form action="{{ url_for('checkin_bp.do_checkin_bulk') }}" method="post" id="bulkForm">
<input type="hidden" name="g" value="{{ selected_group or '' }}">

<div class="layout-grid">
  
  <div>
    {% if students|length == 0 %}
      <div style="text-align:center; padding: 40px; color: var(--text-secondary);">
        ĞĞµÑ‚ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ. Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ.
      </div>
    {% endif %}

    <div class="students-grid" id="studentsBox">
      {% for s in students %}
      <div class="student-card" onclick="toggleCard(this)" data-id="{{ s.id }}">
        <div class="st-header">
          <div class="st-avatar">{{ s.full_name[:1] }}</div>
          <div class="st-info">
            <span class="st-name" title="{{ s.full_name }}">{{ s.full_name }}</span>
            <span class="st-uid">{{ s.uid }}</span>
          </div>
        </div>

        <div class="st-footer">
          <label class="toggle-label" onclick="event.stopPropagation()">
             <input type="checkbox" class="st-checkbox" name="student_ids" value="{{ s.id }}">
             <span style="font-size:12px; color:var(--text-secondary);">Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ</span>
          </label>

          <div style="position:relative;">
            <button type="button" class="btn-quick-status" onclick="toggleMenu(event, 'menu-{{ s.id }}')">
              Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ... â–¾
            </button>
            
            <div class="popover-menu" id="menu-{{ s.id }}" onclick="event.stopPropagation()">
               <button type="button" class="popover-item" data-status="present" onclick="quickStatus(this)">
                 <span style="color:var(--color-present)">â—</span> ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»
               </button>
               <button type="button" class="popover-item" data-status="late" onclick="quickStatus(this)">
                 <span style="color:var(--color-late)">â—</span> ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»
               </button>
               <button type="button" class="popover-item" data-status="absent" onclick="quickStatus(this)">
                 <span style="color:var(--color-absent)">â—</span> ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»
               </button>
               <button type="button" class="popover-item" data-status="excused" data-ask-reason="1" onclick="quickStatus(this)">
                 <span style="color:var(--color-excused)">â—</span> Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ
               </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <aside class="control-panel">
    
    {% if current_index is not none and current_index >= 0 and current_index < schedule|length %}
      {% set p = schedule[current_index] %}
      <div class="current-lesson-card" id="currentLessonInfo">
        <div class="cl-label">Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ¸Ğ´ĞµÑ‚</div>
        <div class="cl-title">{{ p.title }}</div>
        <div class="cl-time">{{ p.start }} â€“ {{ p.end }}</div>
      </div>
      <div id="has-current" data-value="1" style="display:none;"></div>
    {% else %}
      <div style="background:#f3f4f6; border-radius:12px; padding:16px; text-align:center; color:var(--text-secondary);">
        <div style="font-weight:600; font-size:14px;">ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹</div>
        <div style="font-size:12px;">Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½</div>
      </div>
      <div id="has-current" data-value="0" style="display:none;"></div>
    {% endif %}

    <div>
      <div class="panel-section-title">
        <span>ĞšĞ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ?</span>
        <label class="toggle-label" style="text-transform:none; font-weight:400;">
          <input type="checkbox" id="allStudents"> Ğ’ÑĞµÑ…
        </label>
      </div>
      <div style="font-size:12px; color:var(--text-secondary); line-height:1.4;">
        Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¸Ğ· ÑĞ¿Ğ¸ÑĞºĞ° ÑĞ»ĞµĞ²Ğ° Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«Ğ’ÑĞµÑ…Â».
      </div>
    </div>

    <div>
      <div class="panel-section-title">
        <span>ĞĞ° ĞºĞ°ĞºĞ¸Ğµ Ğ¿Ğ°Ñ€Ñ‹?</span>
        <label class="toggle-label" style="text-transform:none; font-weight:400;">
           <input type="checkbox" id="allPeriods"> Ğ’ÑĞµ
        </label>
      </div>
      <div class="periods-wrap">
        {% for p in schedule %}
          {% if p.code.startswith('p') %}
            <label class="period-chip" title="{{ p.start }}â€“{{ p.end }}">
              <input type="checkbox" name="period_codes" value="{{ p.code }}">
              <span>{{ p.title }}</span>
            </label>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div>
      <div class="panel-section-title">ĞšĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ?</div>
      <div class="status-selector">
        <label class="status-option">
          <input type="radio" name="status" value="present">
          <div class="status-box"><i>âœ“</i><span>Ğ‘Ñ‹Ğ»</span></div>
        </label>
        <label class="status-option">
          <input type="radio" name="status" value="late">
          <div class="status-box"><i>â±</i><span>ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»</span></div>
        </label>
        <label class="status-option">
          <input type="radio" name="status" value="absent">
          <div class="status-box"><i>â›”</i><span>Ğ/Ğ‘</span></div>
        </label>
        <label class="status-option">
          <input type="radio" name="status" value="excused" id="excusedBulk">
          <div class="status-box"><i>ğŸ“</i><span>Ğ£Ğ²Ğ°Ğ¶.</span></div>
        </label>
      </div>
      
      <select name="reason" id="bulkReason" class="reason-select" disabled>
        <option value="">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ...</option>
        {% for r in excused_reasons %}
          <option value="{{ r }}">{{ r|capitalize }}</option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn-submit-bulk">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    <button type="reset" class="btn-quick-status" style="justify-content:center; width:100%; border:none;">Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
    
  </aside>
</div>
</form>

<script>
  // --- Ğ›ĞĞ“Ğ˜ĞšĞ Ğ’Ğ«Ğ‘ĞĞ Ğ ĞšĞĞ Ğ¢ĞĞ§Ğ•Ğš ---
  
  // ĞšĞ»Ğ¸Ğº Ğ¿Ğ¾ Ğ²ÑĞµĞ¹ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞµ (ĞºÑ€Ğ¾Ğ¼Ğµ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº) Ğ²ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑ
  function toggleCard(card) {
    const checkbox = card.querySelector('.st-checkbox');
    checkbox.checked = !checkbox.checked;
    updateCardVisual(card, checkbox.checked);
  }

  // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¸Ğ»Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ°
  function updateCardVisual(card, isChecked) {
    if(isChecked) card.classList.add('selected');
    else card.classList.remove('selected');
  }

  // ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ»Ğ¸ĞºĞ° Ğ¿Ğ¾ ÑĞ°Ğ¼Ğ¾Ğ¼Ñƒ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑÑƒ (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ±Ñ‹Ğ»Ğ¾ Ğ´Ğ²Ğ¾Ğ¹Ğ½Ğ¾Ğ³Ğ¾ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ)
  document.querySelectorAll('.st-checkbox').forEach(cb => {
    cb.addEventListener('click', (e) => {
      e.stopPropagation(); // Ğ½Ğµ Ğ²ÑĞ¿Ğ»Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ¾ toggleCard
      updateCardVisual(e.target.closest('.student-card'), e.target.checked);
    });
  });

  // "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµÑ… ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²"
  document.getElementById('allStudents')?.addEventListener('change', function() {
    const isChecked = this.checked;
    document.querySelectorAll('.student-card').forEach(card => {
       const cb = card.querySelector('.st-checkbox');
       cb.checked = isChecked;
       updateCardVisual(card, isChecked);
    });
  });

  // "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ Ğ¿Ğ°Ñ€Ñ‹"
  document.getElementById('allPeriods')?.addEventListener('change', function() {
    const isChecked = this.checked;
    document.querySelectorAll('input[name="period_codes"]').forEach(cb => cb.checked = isChecked);
  });

  // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° "ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹" Ğ´Ğ»Ñ Ğ¼Ğ°ÑÑĞ¾Ğ²Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸
  const excusedBulk = document.getElementById('excusedBulk');
  const bulkReason = document.getElementById('bulkReason');
  document.querySelectorAll('input[name="status"]').forEach(radio => {
    radio.addEventListener('change', () => {
      if (excusedBulk.checked) {
        bulkReason.disabled = false;
      } else {
        bulkReason.disabled = true;
        bulkReason.value = "";
      }
    });
  });


  // --- Ğ›ĞĞ“Ğ˜ĞšĞ Ğ‘Ğ«Ğ¡Ğ¢Ğ ĞĞ“Ğ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡Ğ (AJAX) ---
  
  const HAS_CURRENT = document.getElementById('has-current')?.getAttribute('data-value') === '1';

  function toggleMenu(event, menuId) {
    event.stopPropagation();
    // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ
    document.querySelectorAll('.popover-menu.open').forEach(m => {
       if(m.id !== menuId) m.classList.remove('open');
    });
    const menu = document.getElementById(menuId);
    menu.classList.toggle('open');
  }

  // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¼ĞµĞ½Ñ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ
  document.addEventListener('click', () => {
    document.querySelectorAll('.popover-menu.open').forEach(m => m.classList.remove('open'));
  });

  async function quickStatus(btn) {
    if (!HAS_CURRENT) {
      alert('ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹. Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½.');
      return;
    }

    const status = btn.dataset.status;
    const askReason = btn.dataset.askReason === '1';
    
    // ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ ID ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°
    // btn -> popover -> div(wrapper) -> footer -> card
    // ĞĞ¾ Ñƒ Ğ½Ğ°Ñ btn Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¼ĞµĞ½Ñ, Ğ¼ĞµĞ½Ñ Ğ¿Ğ¾ ID ÑĞ²ÑĞ·Ğ°Ğ½Ğ¾. ĞŸÑ€Ğ¾Ñ‰Ğµ Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ğ±Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ .student-card ĞµÑĞ»Ğ¸ Ğ¼ĞµĞ½Ñ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ DOM ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸
    const card = btn.closest('.student-card');
    const sid = card.dataset.id;
    
    let reason = '';
    if (askReason) {
      reason = prompt('Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ (sick/family/other):', 'sick');
      if (reason === null) return; // Cancel
    }
    
    // Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¼ĞµĞ½Ñ
    btn.closest('.popover-menu').classList.remove('open');

    // Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ (Ğ¼Ğ¸Ğ³Ğ°Ğ½Ğ¸Ğµ)
    card.style.opacity = '0.7';

    let fd = new FormData();
    fd.append('student_id', sid);
    fd.append('status', status);
    if(reason) fd.append('reason', reason);

    try {
      const res = await fetch('{{ url_for("checkin_bp.do_checkin_quick") }}', { method:'POST', body: fd });
      const j = await res.json();
      if(!res.ok || !j.ok) throw new Error(j.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°');
      
      // Ğ£ÑĞ¿ĞµÑ… - Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¼Ğ¸Ğ³Ğ½ÑƒÑ‚ÑŒ Ğ·ĞµĞ»ĞµĞ½Ñ‹Ğ¼ Ğ±Ğ¾Ñ€Ğ´ĞµÑ€Ğ¾Ğ¼
      const originalBorder = card.style.borderColor;
      card.style.borderColor = 'var(--color-present)';
      setTimeout(() => { card.style.borderColor = ''; card.style.opacity = '1'; }, 600);
      
    } catch(err) {
      alert('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + err.message);
      card.style.opacity = '1';
    }
  }

</script>

{% endblock %}
--- FILE: .\templates\complaints.html ---
{% extends "base.html" %}
{% block title %}Ğ–Ğ°Ğ»Ğ¾Ğ±Ñ‹{% endblock %}
{% block content %}

<h1>Ğ–Ğ°Ğ»Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ€Ğ¾ÑÑ‚Ñ‹</h1>

<ul id="complaints-list" class="c-list">
  {% for c in items %}
    <li data-id="{{ c.id }}" class="c-item">
      <div class="c-row">
        <strong>{{ c.target_name }}</strong>
        <span class="muted">ĞŸĞ°Ñ€Ğ°: {{ c.period_index }}</span>
        <span class="muted">{{ c.created_at.strftime("%Y-%m-%d %H:%M:%S") }}</span>
      </div>
      <div class="c-reason">{{ c.reason|e }}</div>
    </li>
  {% else %}
    <li class="muted">ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¶Ğ°Ğ»Ğ¾Ğ±</li>
  {% endfor %}
</ul>

<!-- ĞœĞ¾Ğ´Ğ°Ğ»ĞºĞ° -->
<div id="modal" class="modal" style="display:none;">
  <div class="modal__backdrop"></div>
  <div class="modal__content">
    <h3 id="m-title">Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ°</h3>
    <div class="m-line"><b>ĞĞ° ĞºĞ¾Ğ³Ğ¾:</b> <span id="m-target"></span></div>
    <div class="m-line"><b>ĞŸĞ°Ñ€Ğ°:</b> <span id="m-period"></span></div>
    <div class="m-line"><b>ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°:</b> <span id="m-reason"></span></div>
    <div class="m-line"><b>ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ:</b> <span id="m-from"></span></div>
    <div class="m-line"><b>Ğ’Ñ€ĞµĞ¼Ñ:</b> <span id="m-time"></span></div>
    <div class="actions">
      <button id="m-close" class="btn">Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" style="display:none;"></div>

<style>
.c-list{list-style:none;padding:0;margin:16px 0;display:grid;gap:10px;}
.c-item{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;cursor:pointer;}
.c-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:6px;}
.c-reason{color:#111;}
.muted{color:#6b7280}
.toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.2);}
.modal{position:fixed;inset:0;display:block;}
.modal[style*="display: none"]{display:none;}
.modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.35);}
.modal__content{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(560px,90vw);background:#fff;border-radius:16px;padding:18px;border:1px solid #e5e7eb;}
.btn{background:#2563eb;color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer;}
.actions{display:flex;justify-content:flex-end;margin-top:12px;}
</style>

<script>
(function(){
  const list = document.getElementById('complaints-list');
  const toast = document.getElementById('toast');
  const modal = document.getElementById('modal');
  const mTitle = document.getElementById('m-title');
  const mTarget = document.getElementById('m-target');
  const mPeriod = document.getElementById('m-period');
  const mReason = document.getElementById('m-reason');
  const mFrom = document.getElementById('m-from');
  const mTime = document.getElementById('m-time');
  const mClose = document.getElementById('m-close');

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display='none', 3500);
  }

  function openModal(c){
    mTitle.textContent = 'Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° #' + c.id;
    mTarget.textContent = c.target_name;
    mPeriod.textContent = c.period_index;
    mReason.textContent = c.reason;
    mFrom.textContent = c.from_name;
    mTime.textContent = new Date(c.created_at).toLocaleString();
    modal.style.display = 'block';
  }
  mClose.addEventListener('click', ()=> modal.style.display='none');
  modal.querySelector('.modal__backdrop').addEventListener('click', ()=> modal.style.display='none');

  // ĞšĞ»Ğ¸Ğº Ğ¿Ğ¾ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğ¼
  list.addEventListener('click', (e)=>{
    const li = e.target.closest('.c-item');
    if(!li) return;
    const c = {
      id: li.dataset.id,
      target_name: li.querySelector('strong')?.textContent || '',
      period_index: (li.querySelector('.muted')?.textContent || '').replace(/^.*?:\s*/,''),
      reason: li.querySelector('.c-reason')?.textContent || '',
      from_name: '', created_at: ''
    };
    openModal(c);
  });

  // ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ SSE Ğ´Ğ»Ñ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ¶Ğ°Ğ»Ğ¾Ğ±
  const es = new EventSource('/complaints/stream');
  es.addEventListener('ping', ()=>{});
  es.onmessage = (ev)=>{
    try{
      const c = JSON.parse(ev.data);
      // Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ¾ ÑĞ¿Ğ¸ÑĞºĞ°
      const li = document.createElement('li');
      li.className = 'c-item';
      li.dataset.id = c.id;
      li.innerHTML = `
        <div class="c-row">
          <strong>${c.target_name}</strong>
          <span class="muted">ĞŸĞ°Ñ€Ğ°: ${c.period_index}</span>
          <span class="muted">${new Date(c.created_at).toLocaleString()}</span>
        </div>
        <div class="c-reason">${c.reason}</div>
      `;
      list.prepend(li);
      showToast('Ğš Ğ²Ğ°Ğ¼ Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ñ‹');
      // Ğ¿Ğ¾ Ğ¶ĞµĞ»Ğ°Ğ½Ğ¸Ñ â€” ÑÑ€Ğ°Ğ·Ñƒ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ĞºÑƒ:
      // openModal(c);
    }catch(e){ console.error(e); }
  };
})();
</script>
{% endblock %}

--- FILE: .\templates\curator_group.html ---
{% extends "base.html" %}
{% block title %}Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°: {{ group }}{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

<style>
  :root {
    --font-main: 'Inter', sans-serif;
    --bg-page: #f3f4f6;
    --bg-card: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --excel-color: #10b981; /* Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¹ Ğ´Ğ»Ñ Excel */
    --excel-hover: #059669;

    --radius-md: 12px;
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
  }

  body { background: var(--bg-page); color: var(--text-primary); font-family: var(--font-main); }

  /* --- Ğ—ĞĞ“ĞĞ›ĞĞ’ĞĞš Ğ¡Ğ¢Ğ ĞĞĞ˜Ğ¦Ğ« --- */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-title h1 { font-size: 24px; font-weight: 700; margin: 0; }
  .page-title .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }

  /* ĞšĞ½Ğ¾Ğ¿ĞºĞ° Excel */
  .btn-excel {
    background-color: var(--excel-color);
    color: white;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: 0.2s;
    border: none;
    box-shadow: var(--shadow-sm);
  }
  .btn-excel:hover { background-color: var(--excel-hover); transform: translateY(-1px); color: white; }
  .btn-excel i { font-size: 16px; }

  /* --- ĞŸĞĞĞ•Ğ›Ğ¬ Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ ĞĞ’ --- */
  .filters-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 16px;
  }

  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
  
  .form-control {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    background: #fff;
    min-width: 140px;
  }
  .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

  .btn-show {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 9px 20px; /* Ğ§ÑƒÑ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¿Ğ°Ğ´Ğ´Ğ¸Ğ½Ğ³ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ñ‹Ñ€Ğ¾Ğ²Ğ½ÑÑ‚ÑŒ Ğ²Ñ‹ÑĞ¾Ñ‚Ñƒ Ñ Ğ¸Ğ½Ğ¿ÑƒÑ‚Ğ°Ğ¼Ğ¸ */
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-show:hover { background: var(--primary-hover); }

  .period-badge {
    margin-left: auto; /* ĞÑ‚Ğ¾Ğ´Ğ²Ğ¸Ğ³Ğ°ĞµÑ‚ Ğ²Ğ¿Ñ€Ğ°Ğ²Ğ¾ */
    background: #f3f4f6;
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 99px;
    font-size: 13px;
    font-weight: 500;
    border: 1px solid var(--border-color);
  }
  @media (max-width: 768px) { .period-badge { margin-left: 0; width: 100%; text-align: center; } }

  /* --- Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ --- */
  .table-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  .table-responsive {
    overflow-x: auto;
    scrollbar-width: thin;
  }

  .stats-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    white-space: nowrap;
  }

  /* Ğ¨Ğ°Ğ¿ĞºĞ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ */
  .stats-table thead th {
    background: #f9fafb;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
    vertical-align: middle;
  }
  /* Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»Ğ¸ Ğ² ÑˆĞ°Ğ¿ĞºĞµ */
  .stats-table thead th { border-right: 1px solid #e5e7eb; }
  .stats-table thead th:last-child { border-right: none; }

  /* Ğ¢ĞµĞ»Ğ¾ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ */
  .stats-table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    text-align: center;
  }
  .stats-table td:nth-child(2) { text-align: left; font-weight: 500; } /* Ğ˜Ğ¼Ñ ÑĞ»ĞµĞ²Ğ° */
  
  .stats-table tbody tr:hover { background: #f8fafc; }

  /* ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ° "Ğ’ÑĞµĞ³Ğ¾" */
  .col-total { font-weight: 700; color: var(--primary-color); background: #fbfbfe; }
  
  /* ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ° "ĞĞµÑƒĞ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ" */
  .col-danger { color: #dc2626; background: #fef2f2; font-weight: 600; }

  /* Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° Ğ˜Ñ‚Ğ¾Ğ³Ğ¾ */
  .tr-summary td {
    background: #eff6ff; /* Ğ¡Ğ²ĞµÑ‚Ğ»Ğ¾-ÑĞ¸Ğ½Ğ¸Ğ¹ Ñ„Ğ¾Ğ½ */
    font-weight: 700;
    border-top: 2px solid #dbeafe;
    color: #1e3a8a;
  }

  .empty-state { padding: 40px; text-align: center; color: var(--text-secondary); }

</style>

<div class="page-header">
  <div class="page-title">
    <h1>Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° {{ group }}</h1>
    <div class="subtitle">Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸</div>
  </div>
  
  <a class="btn-excel" href="{{ url_for('head_bp.group_export_excel', g=group, day=day.isoformat(), mode=mode) }}">
    <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
    Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Excel
  </a>
</div>

<form class="filters-card" method="get" action="{{ url_for('curator_bp.group_view') }}">
  <input type="hidden" name="g" value="{{ group }}">

  <div class="form-group">
    <label class="form-label">Ğ”Ğ°Ñ‚Ğ° Ğ¾Ñ‚ÑÑ‡ĞµÑ‚Ğ°</label>
    <input type="date" name="day" value="{{ day.isoformat() }}" class="form-control">
  </div>

  <div class="form-group">
    <label class="form-label">ĞŸĞµÑ€Ğ¸Ğ¾Ğ´</label>
    <select name="mode" class="form-control">
      <option value="day" {% if mode == 'day' %}selected{% endif %}>Ğ”ĞµĞ½ÑŒ</option>
      <option value="month" {% if mode == 'month' %}selected{% endif %}>ĞœĞµÑÑÑ†</option>
      <option value="semester" {% if mode == 'semester' %}selected{% endif %}>Ğ¡ĞµĞ¼ĞµÑÑ‚Ñ€</option>
    </select>
  </div>

  <button type="submit" class="btn-show">ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ</button>

  <div class="period-badge">
    ĞŸĞµÑ€Ğ¸Ğ¾Ğ´: {{ start.strftime('%d.%m.%Y') }} â€” {{ end.strftime('%d.%m.%Y') }}
  </div>
</form>

<div class="table-card">
  {% if detail.rows|length == 0 %}
    <div class="empty-state">
      <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“Š</div>
      ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ·Ğ° Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´.
    </div>
  {% else %}
    <div class="table-responsive">
      <table class="stats-table">
        <thead>
          <tr>
            <th rowspan="2" style="width: 50px;">â„–</th>
            <th rowspan="2" style="text-align: left;">Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚</th>
            <th rowspan="2" class="col-total" style="width: 100px;">Ğ’ÑĞµĞ³Ğ¾<br>(Ñ‡Ğ°ÑĞ¾Ğ²)</th>
            <th colspan="5" style="border-bottom: 0;">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¾Ğ²</th>
            <th rowspan="2" style="width: 80px;">%</th>
          </tr>
          <tr>
            <th>Ğ—Ğ°ÑĞ²Ğ»ĞµĞ½Ğ¸Ğµ</th>
            <th>Ğ‘Ğ¾Ğ»ĞµĞ·Ğ½ÑŒ</th>
            <th>Ğ¡Ğ¾Ñ€ĞµĞ²Ğ½.</th>
            <th>Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ</th>
            <th class="col-danger">ĞĞµÑƒĞ²Ğ°Ğ¶.</th>
          </tr>
        </thead>
        <tbody>
          {% for row in detail.rows %}
          <tr>
            <td>{{ row.num }}</td>
            <td>{{ row.full_name }}</td>
            <td class="col-total">{{ row.total }}</td>
            
            <td>{% if row.statement > 0 %}{{ row.statement }}{% else %}<span style="color:#d1d5db">â€”</span>{% endif %}</td>
            <td>{% if row.sick > 0 %}{{ row.sick }}{% else %}<span style="color:#d1d5db">â€”</span>{% endif %}</td>
            <td>{% if row.competition > 0 %}{{ row.competition }}{% else %}<span style="color:#d1d5db">â€”</span>{% endif %}</td>
            <td>{% if row.other > 0 %}{{ row.other }}{% else %}<span style="color:#d1d5db">â€”</span>{% endif %}</td>
            
            <td class="col-danger">{% if row.unexcused > 0 %}{{ row.unexcused }}{% else %}0{% endif %}</td>
            
            <td>
              {% set p = row.pct %}
              {% if p < 50 %}
                <span style="color: #dc2626; font-weight:700;">{{ '%.1f'|format(p) }}</span>
              {% elif p < 80 %}
                <span style="color: #d97706; font-weight:600;">{{ '%.1f'|format(p) }}</span>
              {% else %}
                <span style="color: #059669; font-weight:600;">{{ '%.1f'|format(p) }}</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          
          <tr class="tr-summary">
            <td colspan="8" style="text-align: right; padding-right: 20px;">ĞĞ±Ñ‰Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:</td>
            <td>{{ '%.2f'|format(detail.group_pct) }}%</td>
          </tr>
        </tbody>
      </table>
    </div>
  {% endif %}
</div>

{% endblock %}
--- FILE: .\templates\curator_groups.html ---
{% extends "base.html" %}
{% block title %}ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€ â€” ĞœĞ¾Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
  :root {
    --bg-page: #f3f4f6;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5; /* Ğ˜Ğ½Ğ´Ğ¸Ğ³Ğ¾ */
    --primary-light: #eef2ff;
    --white: #ffffff;
    --border: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow-hover: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  }

  body {
    background: var(--bg-page);
    font-family: 'Inter', sans-serif;
    color: var(--text-primary);
  }

  .container {
    max-width: 1000px;
    margin: 40px auto;
    padding: 0 20px;
  }

  /* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº */
  .header-section {
    margin-bottom: 30px;
  }
  .header-section h2 {
    font-size: 28px;
    font-weight: 800;
    margin: 0 0 8px 0;
    color: var(--text-primary);
  }
  .header-section p {
    color: var(--text-secondary);
    font-size: 15px;
    margin: 0;
  }

  /* Ğ¡ĞµÑ‚ĞºĞ° Ğ³Ñ€ÑƒĞ¿Ğ¿ */
  .groups-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 20px;
  }

  /* ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ */
  .group-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }

  .group-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-hover);
    border-color: var(--primary-color);
  }

  /* Ğ˜ĞºĞ¾Ğ½ĞºĞ° Ğ² ĞºÑ€ÑƒĞ³Ğµ */
  .icon-wrapper {
    width: 48px;
    height: 48px;
    background: var(--primary-light);
    color: var(--primary-color);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-bottom: 16px;
    transition: 0.2s;
  }
  
  .group-card:hover .icon-wrapper {
    background: var(--primary-color);
    color: #fff;
  }

  .group-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
  }
  
  .group-sub {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .arrow-icon {
    position: absolute;
    top: 24px;
    right: 24px;
    color: var(--text-secondary);
    opacity: 0.5;
    transition: 0.2s;
  }
  .group-card:hover .arrow-icon {
    opacity: 1;
    color: var(--primary-color);
    transform: translateX(4px);
  }

  /* ĞŸÑƒÑÑ‚Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--white);
    border-radius: 16px;
    border: 1px dashed var(--border);
  }
  .empty-icon {
    font-size: 48px;
    color: #d1d5db;
    margin-bottom: 16px;
  }
  .empty-text {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-secondary);
    max-width: 400px;
    margin: 0 auto;
  }

</style>

<div class="container">
  
  <div class="header-section">
    <h2>Ğ’Ğ°ÑˆĞ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹</h2>
    <p>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸</p>
  </div>

  {% if groups|length == 0 %}
    <div class="empty-state">
      <div class="empty-icon">
        <i class="far fa-folder-open"></i>
      </div>
      <p class="empty-text">
        Ğš Ğ²Ğ°ÑˆĞµĞ¼Ñƒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾ĞºĞ° Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ²ÑĞ·Ğ°Ğ½Ñ‹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹. 
        <br>ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğº Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ñƒ Ğ´Ğ»Ñ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ.
      </p>
    </div>
  {% else %}
    <div class="groups-grid">
      {% for g in groups %}
        <a href="{{ url_for('curator_bp.group_view') }}?g={{ g }}" class="group-card">
          <i class="fas fa-arrow-right arrow-icon"></i>
          
          <div class="icon-wrapper">
            <i class="fas fa-users"></i>
          </div>
          
          <div class="group-name">{{ g }}</div>
          <div class="group-sub">ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞµ</div>
        </a>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}
--- FILE: .\templates\head_group.html ---
{% extends "base.html" %}
{% block title %}Ğ—Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰Ğ°Ñ â€” {{ group }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

<style>
  :root {
    --font-main: 'Inter', sans-serif;
    --bg-page: #f3f4f6;
    --bg-card: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --excel-color: #10b981;
    --excel-hover: #059669;

    --radius-md: 12px;
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);

    /* Ğ¦Ğ²ĞµÑ‚Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² */
    --color-present: #10b981;
    --color-late: #f59e0b;
    --color-absent: #ef4444;
    --color-excused: #3b82f6;
  }

  body { background: var(--bg-page); color: var(--text-primary); font-family: var(--font-main); }

  /* Ğ—ĞĞ“ĞĞ›ĞĞ’ĞĞš Ğ˜ EXCEL */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-title h1 { font-size: 24px; font-weight: 700; margin: 0; }
  .page-title .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }

  .btn-excel {
    background-color: var(--excel-color);
    color: white;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: 0.2s;
    border: none;
    box-shadow: var(--shadow-sm);
  }
  .btn-excel:hover { background-color: var(--excel-hover); transform: translateY(-1px); color: white; }

  /* ĞŸĞĞĞ•Ğ›Ğ¬ Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ ĞĞ’ */
  .filters-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    margin-bottom: 24px;
    display: flex;
    flex-wrap: wrap;
    align-items: flex-end;
    gap: 16px;
  }

  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-label { font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; }
  
  .form-control {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
    background: #fff;
    min-width: 140px;
  }
  .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

  .btn-show {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 9px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-show:hover { background: var(--primary-hover); }

  .period-badge {
    margin-left: auto;
    background: #f3f4f6;
    color: var(--text-secondary);
    padding: 6px 12px;
    border-radius: 99px;
    font-size: 13px;
    font-weight: 500;
    border: 1px solid var(--border-color);
  }
  @media (max-width: 768px) { .period-badge { margin-left: 0; width: 100%; text-align: center; } }


  /* Ğ¡Ğ•Ğ¢ĞšĞ ĞšĞĞĞ¢Ğ•ĞĞ¢Ğ */
  .grid-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    align-items: start;
    margin-bottom: 24px;
  }
  @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }

  /* ĞšĞĞ Ğ¢ĞĞ§ĞšĞ ĞĞ‘Ğ©ĞĞ¯ */
  .card-box {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 20px;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    height: 100%;
  }
  .card-title {
    font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary);
    padding-bottom: 12px; border-bottom: 1px solid var(--border-color);
  }

  /* Ğ¡Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° (Ğ²Ğ²ĞµÑ€Ñ…Ñƒ) */
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  .summary-table td, .summary-table th { padding: 8px 12px; border-bottom: 1px solid #f3f4f6; }
  .summary-table tr:last-child td { border-bottom: none; }
  .st-val { font-weight: 600; text-align: right; }
  .st-pct { font-weight: 700; text-align: right; width: 60px; }
  
  /* Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° */
  .chart-wrapper {
    position: relative;
    height: 220px;
    width: 100%;
    display: flex;
    justify-content: center;
  }

  /* Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ« Ğ”Ğ•Ğ¢ĞĞ›Ğ¬ĞĞ«Ğ• */
  .table-responsive {
    overflow-x: auto;
    scrollbar-width: thin;
    background: #fff;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
  }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap;
  }
  
  .data-table th {
    background: #f9fafb;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
  }
  .data-table th:first-child, .data-table td:first-child { text-align: center; } /* ĞĞ¾Ğ¼ĞµÑ€ */
  .data-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    text-align: center;
  }
  .data-table td:nth-child(2) { text-align: left; font-weight: 500; min-width: 180px; } /* Ğ˜Ğ¼Ñ */
  
  .data-table tr:hover { background: #f8fafc; }

  /* Ğ¦Ğ²ĞµÑ‚Ğ° Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ */
  .col-total { font-weight: 700; color: var(--primary-color); background: #fbfbfe; }
  .col-danger { color: #dc2626; background: #fef2f2; font-weight: 600; }
  .tr-summary td { background: #eff6ff; font-weight: 700; color: #1e3a8a; }

  /* Ğ–ÑƒÑ€Ğ½Ğ°Ğ» (Ğ¿Ñ€Ğ°Ğ²Ğ°Ñ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ°) */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    margin-right: 4px;
    margin-bottom: 4px;
    background: #f3f4f6; color: #6b7280;
  }
  .badge.present { background: #d1fae5; color: #065f46; }
  .badge.late { background: #fef3c7; color: #92400e; }
  .badge.absent { background: #fee2e2; color: #991b1b; }
  .badge.excused { background: #dbeafe; color: #1e40af; }
  .badge .reason { font-weight: 400; opacity: 0.8; margin-left: 4px; }

</style>

<div class="page-header">
  <div class="page-title">
    <h1>Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ° {{ group }}</h1>
    <div class="subtitle">Ğ¡Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»</div>
  </div>
  
  <a class="btn-excel" href="{{ url_for('head_bp.group_export_excel', g=group, day=day.isoformat(), mode=mode) }}">
    <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
    Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Excel
  </a>
</div>

<form class="filters-card" method="get" action="{{ url_for('head_bp.group_view') }}">
  <input type="hidden" name="g" value="{{ group }}">

  <div class="form-group">
    <label class="form-label">Ğ”ĞµĞ½ÑŒ</label>
    <input type="date" name="day" value="{{ day.isoformat() }}" class="form-control">
  </div>

  <div class="form-group">
    <label class="form-label">Ğ ĞµĞ¶Ğ¸Ğ¼</label>
    <select name="mode" class="form-control">
      <option value="day" {{ 'selected' if mode=='day' else '' }}>Ğ”ĞµĞ½ÑŒ</option>
      <option value="month" {{ 'selected' if mode=='month' else '' }}>ĞœĞµÑÑÑ†</option>
      <option value="semester" {{ 'selected' if mode=='semester' else '' }}>Ğ¡ĞµĞ¼ĞµÑÑ‚Ñ€</option>
    </select>
  </div>

  <button type="submit" class="btn-show">ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ</button>

  <div class="period-badge">
    ĞŸĞµÑ€Ğ¸Ğ¾Ğ´: {{ start.strftime('%d.%m.%Y') }} â€” {{ end.strftime('%d.%m.%Y') }}
  </div>
</form>

<div class="grid-layout">
  
  <div class="card-box" style="display:flex; flex-direction:column; align-items:center;">
    <div class="card-title" style="width:100%; text-align:left;">Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸</div>
    <div class="chart-wrapper">
      <canvas id="chart1"
        data-chart='{{ {
          "labels": ["ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»","ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»","ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»","Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ"],
          "datasets": [{
            "data": [
              stats.counts.present|default(0),
              stats.counts.late|default(0),
              stats.counts.absent|default(0),
              stats.counts.excused|default(0)
            ],
            "backgroundColor": ["#10b981", "#f59e0b", "#ef4444", "#3b82f6"],
            "borderWidth": 0
          }]
        } | tojson | safe }}'>
      </canvas>
    </div>
  </div>

  <div class="card-box">
    <div class="card-title">Ğ¡Ğ²Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ({{ mode=='day' and 'Ğ·Ğ° Ğ´ĞµĞ½ÑŒ' or mode=='month' and 'Ğ·Ğ° Ğ¼ĞµÑÑÑ†' or 'Ğ·Ğ° ÑĞµĞ¼ĞµÑÑ‚Ñ€' }})</div>
    <table class="summary-table">
      <tbody>
        <tr>
          <td><span style="color:var(--color-present)">â—</span> ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»</td>
          <td class="st-val">{{ stats.counts.present }}</td>
          <td class="st-pct">{{ '%.1f'|format(stats.pct.present) }}%</td>
        </tr>
        <tr>
          <td><span style="color:var(--color-late)">â—</span> ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»</td>
          <td class="st-val">{{ stats.counts.late }}</td>
          <td class="st-pct">{{ '%.1f'|format(stats.pct.late) }}%</td>
        </tr>
        <tr>
          <td><span style="color:var(--color-absent)">â—</span> ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»</td>
          <td class="st-val">{{ stats.counts.absent }}</td>
          <td class="st-pct">{{ '%.1f'|format(stats.pct.absent) }}%</td>
        </tr>
        <tr>
          <td><span style="color:var(--color-excused)">â—</span> Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ</td>
          <td class="st-val">{{ stats.counts.excused }}</td>
          <td class="st-pct">{{ '%.1f'|format(stats.pct.excused) }}%</td>
        </tr>
        <tr style="border-top: 2px solid #e5e7eb; font-weight:700;">
          <td>Ğ’ÑĞµĞ³Ğ¾ Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¾Ğº</td>
          <td class="st-val">{{ stats.total }}</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div class="grid-layout" style="align-items:stretch;">
  
  <div class="card-box" style="padding:0; overflow:hidden;">
    <div style="padding:16px 20px; border-bottom:1px solid var(--border-color); font-weight:700; background:#f9fafb;">
      Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°Ğ¼
    </div>
    
    {% if detail.rows|length == 0 %}
      <div style="padding:30px; text-align:center; color:var(--text-secondary);">ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</div>
    {% else %}
      <div class="table-responsive" style="border:none; border-radius:0;">
        <table class="data-table">
          <thead>
            <tr>
              <th rowspan="2">â„–</th>
              <th rowspan="2">Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚</th>
              <th rowspan="2" class="col-total">Ğ’ÑĞµĞ³Ğ¾<br>Ñ‡Ğ°ÑĞ¾Ğ²</th>
              <th colspan="5">ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ¾Ğ²</th>
              <th rowspan="2">%</th>
            </tr>
            <tr>
              <th>Ğ—Ğ°ÑĞ².</th>
              <th>Ğ‘Ğ¾Ğ».</th>
              <th>Ğ¡Ğ¾Ñ€ĞµĞ².</th>
              <th>Ğ”Ñ€.</th>
              <th class="col-danger">ĞĞµÑƒĞ²Ğ°Ğ¶.</th>
            </tr>
          </thead>
          <tbody>
            {% for row in detail.rows %}
            <tr>
              <td>{{ row.num }}</td>
              <td>{{ row.full_name }}</td>
              <td class="col-total">{{ row.total }}</td>
              <td>{{ row.statement or 0 }}</td>
              <td>{{ row.sick or 0 }}</td>
              <td>{{ row.competition or 0 }}</td>
              <td>{{ row.other or 0 }}</td>
              <td class="col-danger">{{ row.unexcused or 0 }}</td>
              <td>{{ '%.1f'|format(row.pct) }}</td>
            </tr>
            {% endfor %}
            <tr class="tr-summary">
              <td colspan="8" style="text-align:right;">Ğ¡Ñ€. % Ğ¿Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ:</td>
              <td>{{ '%.2f'|format(detail.group_pct) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

  <div class="card-box" style="padding:0; overflow:hidden;">
    <div style="padding:16px 20px; border-bottom:1px solid var(--border-color); font-weight:700; background:#f9fafb;">
      Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ·Ğ° {{ day.isoformat() }} (ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€)
    </div>

    {% if students|length == 0 %}
      <div style="padding:30px; text-align:center; color:var(--text-secondary);">ĞĞµÑ‚ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²</div>
    {% else %}
      <div class="table-responsive" style="border:none; border-radius:0;">
        <table class="data-table">
          <thead>
            <tr>
              <th>Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚</th>
              <th>ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ¸ Ğ¿Ğ°Ñ€</th>
            </tr>
          </thead>
          <tbody>
            {% for s in students %}
              {% set recs = day_map.get(s.id, []) %}
              <tr>
                <td style="text-align:left;">{{ s.full_name }}</td>
                <td style="text-align:left; white-space:normal;">
                  {% if recs|length == 0 %}
                    <span style="color:#9ca3af">â€”</span>
                  {% else %}
                    {% for r in recs %}
                      {% set status_cls = r.status if r.status in ['present','late','absent','excused'] else 'empty' %}
                      <span class="badge {{ status_cls }}">
                        {{ r.period_code|upper }}
                        {% if r.status == 'excused' and r.reason %}
                          <span class="reason">({{ r.reason }})</span>
                        {% endif %}
                      </span>
                    {% endfor %}
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% endif %}
  </div>

</div>

{% if skips|length %}
  <div class="card-box" style="margin-top:24px;">
    <div class="card-title">Ğ¡Ğ½ÑÑ‚Ñ‹Ğµ Ğ¿Ğ°Ñ€Ñ‹ ({{ day.isoformat() }})</div>
    <div style="display:flex; gap:8px;">
      {% for r in skips %}
        <span style="padding:4px 10px; background:#f3f4f6; border-radius:6px; color:#6b7280; font-weight:600; font-size:13px;">
          {{ r.period_code|upper }}
        </span>
      {% endfor %}
    </div>
  </div>
{% endif %}

<script>
  // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹
  (function () {
    const canvas = document.getElementById('chart1');
    if (!canvas) return;

    const raw = canvas.getAttribute('data-chart') || '{}';
    let data;
    try { data = JSON.parse(raw); } catch (e) { data = {}; }

    if (window.Chart && data && data.datasets) {
      new Chart(canvas, {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: false, // Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ñ€Ğ°ÑÑ‚ÑĞ³Ğ¸Ğ²Ğ°Ğ»Ğ°ÑÑŒ Ğ±ĞµÑĞºĞ¾Ğ½ĞµÑ‡Ğ½Ğ¾
          cutout: '65%', // Ğ‘ÑƒĞ±Ğ»Ğ¸Ğº Ğ¿Ğ¾Ñ‚Ğ¾Ğ½ÑŒÑˆĞµ
          plugins: {
            legend: { 
              position: 'bottom',
              labels: { usePointStyle: true, font: { family: 'Inter', size: 12 } }
            }
          }
        }
      });
    }
  })();
</script>

{% endblock %}
--- FILE: .\templates\head_groups.html ---
{% extends "base.html" %}
{% block title %}Ğ—Ğ°Ğ²ĞµĞ´ÑƒÑÑ‰Ğ°Ñ â€” Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
  :root {
    --bg-page: #f3f4f6;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5; /* Ğ˜Ğ½Ğ´Ğ¸Ğ³Ğ¾ */
    --primary-light: #eef2ff;
    --white: #ffffff;
    --border: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow-hover: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  }

  body {
    background: var(--bg-page);
    font-family: 'Inter', sans-serif;
    color: var(--text-primary);
  }

  .container {
    max-width: 1000px;
    margin: 40px auto;
    padding: 0 20px;
  }

  /* Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº */
  .header-section {
    margin-bottom: 30px;
  }
  .header-section h2 {
    font-size: 28px;
    font-weight: 800;
    margin: 0 0 8px 0;
    color: var(--text-primary);
  }
  .header-section p {
    color: var(--text-secondary);
    font-size: 15px;
    margin: 0;
  }

  /* Ğ¡ĞµÑ‚ĞºĞ° Ğ³Ñ€ÑƒĞ¿Ğ¿ */
  .groups-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 20px;
  }

  /* ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ */
  .group-card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: all 0.2s ease;
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }

  .group-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-hover);
    border-color: var(--primary-color);
  }

  /* Ğ˜ĞºĞ¾Ğ½ĞºĞ° Ğ² ĞºÑ€ÑƒĞ³Ğµ */
  .icon-wrapper {
    width: 48px;
    height: 48px;
    background: var(--primary-light);
    color: var(--primary-color);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    margin-bottom: 16px;
    transition: 0.2s;
  }
  
  .group-card:hover .icon-wrapper {
    background: var(--primary-color);
    color: #fff;
  }

  .group-name {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 4px;
  }
  
  .group-sub {
    font-size: 13px;
    color: var(--text-secondary);
  }

  .arrow-icon {
    position: absolute;
    top: 24px;
    right: 24px;
    color: var(--text-secondary);
    opacity: 0.5;
    transition: 0.2s;
  }
  .group-card:hover .arrow-icon {
    opacity: 1;
    color: var(--primary-color);
    transform: translateX(4px);
  }

  /* ĞŸÑƒÑÑ‚Ğ¾Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    background: var(--white);
    border-radius: 16px;
    border: 1px dashed var(--border);
  }
  .empty-icon {
    font-size: 48px;
    color: #d1d5db;
    margin-bottom: 16px;
  }
  .empty-text {
    font-size: 16px;
    font-weight: 500;
    color: var(--text-secondary);
    max-width: 400px;
    margin: 0 auto;
  }

</style>

<div class="container">
  
  <div class="header-section">
    <h2>Ğ“Ñ€ÑƒĞ¿Ğ¿Ñ‹ (ĞŸĞ)</h2>
    <p>Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¸ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ¾Ğ²</p>
  </div>

  {% if groups|length == 0 %}
    <div class="empty-state">
      <div class="empty-icon">
        <i class="far fa-folder-open"></i>
      </div>
      <p class="empty-text">
        ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾.
      </p>
    </div>
  {% else %}
    <div class="groups-grid">
      {% for g in groups %}
        <a href="{{ url_for('head_bp.group_view') }}?g={{ g }}" class="group-card">
          <i class="fas fa-arrow-right arrow-icon"></i>
          
          <div class="icon-wrapper">
            <i class="fas fa-layer-group"></i>
          </div>
          
          <div class="group-name">{{ g }}</div>
          <div class="group-sub">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ</div>
        </a>
      {% endfor %}
    </div>
  {% endif %}

</div>
{% endblock %}
--- FILE: .\templates\head_journal.html ---
{% extends "base.html" %}
{% block title %}Ğ–ÑƒÑ€Ğ½Ğ°Ğ» (ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€) â€” {{ group }}{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
  :root {
    --bg-page: #f3f4f6;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --primary-color: #4f46e5;
    --border-color: #e5e7eb;
    
    --radius-md: 12px;
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    
    /* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹ */
    --color-present-bg: #dcfce7; --color-present-text: #166534;
    --color-late-bg: #ffedd5; --color-late-text: #9a3412;
    --color-absent-bg: #fee2e2; --color-absent-text: #991b1b;
    --color-excused-bg: #dbeafe; --color-excused-text: #1e40af;
    --color-skip-bg: #f3f4f6; --color-skip-text: #9ca3af;
  }

  body { background: var(--bg-page); color: var(--text-primary); font-family: 'Inter', sans-serif; }

  /* Ğ—ĞĞ“ĞĞ›ĞĞ’ĞĞš Ğ˜ ĞĞĞ’Ğ˜Ğ“ĞĞ¦Ğ˜Ğ¯ */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-title h1 { font-size: 24px; font-weight: 700; margin: 0; }
  .page-title .subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
  
  .nav-form {
    display: flex;
    align-items: center;
    gap: 10px;
    background: #fff;
    padding: 6px 12px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }
  
  .date-input {
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 14px;
    background: #f9fafb;
    color: var(--text-primary);
  }
  
  .btn-action {
    background: var(--primary-color);
    color: #fff;
    border: none;
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-action:hover { background: #4338ca; }
  
  .btn-back {
    background: #fff;
    color: var(--text-secondary);
    border: 1px solid var(--border-color);
    padding: 7px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    text-decoration: none;
    display: flex; align-items: center; gap: 6px;
    transition: 0.2s;
  }
  .btn-back:hover { background: #f3f4f6; color: var(--text-primary); }

  /* Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ Ğ–Ğ£Ğ ĞĞĞ›Ğ */
  .journal-card {
    background: #fff;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    overflow: hidden;
    margin-bottom: 24px;
  }
  
  .table-responsive {
    overflow-x: auto;
    scrollbar-width: thin;
    max-height: 500px; /* Ğ’ĞµÑ€Ñ‚Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ ÑĞºÑ€Ğ¾Ğ»Ğ» ĞµÑĞ»Ğ¸ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² */
  }

  .journal-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap;
  }

  .journal-table thead th {
    position: sticky; top: 0; z-index: 10;
    background: #f9fafb;
    color: var(--text-secondary);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    text-align: center;
    box-shadow: 0 1px 0 rgba(0,0,0,0.05); /* Ğ¢ĞµĞ½ÑŒ Ğ¾Ñ‚ Ñ…ĞµĞ´ĞµÑ€Ğ° */
  }
  .journal-table thead th:nth-child(2), .journal-table thead th:nth-child(3) { text-align: left; } /* UID Ğ¸ Ğ¤Ğ˜Ğ */
  
  .journal-table tbody td {
    padding: 10px 16px;
    border-bottom: 1px solid #f3f4f6;
    color: var(--text-primary);
    vertical-align: middle;
  }
  .journal-table tbody tr:hover { background: #f8fafc; }

  .col-uid { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-secondary); }
  .col-name { font-weight: 500; }

  /* Ğ‘ĞµĞ¹Ğ´Ğ¶Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² */
  .badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    gap: 4px;
  }
  .badge.present { background: var(--color-present-bg); color: var(--color-present-text); }
  .badge.late { background: var(--color-late-bg); color: var(--color-late-text); }
  .badge.absent { background: var(--color-absent-bg); color: var(--color-absent-text); }
  .badge.excused { background: var(--color-excused-bg); color: var(--color-excused-text); }
  .badge.skip { background: var(--color-skip-bg); color: var(--color-skip-text); opacity: 0.7; }
  .badge.empty { color: #d1d5db; font-size: 16px; font-weight: 400; padding: 0; }

  .th-skipped { opacity: 0.5; text-decoration: line-through; }
  .reason-text { font-weight: 400; opacity: 0.7; margin-left: 4px; font-size: 10px; }


  /* ĞĞ˜Ğ–ĞĞ¯Ğ¯ Ğ¡Ğ•ĞšĞ¦Ğ˜Ğ¯ (Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° + Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³) */
  .grid-bottom {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 24px;
    align-items: start;
  }
  @media (max-width: 900px) { .grid-bottom { grid-template-columns: 1fr; } }

  .stats-card {
    background: #fff;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    padding: 20px;
  }
  .stats-card h3 {
    font-size: 15px; font-weight: 700; margin: 0 0 16px 0; color: var(--text-primary);
    padding-bottom: 10px; border-bottom: 1px solid #f3f4f6;
  }

  .chart-container { height: 220px; position: relative; width: 100%; display: flex; justify-content: center; }

  .legend {
    display: flex; flex-wrap: wrap; gap: 8px; margin-top: 16px; justify-content: center;
  }
  .legend-item {
    font-size: 11px; font-weight: 500; color: var(--text-secondary);
    display: flex; align-items: center; gap: 4px;
    background: #f9fafb; padding: 4px 8px; border-radius: 4px;
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  /* Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° */
  .rating-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .rating-table th { text-align: left; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; padding: 8px; border-bottom: 1px solid var(--border-color); }
  .rating-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; }
  .rating-val { font-weight: 700; color: var(--primary-color); }

</style>

<div class="page-header">
  <div class="page-title">
    <h1>Ğ–ÑƒÑ€Ğ½Ğ°Ğ»: {{ group }}</h1>
    <div class="subtitle">Ğ”Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ°: {{ selected_date }}</div>
  </div>

  <form class="nav-form" method="get" action="{{ url_for('head_bp.head_journal') }}">
    <input type="hidden" name="g" value="{{ group }}">
    <a class="btn-back" href="{{ url_for('head_bp.head_groups') }}">
      <i class="fas fa-arrow-left"></i> ĞĞ°Ğ·Ğ°Ğ´
    </a>
    <input class="date-input" type="date" name="d" value="{{ selected_date }}" max="{{ today }}" required />
    <button type="submit" class="btn-action">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>
</div>

<div class="journal-card">
  <div class="table-responsive">
    <table class="journal-table">
      <thead>
        <tr>
          <th>#</th>
          <th>UID</th>
          <th>Ğ¤Ğ˜Ğ Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°</th>
          {% for p in schedule %}
            {% set is_skipped = skipped_codes and (p.code in skipped_codes) and p.code.startswith('p') %}
            <th class="{% if is_skipped %}th-skipped{% endif %}">
              <div style="display:flex; flex-direction:column; align-items:center;">
                <span>{{ p.title }}</span>
                <span style="font-weight:400; font-size:10px; opacity:0.7;">{{ p.start }}â€“{{ p.end }}</span>
              </div>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in table %}
          <tr>
            <td style="text-align:center; color:var(--text-secondary);">{{ r.num }}</td>
            <td class="col-uid">{{ r.uid }}</td>
            <td class="col-name">{{ r.full_name }}</td>
            
            {% for c in r.cells %}
              {% set _raw = c.status or '' %}
              {% set _parts = _raw.split(':') %}
              {% set status_key = _parts[0] if _parts and _parts[0] else '' %}
              {% set _sub = _parts[1] if _parts|length > 1 else '' %}
              
              {% set label = "â€”" %}
              {% if status_key == 'present' %}{% set label = "Ğ‘Ñ‹Ğ»" %}{% endif %}
              {% if status_key == 'late' %}{% set label = "ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»" %}{% endif %}
              {% if status_key == 'absent' %}{% set label = "Ğ/Ğ‘" %}{% endif %}
              {% if status_key == 'excused' %}{% set label = "Ğ£Ğ²Ğ°Ğ¶." %}{% endif %}
              {% if status_key == 'skip' %}{% set label = "ĞĞµÑ‚ Ğ¿Ğ°Ñ€Ñ‹" %}{% endif %}

              <td style="text-align:center;">
                {% if status_key and status_key != 'empty' %}
                   <span class="badge {{ status_key }}">
                     {{ label }}
                     {% if _sub and status_key == 'excused' %}
                       <span class="reason-text">({{ _sub|capitalize }})</span>
                     {% endif %}
                     {% if c.mark %} <span class="reason-text">Â· {{ c.mark }}</span> {% endif %}
                   </span>
                {% else %}
                   <span class="badge empty">Â·</span>
                {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="grid-bottom">
  
  <div class="stats-card">
    <h3>Ğ˜Ñ‚Ğ¾Ğ³Ğ¸ Ğ´Ğ½Ñ (%)</h3>
    <div class="chart-container">
      <canvas id="dayPie"></canvas>
    </div>
    
    <script type="application/json" id="day-pcts-json">{{ day_percentages | tojson }}</script>
    
    <div class="legend">
      <div class="legend-item"><span class="dot" style="background:#10b981"></span> ĞŸÑ€Ğ¸ÑÑƒÑ‚.</div>
      <div class="legend-item"><span class="dot" style="background:#f59e0b"></span> ĞĞ¿Ğ¾Ğ·Ğ´.</div>
      <div class="legend-item"><span class="dot" style="background:#ef4444"></span> ĞÑ‚ÑÑƒÑ‚.</div>
      <div class="legend-item"><span class="dot" style="background:#3b82f6"></span> Ğ£Ğ²Ğ°Ğ¶.</div>
    </div>
    <div style="text-align:center; margin-top:10px; font-size:12px; color:var(--text-secondary);">
      Ğ’ÑĞµĞ³Ğ¾ ÑÑ‡ĞµĞµĞº: {{ day_percentages.total }}
    </div>
  </div>

  <div class="stats-card">
    <h3>Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸ (Ğ·Ğ° ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ)</h3>
    <div style="overflow-y:auto; max-height:280px; scrollbar-width:thin;">
      <table class="rating-table">
        <thead>
          <tr>
            <th style="width:40px;">#</th>
            <th>Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚</th>
            <th style="text-align:right;">ĞŸĞ¾ÑĞµÑ‰ĞµĞ½Ğ¾</th>
            <th style="text-align:right;">%</th>
          </tr>
        </thead>
        <tbody>
          {% for row in ranking %}
            <tr>
              <td style="color:var(--text-secondary); text-align:center;">{{ loop.index }}</td>
              <td>{{ row.name }}</td>
              <td style="text-align:right;">{{ row.attended }}/{{ row.total }}</td>
              <td style="text-align:right;" class="rating-val">{{ "%.0f"|format(row.percent) }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
(function(){
  // ĞĞ²Ñ‚Ğ¾-ÑĞ°Ğ±Ğ¼Ğ¸Ñ‚ Ğ¿Ñ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ Ğ´Ğ°Ñ‚Ñ‹
  const input = document.querySelector('.date-input');
  if(input) {
    input.addEventListener('change', () => input.form.requestSubmit());
  }

  // Ğ”Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°
  const jsonEl = document.getElementById('day-pcts-json');
  let d = {present:0, late:0, absent:0, excused_sick:0, excused_other:0, total:0};
  try{ if(jsonEl?.textContent){ d = JSON.parse(jsonEl.textContent); } }catch(e){}
  
  const ctx = document.getElementById('dayPie');
  if (ctx && window.Chart){
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['ĞŸÑ€Ğ¸ÑÑƒÑ‚.', 'ĞĞ¿Ğ¾Ğ·Ğ´.', 'ĞÑ‚ÑÑƒÑ‚.', 'Ğ‘Ğ¾Ğ»ĞµÑÑ‚', 'Ğ”Ñ€. ÑƒĞ²Ğ°Ğ¶.'],
        datasets: [{
          data: [d.present, d.late, d.absent, d.excused_sick, d.excused_other],
          backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#6366f1'],
          borderWidth: 2,
          borderColor: '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        plugins: {
          legend: { display: false } // Ğ›ĞµĞ³ĞµĞ½Ğ´Ñƒ ÑĞ´ĞµĞ»Ğ°Ğ»Ğ¸ ÑĞ²Ğ¾Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½ÑƒÑ
        }
      }
    });
  }
})();
</script>

{% endblock %}
--- FILE: .\templates\journal.html ---
{% extends "base.html" %}

{% block title %}Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸{% endblock %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

<style>
  :root {
    /* ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¿Ğ°Ğ»Ğ¸Ñ‚Ñ€Ğ° (Ğ² ÑÑ‚Ğ¸Ğ»Ğµ Tailwind / Modern UI) */
    --font-main: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --bg-page: #f3f4f6;
    --bg-card: #ffffff;
    
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;

    --border-color: #e5e7eb;
    --primary-color: #4f46e5; /* Ğ˜Ğ½Ğ´Ğ¸Ğ³Ğ¾ */
    --primary-hover: #4338ca;

    /* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑÑ‹ (ĞŸĞ°ÑÑ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ‚Ğ¾Ğ½Ğ°) */
    --status-ok-bg: #dcfce7; --status-ok-text: #166534;
    --status-late-bg: #ffedd5; --status-late-text: #9a3412;
    --status-absent-bg: #fee2e2; --status-absent-text: #991b1b;
    --status-excused-bg: #dbeafe; --status-excused-text: #1e40af;
    --status-skip-bg: #f3f4f6; --status-skip-text: #6b7280;

    --radius-md: 12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    
    --transition: all 0.2s ease;
  }

  body {
    background-color: var(--bg-page);
    color: var(--text-primary);
    font-family: var(--font-main);
    -webkit-font-smoothing: antialiased;
  }

  /* --- Ğ—ĞĞ“ĞĞ›ĞĞ’ĞĞš Ğ˜ Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ Ğ« --- */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .page-header h1 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    letter-spacing: -0.025em;
  }

  .filters-form {
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-card);
    padding: 6px 10px;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }

  .form-control {
    border: 1px solid transparent;
    background: transparent;
    padding: 6px 12px;
    border-radius: var(--radius-sm);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    outline: none;
    transition: var(--transition);
  }
  
  .form-control:hover { background: #f9fafb; }
  .form-control:focus { border-color: var(--primary-color); background: #fff; }

  .btn-submit {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: var(--transition);
  }
  .btn-submit:hover { background: var(--primary-hover); transform: translateY(-1px); }

  /* --- ĞŸĞĞĞ•Ğ›Ğ¬ "ĞĞ• Ğ£Ğ§Ğ˜Ğ¢Ğ«Ğ’ĞĞ¢Ğ¬" --- */
  .skip-panel {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: 16px 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .skip-header {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-secondary);
    letter-spacing: 0.05em;
  }

  .skip-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  /* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ¾Ğ² ĞºĞ°Ğº "Ñ‡Ğ¸Ğ¿ÑĞ¾Ğ²" */
  .skip-check-label {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  
  .skip-check-label input {
    display: none;
  }

  .skip-chip {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    background: #f3f4f6;
    border: 1px solid transparent;
    transition: var(--transition);
  }

  .skip-check-label input:checked + .skip-chip {
    background: var(--text-primary); /* Ğ§ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ */
    color: white;
    border-color: var(--text-primary);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  
  .skip-chip small { opacity: 0.7; margin-left: 4px; font-weight: 400; }

  /* --- Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ (ĞĞ¡ĞĞĞ’ĞĞĞ¯) --- */
  .card-table {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border-color);
    overflow: hidden; /* Ğ¡ĞºÑ€ÑƒĞ³Ğ»ÑĞµĞ¼ ÑƒĞ³Ğ»Ñ‹ */
    display: flex;
    flex-direction: column;
  }

  .table-toolbar {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
  }

  .meta-tags { display: flex; gap: 8px; }
  .meta-tag {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    background: #f3f4f6;
    padding: 4px 10px;
    border-radius: 6px;
  }

  .nav-arrows .btn-arrow {
    text-decoration: none;
    color: var(--text-primary);
    font-weight: 600;
    font-size: 14px;
    padding: 6px 12px;
    border-radius: 6px;
    transition: var(--transition);
  }
  .nav-arrows .btn-arrow:hover { background: #f3f4f6; }

  .table-responsive {
    overflow-x: auto;
    /* ĞšĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğ±Ğ°Ñ€ */
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 transparent;
  }
  .table-responsive::-webkit-scrollbar { height: 6px; }
  .table-responsive::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

  .modern-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    white-space: nowrap;
  }

  .modern-table th {
    background: #f9fafb;
    color: var(--text-secondary);
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    position: sticky;
    top: 0;
    z-index: 10;
  }
  /* Ğ›Ğ¸Ğ½Ğ¸Ñ Ğ¿Ğ¾Ğ´ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑĞ»Ğ¸Ğ²Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¸ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğµ */
  .modern-table th::after {
    content: '';
    position: absolute;
    left: 0; bottom: 0; width: 100%;
    border-bottom: 1px solid var(--border-color);
  }

  .modern-table td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
    vertical-align: middle;
    transition: background 0.1s;
  }

  .modern-table tbody tr:hover td {
    background: #f8fafc; /* ĞŸĞ¾Ğ´ÑĞ²ĞµÑ‚ĞºĞ° ÑÑ‚Ñ€Ğ¾ĞºĞ¸ */
  }

  /* ĞšĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ */
  .col-num { width: 40px; color: var(--text-tertiary); text-align: center; }
  .col-uid { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-secondary); }
  .col-name { font-weight: 500; min-width: 200px; }
  .col-period { text-align: center; min-width: 130px; }

  .th-skipped span { text-decoration: line-through; opacity: 0.5; }

  /* --- Ğ¯Ğ§Ğ•Ğ™ĞšĞ˜ Ğ˜ Ğ‘Ğ•Ğ™Ğ”Ğ–Ğ˜ --- */
  .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    border-radius: 99px; /* Pill shape */
    font-size: 12px;
    font-weight: 600;
    line-height: 1.2;
    transition: var(--transition);
  }

  .bg-present { background: var(--status-ok-bg); color: var(--status-ok-text); }
  .bg-late    { background: var(--status-late-bg); color: var(--status-late-text); }
  .bg-absent  { background: var(--status-absent-bg); color: var(--status-absent-text); }
  .bg-excused { background: var(--status-excused-bg); color: var(--status-excused-text); }
  .bg-skip    { background: var(--status-skip-bg); color: var(--status-skip-text); }
  .bg-empty   { color: var(--text-tertiary); font-weight: 400; font-size: 18px; }

  /* ĞœĞµĞ½Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° */
  .cell-interactive { position: relative; cursor: pointer; }
  
  .popover-menu {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(8px);
    background: white;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-md);
    border-radius: var(--radius-md);
    z-index: 100;
    min-width: 160px;
    padding: 6px;
    display: none;
    opacity: 0;
    transition: opacity 0.2s;
  }
  
  .popover-menu.active { display: block; opacity: 1; }
  
  .popover-item {
    display: block;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    color: var(--text-primary);
    cursor: pointer;
  }
  .popover-item:hover { background: #f3f4f6; }

  /* --- Ğ˜Ğ¢ĞĞ“Ğ˜ (ĞĞ˜Ğ–ĞĞ¯Ğ¯ Ğ§ĞĞ¡Ğ¢Ğ¬) --- */
  .dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 24px;
  }
  
  .dash-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    padding: 24px;
    display: flex;
    flex-direction: column;
  }
  
  .dash-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .dash-subtitle {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 20px;
  }

  .chart-container {
    height: 200px;
    width: 100%;
    position: relative;
    margin-bottom: 16px;
  }

  /* Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ */
  .rating-table {
    width: 100%;
    font-size: 13px;
    border-collapse: collapse;
  }
  .rating-table td, .rating-table th {
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
  }
  .rating-table th { text-align: left; color: var(--text-secondary); font-weight: 500; font-size: 11px; text-transform: uppercase; }
  .rating-val { font-weight: 700; color: var(--primary-color); text-align: right; }

  @media (max-width: 900px) {
    .dashboard-grid { grid-template-columns: 1fr; }
    .page-header { flex-direction: column; align-items: flex-start; }
    .filters-form { width: 100%; justify-content: space-between; }
  }
</style>

<header class="page-header">
  <div>
    <h1>Ğ–ÑƒÑ€Ğ½Ğ°Ğ» Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸</h1>
    <span style="color: var(--text-secondary); font-size: 14px;">{{ selected_date if selected_date else today }}</span>
  </div>

  <form class="filters-form" method="get" action="{{ url_for('journal_bp.journal') }}">
    <input class="form-control" id="date-input" type="date" name="d" value="{{ selected_date }}" max="{{ today }}" required />
    
    <select class="form-control" id="group-select" name="g" onchange="this.form.requestSubmit()">
      <option value="" {{ (selected_group or '') == '' and 'selected' or '' }}>Ğ’ÑĞµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹</option>
      {% for g in groups_available or [] %}
        <option value="{{ g }}" {{ g == (selected_group or '') and 'selected' or '' }}>{{ g }}</option>
      {% endfor %}
    </select>

    <button type="submit" class="btn-submit">ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
  </form>
</header>

<div class="skip-panel">
  <div class="skip-header">
    {% if not selected_group %}ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ğ°Ñ€ (Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ³Ñ€ÑƒĞ¿Ğ¿){% else %}ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ğ°Ñ€ (Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ° {{ selected_group }}){% endif %}
  </div>
  <div class="skip-grid">
    {% set P = ["p1","p2","p3","p4","p5","p6","p7"] %}
    {% for code in P %}
      {% set p = (schedule | selectattr('code','equalto',code) | list | first) %}
      <label class="skip-check-label">
        <input type="checkbox" class="skip-check" data-code="{{ code }}"
               {% if skipped_codes and (code in skipped_codes) %}checked{% endif %}>
        <span class="skip-chip">
          {{ code|upper }}
          {% if p %}<small>{{ p.start }}</small>{% endif %}
        </span>
      </label>
    {% endfor %}
  </div>
</div>

<div class="card-table">
  <div class="table-toolbar">
    <div class="meta-tags">
      <span class="meta-tag">Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²: {{ total_students }}</span>
      <span class="meta-tag">Ğ£Ñ‡Ñ‚ĞµĞ½Ğ¾ Ğ¿Ğ°Ñ€: {{ pairs_considered }}</span>
    </div>
    <div class="nav-arrows">
      <a class="btn-arrow" href="?d={{ nav_prev }}&g={{ selected_group|default('') }}">â† ĞŸÑ€ĞµĞ´.</a>
      <a class="btn-arrow" href="?d={{ nav_next }}&g={{ selected_group|default('') }}">Ğ¡Ğ»ĞµĞ´. â†’</a>
    </div>
  </div>

  <div class="table-responsive">
    <table class="modern-table">
      <thead>
        <tr>
          <th class="col-num">#</th>
          <th class="col-uid">UID</th>
          <th class="col-name">Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚</th>
          {% for p in schedule %}
            {% set is_skipped = skipped_codes and (p.code in skipped_codes) and p.code.startswith('p') %}
            <th class="col-period {% if is_skipped %}th-skipped{% endif %}">
              <div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
                <span>{{ p.title }}</span>
                <span style="font-weight:400; opacity:0.7; font-size:10px;">{{ p.start }}-{{ p.end }}</span>
              </div>
            </th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for r in table %}
          <tr>
            <td class="col-num">{{ r.num }}</td>
            <td class="col-uid">{{ r.uid }}</td>
            <td class="col-name">{{ r.full_name }}</td>
            
            {% for c in r.cells %}
              {% set _raw = c.status or '' %}
              {% set _parts = _raw.split(':') %}
              {% set status_key = _parts[0] if _parts and _parts[0] else '' %}
              {% set _sub = _parts[1] if _parts|length > 1 else '' %}
              
              {% set label_text = "ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚" %}
              {% if status_key == 'late' %}{% set label_text = "ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»" %}{% endif %}
              {% if status_key == 'absent' %}{% set label_text = "Ğ/Ğ‘" %}{% endif %}
              {% if status_key == 'excused' %}{% set label_text = "Ğ£Ğ²Ğ°Ğ¶." %}{% endif %}
              {% if status_key == 'skip' %}{% set label_text = "â€”" %}{% endif %}

              {% set badge_class = "bg-empty" %}
              {% if status_key == 'present' %}{% set badge_class = "bg-present" %}{% endif %}
              {% if status_key == 'late' %}{% set badge_class = "bg-late" %}{% endif %}
              {% if status_key == 'absent' %}{% set badge_class = "bg-absent" %}{% endif %}
              {% if status_key == 'excused' %}{% set badge_class = "bg-excused" %}{% endif %}
              {% if status_key == 'skip' %}{% set badge_class = "bg-skip" %}{% endif %}

              <td class="col-period">
                <div class="cell-interactive" 
                     data-student-id="{{ r.id }}"
                     data-period-code="{{ c.code }}"
                     data-date="{{ selected_date }}"
                     {% if status_key != 'skip' %}onclick="toggleMenu(this)"{% endif %}>
                  
                  {% if status_key and status_key != 'skip' %}
                     <span class="badge {{ badge_class }}">
                       {{ label_text }}
                       {% if c.mark %} Â· {{ c.mark }}{% endif %}
                     </span>
                  {% elif status_key == 'skip' %}
                     <span class="badge bg-skip">ĞĞµÑ‚ Ğ¿Ğ°Ñ€Ñ‹</span>
                  {% else %}
                     <span class="badge bg-empty">Â·</span>
                  {% endif %}

                  {% if status_key != 'skip' %}
                  <div class="popover-menu" onclick="event.stopPropagation()">
                    <button class="popover-item" onclick="setStatus(this, 'present')">ğŸŸ¢ ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»</button>
                    <button class="popover-item" onclick="setStatus(this, 'late')">ğŸŸ  ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»</button>
                    <button class="popover-item" onclick="setStatus(this, 'absent')">ğŸ”´ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»</button>
                    <button class="popover-item" onclick="setStatus(this, 'excused', true)">ğŸ”µ Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ</button>
                  </div>
                  {% endif %}
                </div>
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="dashboard-grid">
  <div class="dash-card">
    <div class="dash-title">Ğ¡Ğ²Ğ¾Ğ´ĞºĞ° Ğ·Ğ° Ğ´ĞµĞ½ÑŒ</div>
    <div class="dash-subtitle">ĞĞ±Ñ‰ĞµĞµ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸</div>
    
    <div class="chart-container">
      <canvas id="dayPie"></canvas>
    </div>
    <script type="application/json" id="day-pcts-json">{{ day_percentages|tojson }}</script>
    
    <div style="display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
       <span class="badge bg-present">ĞŸÑ€Ğ¸ÑÑƒÑ‚.: {{ day_percentages.present_all }}%</span>
       <span class="badge bg-absent">ĞÑ‚ÑÑƒÑ‚.: {{ day_percentages.absent }}%</span>
       <span class="badge bg-excused">Ğ£Ğ²Ğ°Ğ¶.: {{ day_percentages.excused_sick + day_percentages.excused_other }}%</span>
    </div>
  </div>

  <div class="dash-card" style="max-height: 400px; overflow:hidden;">
    <div class="dash-title">Ğ¢Ğ¾Ğ¿ Ğ¿Ğ¾ÑĞµÑ‰Ğ°ĞµĞ¼Ğ¾ÑÑ‚Ğ¸</div>
    <div class="dash-subtitle">Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²</div>
    
    <div style="overflow-y:auto; padding-right:4px;" class="table-responsive">
      <table class="rating-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Ğ¡Ñ‚ÑƒĞ´ĞµĞ½Ñ‚</th>
            <th style="text-align:right">ĞŸĞ¾ÑĞµÑ‰ĞµĞ½Ğ¾</th>
            <th style="text-align:right">%</th>
          </tr>
        </thead>
        <tbody>
          {% for row in ranking %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>{{ row.name }}</td>
              <td style="text-align:right; color:var(--text-secondary);">{{ row.attended }}/{{ row.total }}</td>
              <td class="rating-val">{{ "%.0f"|format(row.percent) }}%</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- Ğ›ĞĞ“Ğ˜ĞšĞ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡Ğ ---

function toggleMenu(cell) {
  // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²ÑĞµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ñ‹Ğµ Ğ¼ĞµĞ½Ñ
  document.querySelectorAll('.popover-menu.active').forEach(m => {
    if (m !== cell.querySelector('.popover-menu')) m.classList.remove('active');
  });
  
  const menu = cell.querySelector('.popover-menu');
  if(menu) menu.classList.toggle('active');
}

// Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ Ğ²Ğ½Ğµ
document.addEventListener('click', (e) => {
  if (!e.target.closest('.cell-interactive')) {
    document.querySelectorAll('.popover-menu.active').forEach(m => m.classList.remove('active'));
  }
});

// --- Ğ›ĞĞ“Ğ˜ĞšĞ ĞĞ¢ĞŸĞ ĞĞ’ĞšĞ˜ Ğ”ĞĞĞĞ«Ğ¥ (AJAX) ---
async function setStatus(btn, status, askReason=false) {
  const cellWrap = btn.closest('.cell-interactive');
  const student_id = cellWrap.dataset.studentId;
  const period_code = cellWrap.dataset.periodCode;
  const d = cellWrap.dataset.date;
  
  let reason = '';
  if (askReason) {
    reason = prompt('ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ñ (sick/family/other):', 'sick');
    if (reason === null) return; // Cancelled
  }

  // Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğ¾ ÑĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¼ĞµĞ½Ñ
  cellWrap.querySelector('.popover-menu').classList.remove('active');
  
  // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ğ¸Ğ½Ğ½ĞµÑ€ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸
  const badge = cellWrap.querySelector('.badge');
  const oldHTML = badge.innerHTML;
  badge.innerHTML = '...';

  try {
    const fd = new URLSearchParams({ d, student_id, period_code, status, reason });
    const res = await fetch('{{ url_for("journal_bp.journal_set_status") }}', {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body: fd
    });
    
    const j = await res.json();
    if (!res.ok || !j.ok) throw new Error(j.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°');

    // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ UI
    // ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹ Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½ĞµĞµ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑÑ‡ĞµÑ‚Ğ° Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ², 
    // Ğ½Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑÑ‡ĞµĞ¹ĞºÑƒ:
    location.reload(); 

  } catch(err) {
    alert('ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ: ' + err.message);
    badge.innerHTML = oldHTML; // Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒ ĞºĞ°Ğº Ğ±Ñ‹Ğ»Ğ¾
  }
}

// --- Ğ›ĞĞ“Ğ˜ĞšĞ SKIP (Ğ§ĞµĞºĞ±Ğ¾ĞºÑÑ‹) ---
document.querySelectorAll('.skip-check').forEach(ch => {
  ch.addEventListener('change', async () => {
    const code = ch.dataset.code;
    const on = ch.checked ? '1' : '0';
    const params = new URLSearchParams(location.search);
    const g = params.get('g') || document.getElementById('group-select').value || '__ALL__';
    const d = document.getElementById('date-input').value;

    try {
      await fetch('{{ url_for("journal_bp.journal_skip_toggle") }}', {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({ d, code, on, g })
      });
      location.reload();
    } catch(e) { console.error(e); }
  });
});

// --- Ğ”Ğ˜ĞĞ“Ğ ĞĞœĞœĞ ---
(function(){
  const jsonEl = document.getElementById('day-pcts-json');
  let data = {present_all:0, absent:0, excused_sick:0, excused_other:0};
  try { if(jsonEl) data = JSON.parse(jsonEl.textContent); } catch(e){}

  const ctx = document.getElementById('dayPie');
  if(ctx) {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚', 'ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚', 'Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ', 'Ğ‘Ğ¾Ğ»ĞµĞµÑ‚'],
        datasets: [{
          data: [data.present_all, data.absent, data.excused_other, data.excused_sick],
          backgroundColor: ['#dcfce7', '#fee2e2', '#dbeafe', '#eff6ff'], // Ğ¦Ğ²ĞµÑ‚Ğ° ÑĞ¾Ğ²Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ Ñ CSS Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸
          borderColor: ['#ffffff', '#ffffff', '#ffffff', '#ffffff'],
          borderWidth: 2,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: { legend: { display: false } }
      }
    });
  }
})();
</script>

{% endblock %}
--- FILE: .\templates\login.html ---
{% extends "base.html" %}
{% block title %}LDO â€” Secure Access{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<style>
  /* -----------------------------------------------------------
     1. Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ• Ğ˜ Ğ¡Ğ‘Ğ ĞĞ¡ (SETUP)
     ----------------------------------------------------------- */
  :root {
    /* ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ğ¿Ğ°Ğ»Ğ¸Ñ‚Ñ€Ğ° Ğ±Ñ€ĞµĞ½Ğ´Ğ° LDO */
    --color-primary: #3b82f6;       /* Ğ¯Ñ€ĞºĞ¸Ğ¹ ÑĞ¸Ğ½Ğ¸Ğ¹ */
    --color-primary-dark: #1d4ed8;  /* Ğ¢ĞµĞ¼Ğ½Ğ¾-ÑĞ¸Ğ½Ğ¸Ğ¹ */
    --color-accent: #8b5cf6;        /* Ğ¤Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ°ĞºÑ†ĞµĞ½Ñ‚ */
    --color-success: #10b981;       /* Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¹ ÑƒÑĞ¿ĞµÑ… */
    --color-danger: #ef4444;        /* ĞšÑ€Ğ°ÑĞ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° */
    --color-danger-bg: #fef2f2;
    
    /* Ğ¢ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ñ†Ğ²ĞµÑ‚Ğ° */
    --text-main: #111827;
    --text-secondary: #6b7280;
    --text-placeholder: #9ca3af;
    --text-inverse: #ffffff;

    /* Ğ­Ñ„Ñ„ĞµĞºÑ‚Ñ‹ ÑÑ‚ĞµĞºĞ»Ğ° */
    --glass-bg: rgba(255, 255, 255, 0.75);
    --glass-border: rgba(255, 255, 255, 0.6);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    --blur-strength: 40px;

    /* Ğ Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ Ğ¸ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹ */
    --radius-xl: 32px;
    --radius-md: 16px;
    --radius-sm: 12px;
    
    /* ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ğ¸ */
    --ease-elastic: cubic-bezier(0.68, -0.55, 0.265, 1.55);
    --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    --anim-duration: 0.4s;
  }

  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body, html {
    height: 100%;
    width: 100%;
    font-family: 'Manrope', sans-serif;
    overflow: hidden; /* Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ñ„Ğ¾Ğ½ Ğ½Ğµ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğ¸Ğ»ÑÑ */
    background: #f3f4f6;
  }

  /* -----------------------------------------------------------
     2. Ğ–Ğ˜Ğ’ĞĞ™ Ğ¤ĞĞ (AURORA BACKGROUND)
     Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ 6 Ğ´Ğ²Ğ¸Ğ¶ÑƒÑ‰Ğ¸Ñ…ÑÑ ÑÑ„ĞµÑ€ Ñ€Ğ°Ğ·Ğ½Ğ¾Ğ³Ğ¾ Ñ†Ğ²ĞµÑ‚Ğ°
     ----------------------------------------------------------- */
  .background-aurora {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    background: #ffffff;
    overflow: hidden;
  }

  /* ĞĞ±Ñ‰Ğ¸Ğ¹ ÑÑ‚Ğ¸Ğ»ÑŒ Ğ´Ğ»Ñ ÑÑ„ĞµÑ€ */
  .orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.6;
    animation: floatOrb 20s infinite ease-in-out alternate;
  }

  /* Ğ¡Ñ„ĞµÑ€Ğ° 1: Ğ¡Ğ¸Ğ½ÑÑ (Ğ¡Ğ»ĞµĞ²Ğ° ÑĞ²ĞµÑ€Ñ…Ñƒ) */
  .orb-1 {
    width: 600px;
    height: 600px;
    background: radial-gradient(circle, #60a5fa 0%, rgba(96,165,250,0) 70%);
    top: -100px;
    left: -100px;
    animation-duration: 25s;
  }

  /* Ğ¡Ñ„ĞµÑ€Ğ° 2: Ğ¤Ğ¸Ğ¾Ğ»ĞµÑ‚Ğ¾Ğ²Ğ°Ñ (Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ° ÑĞ½Ğ¸Ğ·Ñƒ) */
  .orb-2 {
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, #a78bfa 0%, rgba(167,139,250,0) 70%);
    bottom: -50px;
    right: -100px;
    animation-duration: 28s;
    animation-delay: -5s;
  }

  /* Ğ¡Ñ„ĞµÑ€Ğ° 3: Ğ Ğ¾Ğ·Ğ¾Ğ²Ğ°Ñ (Ğ¦ĞµĞ½Ñ‚Ñ€) */
  .orb-3 {
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, #f472b6 0%, rgba(244,114,182,0) 70%);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation-name: pulseOrb;
    animation-duration: 15s;
  }

  /* Ğ¡Ñ„ĞµÑ€Ğ° 4: Ğ“Ğ¾Ğ»ÑƒĞ±Ğ°Ñ (Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ° ÑĞ²ĞµÑ€Ñ…Ñƒ) */
  .orb-4 {
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, #22d3ee 0%, rgba(34,211,238,0) 70%);
    top: 10%;
    right: 15%;
    animation-duration: 22s;
    animation-delay: -2s;
  }

  /* Ğ¡Ñ„ĞµÑ€Ğ° 5: Ğ–ĞµĞ»Ñ‚Ğ°Ñ (Ğ¡Ğ»ĞµĞ²Ğ° ÑĞ½Ğ¸Ğ·Ñƒ) */
  .orb-5 {
    width: 350px;
    height: 350px;
    background: radial-gradient(circle, #fde047 0%, rgba(253,224,71,0) 70%);
    bottom: 10%;
    left: 10%;
    animation-duration: 30s;
  }

  /* Ğ¡ĞµÑ‚ĞºĞ° Ğ¿Ğ¾Ğ²ĞµÑ€Ñ… Ñ„Ğ¾Ğ½Ğ° Ğ´Ğ»Ñ Ñ‚ĞµĞºÑÑ‚ÑƒÑ€Ñ‹ (Noise effect) */
  .noise-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0.04;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 2;
  }

  /* ĞšĞµĞ¹Ñ„Ñ€ĞµĞ¹Ğ¼Ñ‹ Ğ´Ğ»Ñ Ñ„Ğ¾Ğ½Ğ° */
  @keyframes floatOrb {
    0% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -50px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
    100% { transform: translate(0, 0) scale(1); }
  }

  @keyframes pulseOrb {
    0% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
    50% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.3; }
    100% { transform: translate(-50%, -50%) scale(1); opacity: 0.5; }
  }

  /* -----------------------------------------------------------
     3. Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ ĞšĞĞĞ¢Ğ•Ğ™ĞĞ•Ğ  (LAYOUT)
     ----------------------------------------------------------- */
  .login-wrapper {
    position: relative;
    z-index: 10;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  /* -----------------------------------------------------------
     4. ĞšĞĞ Ğ¢ĞĞ§ĞšĞ (THE GLASS CARD)
     ----------------------------------------------------------- */
  .glass-card {
    position: relative;
    width: 100%;
    max-width: 440px;
    padding: 60px 50px 50px 50px; /* Ğ‘Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ */
    
    background: var(--glass-bg);
    backdrop-filter: blur(var(--blur-strength));
    -webkit-backdrop-filter: blur(var(--blur-strength));
    
    border-radius: var(--radius-xl);
    border: 1px solid var(--glass-border);
    
    box-shadow: 
      0 20px 40px -10px rgba(0,0,0,0.1), /* ĞœÑĞ³ĞºĞ°Ñ Ñ‚ĞµĞ½ÑŒ Ğ²Ğ½Ğ¸Ğ· */
      0 0 0 1px rgba(255,255,255,0.4) inset; /* Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾Ğ±Ğ²Ğ¾Ğ´ĞºĞ° */
      
    transform-style: preserve-3d;
    animation: cardEntrance 1s var(--ease-elastic) forwards;
    opacity: 0;
    transform: translateY(30px);
  }

  /* ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑĞ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ */
  @keyframes cardEntrance {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Ğ”ĞµĞºĞ¾Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ»Ğ¾ÑĞºĞ° ÑĞ²ĞµÑ€Ñ…Ñƒ */
  .glass-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 40%;
    height: 4px;
    background: linear-gradient(90deg, transparent, var(--color-primary), transparent);
    border-bottom-left-radius: 10px;
    border-bottom-right-radius: 10px;
    opacity: 0.8;
  }

  /* -----------------------------------------------------------
     5. Ğ›ĞĞ“ĞĞ¢Ğ˜ĞŸ Ğ˜ Ğ‘Ğ Ğ•ĞĞ”
     ----------------------------------------------------------- */
  .brand-header {
    text-align: center;
    margin-bottom: 40px;
    position: relative;
  }

  .logo-container {
    width: 100px;
    height: 100px;
    margin: 0 auto 20px auto;
    position: relative;
    border-radius: 30%; /* Squircle Ñ„Ğ¾Ñ€Ğ¼Ğ° */
    background: #fff;
    padding: 5px;
    box-shadow: 0 10px 25px rgba(59, 130, 246, 0.25);
    
    /* ĞĞ½Ğ¸Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¾ */
    animation: logoPop 0.8s var(--ease-elastic) 0.2s forwards;
    transform: scale(0); 
  }

  .logo-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 26%; /* Ğ§ÑƒÑ‚ÑŒ Ğ¼ĞµĞ½ÑŒÑˆĞµ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ° */
    display: block;
  }

  /* Ğ’Ñ€Ğ°Ñ‰Ğ°ÑÑ‰ĞµĞµÑÑ ĞºĞ¾Ğ»ÑŒÑ†Ğ¾ Ğ²Ğ¾ĞºÑ€ÑƒĞ³ Ğ»Ğ¾Ğ³Ğ¾ (Ğ¿Ñ€ĞµĞ¼Ğ¸ÑƒĞ¼ ÑÑ„Ñ„ĞµĞºÑ‚) */
  .logo-ring {
    position: absolute;
    top: -5px;
    left: -5px;
    right: -5px;
    bottom: -5px;
    border-radius: 32%;
    border: 2px solid transparent;
    background: linear-gradient(45deg, var(--color-primary), var(--color-accent)) border-box;
    -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    opacity: 0.6;
    animation: spinRing 10s linear infinite;
  }

  @keyframes spinRing {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  @keyframes logoPop {
    to { transform: scale(1); }
  }

  /* ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ LDO */
  .brand-title {
    font-size: 48px;
    font-weight: 800;
    line-height: 1;
    margin: 0;
    letter-spacing: -1px;
    
    /* Ğ“Ñ€Ğ°Ğ´Ğ¸ĞµĞ½Ñ‚ Ñ‚ĞµĞºÑÑ‚Ğ° */
    background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 50%, var(--color-accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    
    position: relative;
    display: inline-block;
  }

  /* ĞœĞ°Ğ»ĞµĞ½ÑŒĞºĞ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° Ğ¿Ğ¾ÑĞ»Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ */
  .brand-title::after {
    content: '.';
    font-size: 48px;
    color: var(--color-accent);
    -webkit-text-fill-color: var(--color-accent); /* ĞŸĞµÑ€ĞµĞ±Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ */
  }

  .brand-subtitle {
    display: block;
    margin-top: 8px;
    font-size: 15px;
    color: var(--text-secondary);
    font-weight: 500;
  }

  /* -----------------------------------------------------------
     6. Ğ¤ĞĞ ĞœĞ Ğ˜ ĞŸĞĞ›Ğ¯ Ğ’Ğ’ĞĞ”Ğ (FLOATING LABELS)
     Ğ¡Ğ°Ğ¼Ğ°Ñ ÑĞ»Ğ¾Ğ¶Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğ³Ğ¾ UX
     ----------------------------------------------------------- */
  .login-form {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 24px; /* Ğ Ğ°ÑÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¼ĞµĞ¶Ğ´Ñƒ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸ */
    opacity: 0;
    animation: fadeForm 0.8s ease forwards 0.5s; /* ĞŸĞ¾ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ»Ğ¾Ğ³Ğ¾ */
  }

  @keyframes fadeForm {
    to { opacity: 1; }
  }

  .input-group {
    position: relative;
    width: 100%;
  }

  /* Ğ¡Ñ‚Ğ¸Ğ»Ğ¸ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ Ğ¸Ğ½Ğ¿ÑƒÑ‚Ğ° */
  .form-input {
    width: 100%;
    height: 64px; /* Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ */
    padding: 24px 20px 8px 50px; /* padding-top Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ´Ğ»Ñ Ğ¼ĞµÑ‚ĞºĞ¸ */
    font-size: 16px;
    font-weight: 600;
    color: var(--text-main);
    background: rgba(255, 255, 255, 0.5); /* ĞŸĞ¾Ğ»ÑƒĞ¿Ñ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ñ‹Ğ¹ Ğ±ĞµĞ»Ñ‹Ğ¹ */
    border: 2px solid transparent;
    border-radius: var(--radius-md);
    outline: none;
    transition: all 0.3s var(--ease-smooth);
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
  }

  /* Ğ˜ĞºĞ¾Ğ½ĞºĞ° ÑĞ»ĞµĞ²Ğ° */
  .input-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 20px;
    color: var(--text-placeholder);
    transition: color 0.3s ease;
    z-index: 2;
  }

  /* ĞŸĞ»Ğ°Ğ²Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ»ĞµĞ¹Ğ±Ğ» (Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ¸) */
  .form-label {
    position: absolute;
    left: 50px; /* ĞÑ‚ÑÑ‚ÑƒĞ¿ Ğ¿Ğ¾Ğ´ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ */
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
    color: var(--text-secondary);
    pointer-events: none; /* Ğ§Ñ‚Ğ¾Ğ±Ñ‹ ĞºĞ»Ğ¸Ğº Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ğ» ÑĞºĞ²Ğ¾Ğ·ÑŒ Ñ‚ĞµĞºÑÑ‚ Ğ² Ğ¸Ğ½Ğ¿ÑƒÑ‚ */
    transition: all 0.3s var(--ease-smooth);
    font-weight: 500;
  }

  /* --- Ğ¡ĞĞ¡Ğ¢ĞĞ¯ĞĞ˜Ğ¯ Ğ¤ĞĞšĞ£Ğ¡Ğ Ğ˜ Ğ—ĞĞŸĞĞ›ĞĞ•ĞĞ˜Ğ¯ --- */

  /* ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸Ğ½Ğ¿ÑƒÑ‚ Ğ² Ñ„Ğ¾ĞºÑƒÑĞµ Ğ¸Ğ»Ğ¸ Ğ² Ğ½ĞµĞ¼ ĞµÑÑ‚ÑŒ Ñ‚ĞµĞºÑÑ‚ (valid) */
  .form-input:focus,
  .form-input:not(:placeholder-shown) {
    background: #ffffff;
    border-color: var(--color-primary);
    box-shadow: 0 8px 20px rgba(59, 130, 246, 0.15);
  }

  /* ĞšÑ€Ğ°ÑĞ¸Ğ¼ Ğ¸ĞºĞ¾Ğ½ĞºÑƒ */
  .form-input:focus ~ .input-icon,
  .form-input:not(:placeholder-shown) ~ .input-icon {
    color: var(--color-primary);
  }

  /* ĞŸĞµÑ€ĞµĞ¼ĞµÑ‰Ğ°ĞµĞ¼ Ğ»ĞµĞ¹Ğ±Ğ» Ğ²Ğ²ĞµÑ€Ñ… */
  .form-input:focus ~ .form-label,
  .form-input:not(:placeholder-shown) ~ .form-label {
    top: 18px; /* ĞŸĞ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ²Ñ‹ÑˆĞµ */
    font-size: 12px; /* Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ°ĞµĞ¼ ÑˆÑ€Ğ¸Ñ„Ñ‚ */
    color: var(--color-primary);
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  /* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ¿Ğ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€ (Ğ½ÑƒĞ¶ĞµĞ½ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ…Ğ°ĞºĞ° :placeholder-shown) */
  .form-input::placeholder {
    color: transparent; 
  }

  /* -----------------------------------------------------------
     7. ĞšĞĞĞŸĞšĞ Ğ’ĞĞ™Ğ¢Ğ˜ (NEON & GLOW)
     ----------------------------------------------------------- */
  .btn-submit {
    position: relative;
    width: 100%;
    height: 60px;
    margin-top: 10px;
    background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    color: #fff;
    border: none;
    border-radius: var(--radius-md);
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 0.5px;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.4s var(--ease-elastic);
    box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  /* Ğ˜ĞºĞ¾Ğ½ĞºĞ° Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ */
  .btn-submit i {
    font-size: 18px;
    transition: transform 0.3s;
  }

  /* Ğ­Ñ„Ñ„ĞµĞºÑ‚ Ğ±Ğ»Ğ¸ĞºĞ° */
  .btn-submit::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 50%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: skewX(-20deg);
    transition: 0.5s;
  }

  /* Ğ¥Ğ¾Ğ²ĞµÑ€ ÑÑ„Ñ„ĞµĞºÑ‚Ñ‹ */
  .btn-submit:hover {
    transform: translateY(-4px);
    box-shadow: 0 15px 30px rgba(37, 99, 235, 0.5);
  }

  .btn-submit:hover::before {
    left: 120%; /* ĞŸÑ€Ğ¾Ğ»ĞµÑ‚Ğ°ĞµÑ‚ Ğ±Ğ»Ğ¸Ğº */
  }

  .btn-submit:hover i {
    transform: translateX(5px); /* Ğ¡Ñ‚Ñ€ĞµĞ»Ğ¾Ñ‡ĞºĞ° ÑĞ´Ğ²Ğ¸Ğ³Ğ°ĞµÑ‚ÑÑ Ğ²Ğ¿Ñ€Ğ°Ğ²Ğ¾ */
  }

  .btn-submit:active {
    transform: translateY(-2px) scale(0.98);
  }

  /* -----------------------------------------------------------
     8. Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯ ĞĞ‘ ĞĞ¨Ğ˜Ğ‘ĞšĞĞ¥ (NOTIFICATIONS)
     ----------------------------------------------------------- */
  .alert-box {
    width: 100%;
    margin-bottom: 25px;
    padding: 16px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: flex-start;
    gap: 12px;
    font-size: 14px;
    line-height: 1.5;
    animation: slideInError 0.5s var(--ease-elastic);
  }

  @keyframes slideInError {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .alert-error {
    background: var(--color-danger-bg);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #991b1b;
  }

  .alert-icon {
    flex-shrink: 0;
    font-size: 18px;
    color: var(--color-danger);
    margin-top: 2px;
  }

  /* -----------------------------------------------------------
     9. ĞŸĞĞ”Ğ’ĞĞ› / Ğ¡Ğ¡Ğ«Ğ›ĞšĞ˜
     ----------------------------------------------------------- */
  .card-footer {
    margin-top: 30px;
    text-align: center;
    font-size: 14px;
    color: var(--text-secondary);
    opacity: 0;
    animation: fadeFooter 1s ease forwards 1s;
  }

  @keyframes fadeFooter {
    to { opacity: 1; }
  }

  .link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: 600;
    position: relative;
    transition: color 0.2s;
  }

  .link::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0%;
    height: 2px;
    background: var(--color-accent);
    transition: width 0.3s ease;
    border-radius: 2px;
  }

  .link:hover {
    color: var(--color-primary-dark);
  }
  
  .link:hover::after {
    width: 100%;
  }

  /* -----------------------------------------------------------
     10. ĞĞ”ĞĞŸĞ¢Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ¬ (RESPONSIVE)
     ----------------------------------------------------------- */
  @media (max-width: 480px) {
    .glass-card {
      padding: 40px 25px;
      max-width: 90%;
      border-radius: 24px;
    }

    .brand-title {
      font-size: 36px;
    }

    .logo-container {
      width: 80px;
      height: 80px;
    }

    .form-input {
      font-size: 15px;
    }
  }

  /* Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ»ĞµÑĞº Ğ´Ğ»Ñ ĞºÑ€Ğ°ÑĞ¾Ñ‚Ñ‹ (Decoration particles) */
  .decoration-star {
    position: absolute;
    color: #fff;
    opacity: 0.8;
    animation: twinkle 3s infinite ease-in-out;
    z-index: 20;
    pointer-events: none;
  }
  
  .star-1 { top: 10%; left: 10%; font-size: 10px; animation-delay: 0s; }
  .star-2 { top: 20%; right: 20%; font-size: 14px; animation-delay: 1s; }
  .star-3 { bottom: 15%; left: 15%; font-size: 12px; animation-delay: 2s; }

  @keyframes twinkle {
    0%, 100% { transform: scale(1); opacity: 0.4; }
    50% { transform: scale(1.5); opacity: 1; text-shadow: 0 0 10px #fff; }
  }

</style>

<div class="background-aurora">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
  <div class="orb orb-3"></div>
  <div class="orb orb-4"></div>
  <div class="orb orb-5"></div>
  <div class="noise-overlay"></div>
</div>

<div class="login-wrapper">

  <div class="decoration-star star-1"><i class="fas fa-star"></i></div>
  <div class="decoration-star star-2"><i class="fas fa-star"></i></div>
  
  <div class="glass-card">
    
    <div class="brand-header">
      <div class="logo-container">
        <div class="logo-ring"></div>
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="LDO Logo">
      </div>
      <h1 class="brand-title">LDO</h1>
      <span class="brand-subtitle">ĞšĞ¾Ñ€Ğ¿Ğ¾Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°</span>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for cat, msg in messages %}
          {% if cat == 'error' %}
            <div class="alert-box alert-error">
              <i class="fas fa-exclamation-circle alert-icon"></i>
              <span>{{ msg }}</span>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="post" class="login-form">
      
      <div class="input-group">
        <input type="text" name="fio" id="fio" class="form-input" placeholder=" " required autocomplete="off">
        <label for="fio" class="form-label">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ²Ğ°ÑˆĞµ Ğ¤Ğ˜Ğ</label>
        <i class="far fa-user input-icon"></i>
      </div>

      <div class="input-group">
        <input type="password" name="password" id="password" class="form-input" placeholder=" " required>
        <label for="password" class="form-label">Ğ’Ğ°Ñˆ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</label>
        <i class="fas fa-lock input-icon"></i>
      </div>

      <button type="submit" class="btn-submit">
        Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ <i class="fas fa-arrow-right"></i>
      </button>

    </form>
    
    <div class="card-footer">
      <p>Ğ—Ğ°Ğ±Ñ‹Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ? <a href="#" class="link">ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ĞµÑÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ</a></p>
      <div style="margin-top: 10px; font-size: 12px; opacity: 0.6;">
        &copy; 2024 LDO Corporation. Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹.
      </div>
    </div>

  </div>
</div>
{% endblock %}
--- FILE: .\templates\starosta.html ---
{% extends "base.html" %}
{% block title %}Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ° â€” ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ°{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
  :root {
    --bg-page: #f3f4f6;
    --white: #ffffff;
    --primary: #4f46e5;
    --text-main: #111827;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    
    --radius-lg: 16px;
    --radius-md: 12px;
    
    /* Ğ¦Ğ²ĞµÑ‚Ğ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¹ */
    --color-selected-bg: #eef2ff;
    --color-selected-border: #4f46e5;
    
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-float: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
  }

  body {
    background: var(--bg-page);
    font-family: 'Inter', sans-serif;
    color: var(--text-main);
    /* Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¾Ñ‚ÑÑ‚ÑƒĞ¿Ñ‹ body Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ¾Ğº, ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ ĞµÑÑ‚ÑŒ Ğ² base.html */
    padding-bottom: 80px; /* ĞœĞµÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´ Ğ¿Ğ»Ğ°Ğ²Ğ°ÑÑ‰ÑƒÑ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾, Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ğ¾Ğ·Ğ´ÑƒÑ… */
  }

  .mobile-container {
    max-width: 600px; /* ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ÑˆĞ¸Ñ€Ğ¸Ğ½Ñƒ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ° ĞŸĞš Ğ½Ğµ Ñ€Ğ°Ğ·ÑŠĞµĞ·Ğ¶Ğ°Ğ»Ğ¾ÑÑŒ */
    margin: 0 auto;
    padding: 16px;
  }

  /* Ğ¨ĞĞŸĞšĞ */
  .header-card {
    background: var(--white);
    padding: 20px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    margin-bottom: 16px;
    border: 1px solid var(--border);
  }
  
  .header-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
  }
  .header-sub {
    font-size: 14px;
    color: var(--text-muted);
  }

  /* Ğ‘Ğ›ĞĞš "Ğ¢Ğ•ĞšĞ£Ğ©ĞĞ¯ ĞŸĞĞ Ğ" */
  .lesson-card {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    color: white;
    border-radius: var(--radius-lg);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    position: relative;
    overflow: hidden;
  }
  
  .lesson-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.8;
    margin-bottom: 6px;
  }
  .lesson-name {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
    line-height: 1.3;
  }
  .lesson-time {
    font-size: 14px;
    opacity: 0.9;
    font-weight: 500;
  }
  
  /* Ğ•ÑĞ»Ğ¸ Ğ¿Ğ°Ñ€Ğ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ° */
  .lesson-card.locked {
    background: #374151; /* Ğ¢ĞµĞ¼Ğ½Ğ¾-ÑĞµÑ€Ñ‹Ğ¹ */
    box-shadow: none;
  }
  .locked-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(255,255,255,0.2);
    padding: 4px 10px; border-radius: 20px;
    font-size: 12px; margin-bottom: 10px;
  }

  /* Ğ¡ĞŸĞ˜Ğ¡ĞĞš Ğ¡Ğ¢Ğ£Ğ”Ğ•ĞĞ¢ĞĞ’ (Ğ¡ĞµÑ‚ĞºĞ°) */
  .students-title {
    font-size: 15px; font-weight: 600; margin-bottom: 10px;
    display: flex; justify-content: space-between; align-items: center;
  }
  
  .students-grid {
    display: grid;
    /* ĞĞ° Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… 1 ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ°, Ğ½Ğ° Ñ‡ÑƒÑ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ñ… 2 */
    grid-template-columns: 1fr; 
    gap: 10px;
  }
  @media (min-width: 450px) {
    .students-grid { grid-template-columns: 1fr 1fr; }
  }

  /* Ğ˜Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ°Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ° ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ° */
  .student-item {
    position: relative;
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  
  /* Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑ */
  .student-item input[type="checkbox"] {
    position: absolute; opacity: 0; width: 0; height: 0;
  }

  .st-card {
    display: flex;
    align-items: center;
    background: var(--white);
    padding: 14px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    transition: all 0.2s ease;
  }
  
  .st-avatar {
    width: 36px; height: 36px;
    background: #f3f4f6;
    color: var(--text-muted);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 600; font-size: 14px;
    margin-right: 12px;
    flex-shrink: 0;
    transition: 0.2s;
  }
  
  .st-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-main);
  }

  /* Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ SELECTED */
  .student-item input:checked + .st-card {
    border-color: var(--primary);
    background: var(--color-selected-bg);
    box-shadow: 0 2px 4px rgba(79, 70, 229, 0.1);
  }
  .student-item input:checked + .st-card .st-avatar {
    background: var(--primary);
    color: white;
  }
  
  /* Ğ“Ğ°Ğ»Ğ¾Ñ‡ĞºĞ°, Ğ¿Ğ¾ÑĞ²Ğ»ÑÑÑ‰Ğ°ÑÑÑ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ */
  .check-icon {
    margin-left: auto;
    color: var(--primary);
    font-size: 16px;
    opacity: 0;
    transform: scale(0.5);
    transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .student-item input:checked + .st-card .check-icon {
    opacity: 1;
    transform: scale(1);
  }


  /* ĞĞ˜Ğ–ĞĞ¯Ğ¯ ĞŸĞĞĞ•Ğ›Ğ¬ Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ™ */
  .actions-section {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 16px;
    margin-top: 24px;
    box-shadow: var(--shadow-sm);
  }

  .status-label { font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block; }

  /* ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² (Segmented Control) */
  .status-group {
    display: flex;
    background: #f3f4f6;
    padding: 4px;
    border-radius: 12px;
    gap: 4px;
  }
  
  .status-option {
    flex: 1;
    position: relative;
    cursor: pointer;
  }
  .status-option input { display: none; }
  
  .status-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 0;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text-muted);
    transition: 0.2s;
    text-align: center;
  }
  .status-btn i { font-size: 16px; margin-bottom: 4px; }

  /* ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² */
  .status-option input:checked + .status-btn {
    background: #fff;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    color: var(--text-main);
    font-weight: 700;
  }
  
  /* Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ°ĞºÑ†ĞµĞ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº */
  .status-option:nth-child(1) input:checked + .status-btn { color: #10b981; } /* Ğ—ĞµĞ»ĞµĞ½Ñ‹Ğ¹ (Ğ‘Ñ‹Ğ») */
  .status-option:nth-child(2) input:checked + .status-btn { color: #ef4444; } /* ĞšÑ€Ğ°ÑĞ½Ñ‹Ğ¹ (ĞĞµ Ğ±Ñ‹Ğ») */
  .status-option:nth-child(3) input:checked + .status-btn { color: #3b82f6; } /* Ğ¡Ğ¸Ğ½Ğ¸Ğ¹ (Ğ£Ğ²Ğ°Ğ¶) */

  /* Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹ */
  .reason-wrap {
    margin-top: 12px;
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.3s ease;
  }
  .reason-wrap.show { max-height: 100px; }
  
  .reason-select {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: #fff;
    font-size: 14px;
    outline: none;
  }

  /* Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ° */
  .btn-submit {
    width: 100%;
    margin-top: 20px;
    padding: 14px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    transition: 0.2s;
  }
  .btn-submit:active { transform: scale(0.98); }
  .btn-submit:disabled { background: #9ca3af; box-shadow: none; }

</style>

<div class="mobile-container">
  
  <div class="header-card">
    <div class="header-title">Ğ¡Ñ‚Ğ°Ñ€Ğ¾ÑÑ‚Ğ° â€” ĞÑ‚Ğ¼ĞµÑ‚ĞºĞ°</div>
    <div class="header-sub">Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°: <b>{{ group_code or 'â€”' }}</b></div>
  </div>

  {% if locked %}
    <div class="lesson-card locked">
      <div class="locked-badge"><i class="fas fa-lock"></i> ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ°</div>
      <div class="lesson-name">Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹</div>
      <div class="lesson-time">ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°</div>
    </div>
  {% else %}
    <div class="lesson-card">
      {% if current_index is not none and current_index >= 0 and current_index < schedule|length %}
        {% set p = schedule[current_index] %}
        <div class="lesson-label">Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¿Ğ°Ñ€Ğ°</div>
        <div class="lesson-name">{{ p.title }}</div>
        <div class="lesson-time"><i class="far fa-clock"></i> {{ p.start }} â€“ {{ p.end }}</div>
      {% else %}
        <div class="lesson-label">ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ°Ñ€Ñ‹</div>
        <div class="lesson-time">Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ° Ğ¸Ğ»Ğ¸ Ğ¿Ğ°Ñ€Ñ‹ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»Ğ¸ÑÑŒ</div>
      {% endif %}
    </div>
  {% endif %}

  <form method="post" action="{{ url_for('starosta.starosta_submit') }}">
    
    <div class="students-title">
      <span>ĞšĞ¾Ğ³Ğ¾ Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¸Ñ‚ÑŒ?</span>
      {% if not locked and students|length > 0 %}
        <small style="color:var(--primary); cursor:pointer;" onclick="toggleAll(this)">Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµÑ…</small>
      {% endif %}
    </div>

    {% if students|length == 0 %}
      <div style="text-align:center; padding:30px; color:var(--text-muted); background:#fff; border-radius:12px;">
        Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ğ¿ÑƒÑÑ‚
      </div>
    {% else %}
      <div class="students-grid">
        {% for s in students %}
          <label class="student-item">
            <input type="checkbox" name="student_ids" value="{{ s.id }}" class="st-cb">
            <div class="st-card">
              <div class="st-avatar">{{ s.full_name[:1] }}</div>
              <div class="st-name">{{ s.full_name }}</div>
              <i class="fas fa-check-circle check-icon"></i>
            </div>
          </label>
        {% endfor %}
      </div>
    {% endif %}

    <div class="actions-section">
      <span class="status-label">ĞšĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¼?</span>
      
      <div class="status-group">
        <label class="status-option">
          <input type="radio" name="status" value="present" checked>
          <div class="status-btn">
            <i class="fas fa-check"></i> Ğ‘Ñ‹Ğ»
          </div>
        </label>
        
        <label class="status-option">
          <input type="radio" name="status" value="absent">
          <div class="status-btn">
            <i class="fas fa-times"></i> ĞĞµ Ğ±Ñ‹Ğ»
          </div>
        </label>
        
        <label class="status-option">
          <input type="radio" name="status" value="excused" id="radioExcused">
          <div class="status-btn">
            <i class="fas fa-file-medical"></i> Ğ£Ğ²Ğ°Ğ¶.
          </div>
        </label>
      </div>

      <div class="reason-wrap" id="reasonWrap">
        <select name="reason" id="reasonSel" class="reason-select" disabled>
          <option value="">Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñƒ...</option>
          {% for r in excused_reasons %}
            <option value="{{ r }}">{{ r|capitalize }}</option>
          {% endfor %}
        </select>
      </div>

      <button class="btn-submit" type="submit" {% if locked %}disabled{% endif %}>
        ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
      </button>
      
      {% if not locked %}
      <div style="text-align:center; margin-top:12px;">
         <a href="{{ url_for('starosta.starosta_form') }}" style="font-size:13px; color:var(--text-muted); text-decoration:none;">
           <i class="fas fa-sync"></i> ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ
         </a>
      </div>
      {% endif %}
    </div>

  </form>
</div>

<script>
  // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ "Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°"
  const radioExcused = document.getElementById('radioExcused');
  const reasonWrap = document.getElementById('reasonWrap');
  const reasonSel = document.getElementById('reasonSel');
  const radios = document.querySelectorAll('input[name="status"]');

  function checkReason() {
    if (radioExcused.checked) {
      reasonWrap.classList.add('show');
      reasonSel.disabled = false;
    } else {
      reasonWrap.classList.remove('show');
      reasonSel.disabled = true;
      reasonSel.value = "";
    }
  }

  radios.forEach(r => r.addEventListener('change', checkReason));

  // Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµÑ…"
  function toggleAll(btn) {
    const cbs = document.querySelectorAll('.st-cb');
    // Ğ•ÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ñ…Ğ¾Ñ‚ÑŒ Ğ¾Ğ´Ğ¸Ğ½ Ğ½ĞµĞ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ -> Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµ. Ğ˜Ğ½Ğ°Ñ‡Ğµ ÑĞ½ÑÑ‚ÑŒ Ğ²ÑĞµ.
    let allChecked = true;
    cbs.forEach(cb => { if(!cb.checked) allChecked = false; });
    
    const newState = !allChecked;
    cbs.forEach(cb => cb.checked = newState);
    
    btn.textContent = newState ? "Ğ¡Ğ½ÑÑ‚ÑŒ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ" : "Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ²ÑĞµÑ…";
  }
</script>

{% endblock %}
--- FILE: .\templates\student.html ---
{% extends "base.html" %}
{% block title %}ĞšĞ°Ğ±Ğ¸Ğ½ĞµÑ‚ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ°{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<style>
  :root {
    --bg-page: #f3f4f6;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --white: #ffffff;
    --primary: #4f46e5;
    --border: #e5e7eb;
    
    --radius-lg: 16px;
    --radius-md: 12px;
    
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    
    /* Ğ¦Ğ²ĞµÑ‚Ğ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ² */
    --c-present: #10b981;
    --c-late: #f59e0b;
    --c-absent: #ef4444;
    --c-excused: #3b82f6;
  }

  body {
    background: var(--bg-page);
    font-family: 'Inter', sans-serif;
    color: var(--text-primary);
    padding-bottom: 40px; /* ĞÑ‚ÑÑ‚ÑƒĞ¿ ÑĞ½Ğ¸Ğ·Ñƒ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»Ğ¾Ğº */
  }

  .container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 0 16px;
  }

  /* ĞŸĞ Ğ˜Ğ’Ğ•Ğ¢Ğ¡Ğ¢Ğ’Ğ˜Ğ• */
  .hero-card {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    color: white;
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
    position: relative;
    overflow: hidden;
  }
  
  /* Ğ”ĞµĞºĞ¾Ñ€ Ğ½Ğ° Ñ„Ğ¾Ğ½Ğµ */
  .hero-card::after {
    content: '';
    position: absolute;
    top: -20px; right: -20px;
    width: 100px; height: 100px;
    background: rgba(255,255,255,0.1);
    border-radius: 50%;
  }

  .hero-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .hero-date { font-size: 14px; opacity: 0.9; display: flex; align-items: center; gap: 6px; }

  /* Ğ¡Ğ•Ğ¢ĞšĞ (Desktop: 2 ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸, Mobile: 1 ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ°) */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
  }
  @media (min-width: 800px) { .main-grid { grid-template-columns: 400px 1fr; } }

  /* ĞšĞĞ Ğ¢ĞĞ§ĞšĞ ĞĞ‘Ğ©ĞĞ¯ */
  .section-card {
    background: var(--white);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border);
    padding: 20px;
    height: fit-content;
  }
  .card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 16px;
  }
  .card-title { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
  .card-title i { color: var(--primary); }

  /* Ğ ĞĞ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• (TIMELINE) */
  .timeline {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .tl-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: var(--radius-md);
    border-left: 3px solid transparent; /* Ğ¦Ğ²ĞµÑ‚Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ»Ğ¾ÑĞºĞ° */
    transition: 0.2s;
  }
  
  /* Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ¿Ğ°Ñ€Ğ° (Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ Ğ² ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğµ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ´ĞµĞ»ĞµĞ½Ğ¸Ñ) */
  /* .tl-item.active { background: #eef2ff; border-left-color: var(--primary); } */

  .tl-time {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-width: 50px;
    font-size: 12px; font-weight: 700; color: var(--text-secondary);
    background: #fff; border-radius: 8px; padding: 4px;
    border: 1px solid var(--border);
    height: fit-content;
  }
  
  .tl-info { flex: 1; }
  .tl-title { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 2px; }
  .tl-sub { font-size: 12px; color: var(--text-secondary); }


  /* ĞŸĞĞ¡Ğ•Ğ©ĞĞ•ĞœĞĞ¡Ğ¢Ğ¬ (ĞĞ•Ğ”Ğ•Ğ›Ğ¯) */
  /* ĞĞ´Ğ°Ğ¿Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ´Ğ½ĞµĞ¹ */
  .week-list {
    display: flex; flex-direction: column; gap: 12px;
  }
  
  .day-card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }
  
  .day-header {
    background: #f9fafb;
    padding: 10px 14px;
    font-size: 13px; font-weight: 600; color: var(--text-secondary);
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between;
  }
  
  /* Ğ¡ĞµÑ‚ĞºĞ° Ğ¿Ğ°Ñ€ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ´Ğ½Ñ */
  .pairs-grid {
    display: grid;
    /* ĞœĞ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹: ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ°Ñ ÑĞµÑ‚ĞºĞ° */
    grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); 
    gap: 1px;
    background: var(--border); /* Ğ¦Ğ²ĞµÑ‚ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ĞµĞ»ĞµĞ¹ */
  }
  
  .pair-box {
    background: #fff;
    padding: 10px 4px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 6px;
    min-height: 60px;
  }
  
  .pb-label { font-size: 10px; color: #9ca3af; font-weight: 600; }
  
  /* Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ-Ğ¸ĞºĞ¾Ğ½ĞºĞ° */
  .status-icon {
    width: 24px; height: 24px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px;
    color: #d1d5db; /* Default empty */
    background: #f3f4f6;
  }
  
  /* Ğ¦Ğ²ĞµÑ‚Ğ° Ğ¸ĞºĞ¾Ğ½Ğ¾Ğº */
  .status-icon.present { background: var(--c-present); color: white; }
  .status-icon.late { background: var(--c-late); color: white; }
  .status-icon.absent { background: var(--c-absent); color: white; }
  .status-icon.excused { background: var(--c-excused); color: white; }
  
  /* Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ° */
  .legend {
    display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);
  }
  .lg-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--text-secondary); }
  .lg-dot { width: 8px; height: 8px; border-radius: 50%; }

</style>

<div class="container">

  <div class="hero-card">
    <div class="hero-title">ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, {{ fio.split()[1] if fio.split()|length > 1 else fio }}! ğŸ‘‹</div>
    <div class="hero-date">
      <i class="far fa-calendar-alt"></i> {{ today }}
    </div>
  </div>

  <div class="main-grid">
    
    <div class="section-card">
      <div class="card-header">
        <div class="card-title"><i class="far fa-clock"></i> Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
      </div>
      
      <div class="timeline">
        {% set has_pairs = false %}
        {% for p in schedule_today %}
          {% if p.code.startswith('p') %}
            {% set has_pairs = true %}
            <div class="tl-item">
              <div class="tl-time">
                <span>{{ p.start }}</span>
                <span style="height:1px; width:10px; background:#e5e7eb; margin:2px 0;"></span>
                <span>{{ p.end }}</span>
              </div>
              <div class="tl-info">
                <div class="tl-title">{{ p.title }}</div>
                <div class="tl-sub">ĞŸĞ°Ñ€Ğ° {{ p.code|replace('p','') }}</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}

        {% if not has_pairs %}
          <div style="text-align:center; padding:20px; color:var(--text-secondary); font-size:14px;">
            Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ¿Ğ°Ñ€ Ğ½ĞµÑ‚, Ğ¾Ñ‚Ğ´Ñ‹Ñ…Ğ°Ğ¹! ğŸ‰
          </div>
        {% endif %}
      </div>
    </div>

    <div class="section-card">
      <div class="card-header">
        <div class="card-title"><i class="fas fa-chart-bar"></i> ĞœĞ¾Ñ Ğ½ĞµĞ´ĞµĞ»Ñ</div>
      </div>
      
      <div class="week-list">
        {% for d in week %}
          <div class="day-card">
            <div class="day-header">
              <span>{{ d.date_text }}</span> </div>
            
            <div class="pairs-grid">
              {% for i in range(1,8) %}
                {% set key = 'p' ~ i %}
                {% set s = d['items'].get(key, '') %}
                
                <div class="pair-box">
                  <div class="pb-label">P{{ i }}</div>
                  
                  {% if s == 'present' %}
                    <div class="status-icon present" title="ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»"><i class="fas fa-check"></i></div>
                  {% elif s == 'late' %}
                    <div class="status-icon late" title="ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»"><i class="fas fa-clock"></i></div>
                  {% elif s == 'absent' %}
                    <div class="status-icon absent" title="ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»"><i class="fas fa-times"></i></div>
                  {% elif s == 'excused' %}
                    <div class="status-icon excused" title="Ğ£Ğ²Ğ°Ğ¶Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ"><i class="fas fa-file-medical"></i></div>
                  {% else %}
                    <div class="status-icon" title="ĞĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸">â€¢</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="legend">
        <div class="lg-item"><span class="lg-dot" style="background:var(--c-present)"></span> Ğ‘Ñ‹Ğ»</div>
        <div class="lg-item"><span class="lg-dot" style="background:var(--c-late)"></span> ĞĞ¿Ğ¾Ğ·Ğ´Ğ°Ğ»</div>
        <div class="lg-item"><span class="lg-dot" style="background:var(--c-absent)"></span> Ğ/Ğ‘</div>
        <div class="lg-item"><span class="lg-dot" style="background:var(--c-excused)"></span> Ğ£Ğ²Ğ°Ğ¶.</div>
        <div class="lg-item"><span class="lg-dot" style="background:#e5e7eb"></span> ĞĞµÑ‚ Ğ¿Ğ°Ñ€Ñ‹</div>
      </div>

    </div>

  </div>
</div>
{% endblock %}
--- FILE: .\templates\students_upload.html ---
{% extends "base.html" %}
{% block title %}Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²{% endblock %}
{% block content %}
<h1>Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²</h1>

<p>Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ñ… ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ±Ğ°Ğ·Ğµ: <b>{{ count }}</b></p>

<h2>Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ CSV</h2>
<form method="post" enctype="multipart/form-data" action="{{ url_for('admin_bp.students_upload') }}" class="card">
  <p>Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ„Ğ°Ğ¹Ğ»Ğ° (UTF-8): Ğ¿ĞµÑ€Ğ²Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° â€” Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ <code>uid,full_name</code>.</p>
  <p>ĞŸÑ€Ğ¸Ğ¼ĞµÑ€:</p>
  <pre class="pre">uid,full_name
1001,Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜Ğ²Ğ°Ğ½ Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‡
1002,ĞŸĞµÑ‚Ñ€Ğ¾Ğ² ĞŸÑ‘Ñ‚Ñ€ ĞŸĞµÑ‚Ñ€Ğ¾Ğ²Ğ¸Ñ‡
</pre>
  <input type="file" name="file" accept=".csv" required>
  <button type="submit" class="btn primary">Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ</button>
</form>

<h2>Ğ˜Ğ»Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ´ĞµĞ¼Ğ¾-ÑÑ‚ÑƒĞ´ĞµĞ½Ñ‚Ğ¾Ğ²</h2>
<form method="post" action="{{ url_for('admin_bp.students_seed_demo') }}">
  <button type="submit" class="btn">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ 4 Ğ´ĞµĞ¼Ğ¾-Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸</button>
</form>

<style>
.card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;max-width:640px}
.pre{background:#f8fafc;border:1px dashed #e5e7eb;padding:10px;border-radius:8px;max-width:420px}
.btn{border:1px solid #e5e7eb;border-radius:10px;padding:10px 14px;background:#fff;cursor:pointer}
.btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
</style>
{% endblock %}
