<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>{% block title %}ЛДО{% endblock %}</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  {% block head %}{% endblock %}

  <style>
    /* Глобальные настройки */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden; /* Скроллим только контент */
      background-color: #f8f9fa;
    }
    
    /* Обертка */
    .main-wrapper {
      display: flex;
      height: 100vh;
      width: 100%;
      flex-direction: column; /* На мобиле вертикально */
    }

    /* Сайдбар (Десктоп) */
    .desktop-sidebar {
      width: 280px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    /* Мобильная шапка */
    .mobile-navbar {
      display: none; /* Скрыта на ПК */
      padding: 10px 16px;
      background: #212529; /* Dark bg */
      color: white;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    /* Область контента */
    .content-area {
      flex-grow: 1;
      overflow-y: auto; /* Скролл здесь */
      padding: 20px;
      background-color: #f8f9fa;
      position: relative;
      /* Чтобы футер прижимался к низу */
      display: flex;
      flex-direction: column; 
    }

    /* Адаптивность (ПК -> Мобилка) */
    @media (min-width: 768px) {
      .main-wrapper { flex-direction: row; } /* На ПК горизонтально */
      .mobile-navbar { display: none; }      /* Скрываем моб. шапку */
      .desktop-sidebar { display: flex; }    /* Показываем сайдбар */
    }

    @media (max-width: 767.98px) {
      .desktop-sidebar { display: none; }    /* Скрываем сайдбар на мобиле */
      .mobile-navbar { display: flex; }      /* Показываем шапку */
      .content-area { padding: 12px; } /* Отступы для мобил */
    }

    /* Стили ссылок */
    .nav-pills .nav-link.active { background-color: #ff7b00 !important; }
    .nav-link { color: white; }
    .nav-link:hover { color: #ff7b00; }

    /* Flash сообщение */
    .flash-container { margin-bottom: 20px; }
    .flash { padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
    .flash.error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .flash.success { background: #dcfce7; color: #166534; border: 1px solid #86efac; }

    /* Стили футера */
    .site-footer {
      margin-top: auto; /* Толкает футер вниз */
      padding-top: 20px;
    }

    /* Бейдж уведомлений */
    .nav-badge {
      display: none; /* Скрыт, пока нет сообщений */
      background-color: #dc3545;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 8px;
      vertical-align: middle;
    }
  </style>
</head>
<body>

{% macro render_menu() %}
  <ul class="nav nav-pills flex-column mb-auto">
    {% set user = session.get('user') %}
    
    {% if user %}
      {% set role = user.role %}

      {% if role == 'tech' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Поддержка</small></li>
        <li><a href="/tech" class="nav-link text-white"><i class="bi bi-tools me-2"></i> Панель</a></li>
        <li>
            <a href="/chat" class="nav-link text-white d-flex align-items-center justify-content-between">
                <span><i class="bi bi-chat-dots me-2"></i> Чаты</span>
                <span class="nav-badge"></span>
            </a>
        </li>
      {% endif %}

      {% if role == 'curator' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Куратор</small></li>
        <li><a href="/journal" class="nav-link text-white"><i class="bi bi-journal-text me-2"></i> Журнал</a></li>
        <li><a href="/checkin" class="nav-link text-white"><i class="bi bi-check-square me-2"></i> Отметка</a></li>
        <li><a href="/curator" class="nav-link text-white"><i class="bi bi-graph-up me-2"></i> Статистика</a></li>
        <li><a href="/complaints" class="nav-link text-white"><i class="bi bi-exclamation-triangle me-2"></i> Жалобы</a></li>
        <li>
            <a href="/chat" class="nav-link text-white d-flex align-items-center justify-content-between">
                <span><i class="bi bi-chat-dots me-2"></i> Поддержка</span>
                <span class="nav-badge"></span>
            </a>
        </li>
      {% endif %}

      {% if role == 'starosta' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Староста</small></li>
        <li><a href="/starosta" class="nav-link text-white"><i class="bi bi-clipboard-check me-2"></i> Отметить</a></li>
        <li>
            <a href="/chat" class="nav-link text-white d-flex align-items-center justify-content-between">
                <span><i class="bi bi-chat-dots me-2"></i> Поддержка</span>
                <span class="nav-badge"></span>
            </a>
        </li>
      {% endif %}

      {% if role == 'student' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Личное</small></li>
        <li><a href="/student" class="nav-link text-white"><i class="bi bi-person-circle me-2"></i> Кабинет</a></li>
        <li>
            <a href="/chat" class="nav-link text-white d-flex align-items-center justify-content-between">
                <span><i class="bi bi-chat-dots me-2"></i> Поддержка</span>
                <span class="nav-badge"></span>
            </a>
        </li>
      {% endif %}

      {% if role == 'head' %}
        <li class="nav-item"><small class="text-secondary ms-3 text-uppercase fw-bold" style="font-size:10px;">Зав. отделением</small></li>
        <li><a href="/head" class="nav-link text-white"><i class="bi bi-building me-2"></i> Группы</a></li>
        <li>
            <a href="/chat" class="nav-link text-white d-flex align-items-center justify-content-between">
                <span><i class="bi bi-chat-dots me-2"></i> Поддержка</span>
                <span class="nav-badge"></span>
            </a>
        </li>
      {% endif %}

    {% else %}
      <li><a href="{{ url_for('auth_bp.login') }}" class="nav-link text-white"><i class="bi bi-box-arrow-in-right me-2"></i> Войти</a></li>
    {% endif %}
  </ul>
{% endmacro %}

{% macro render_profile() %}
  <div class="dropdown">
    {% set user = session.get('user') %}
    {% if user %}
      <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown">
        <img src="https://ui-avatars.com/api/?name={{ user.fio }}&background=random&color=fff" alt="" width="32" height="32" class="rounded-circle me-2">
        <div class="d-flex flex-column text-truncate">
          <strong class="text-truncate">{{ user.fio.split()[0] }} {{ user.fio.split()[1]|default('') }}</strong>
          <small style="font-size: 11px; opacity: 0.7;">
              {{ {
                  'curator': 'Куратор',
                  'student': 'Студент',
                  'starosta': 'Староста',
                  'head': 'Заведующая',
                  'tech': 'Тех. поддержка'
              }.get(user.role, user.role) }}
          </small>
        </div>
      </a>
      <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
        <li><a class="dropdown-item" href="{{ url_for('auth_bp.logout') }}">Выйти</a></li>
      </ul>
    {% else %}
       <span class="text-white small">Гость</span>
    {% endif %}
  </div>
{% endmacro %}


<div class="main-wrapper">

  {% if not hide_nav %}
  <div class="mobile-navbar">
    <div class="d-flex align-items-center gap-2">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" width="28" height="28" class="rounded-circle bg-white">
      <span class="fw-bold fs-5">LDO</span>
      <span class="badge rounded-pill bg-danger ms-2 nav-badge" id="badge-mobile" style="font-size: 10px;"></span>
    </div>
    <button class="btn btn-dark border-secondary p-1 px-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
      <i class="bi bi-list fs-4"></i>
    </button>
  </div>
  {% endif %}

  {% if not hide_nav %}
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="mobileMenu" style="width: 280px;">
    <div class="offcanvas-header border-bottom border-secondary">
      <h5 class="offcanvas-title d-flex align-items-center gap-2">
        <img src="{{ url_for('static', filename='img/logo.png') }}" width="24" class="rounded-circle bg-white"> Меню
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column justify-content-between">
      {{ render_menu() }}
      <hr>
      {{ render_profile() }}
    </div>
  </div>
  {% endif %}

  {% if not hide_nav %}
  <div class="desktop-sidebar p-3 text-bg-dark">
    <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" width="32" height="32" class="rounded-circle me-2" style="background: white;">
      <span class="fs-4">LDO Attendance</span>
    </a>
    <hr>
    {{ render_menu() }}
    <hr>
    {{ render_profile() }}
  </div>
  {% endif %}

  <div class="content-area">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for cat, msg in messages %}
            <div class="flash {{ cat }}">
              {% if cat == 'error' %}⚠️{% else %}✅{% endif %}
              {{ msg }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div style="width: 100%;">
        {% block content %}{% endblock %}
    </div>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function checkUnreadMessages() {
    fetch('/api/chat/unread_count')
      .then(res => res.json())
      .then(data => {
        const count = data.count;
        // Находим все бейджи
        const badges = document.querySelectorAll('.nav-badge');
        
        badges.forEach(badge => {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        });
      })
      .catch(e => console.error("Ошибка проверки сообщений", e));
  }

  // Запускаем проверку каждые 5 секунд
  setInterval(checkUnreadMessages, 5000);
  
  // И один раз при загрузке
  checkUnreadMessages();
</script>

{% block body_end %}{% endblock %}

</body>
</html>