{% extends "base.html" %}
{% block title %}–û—Ç–º–µ—Ç–∫–∞ –ø—Ä–∏—Ö–æ–¥–∞{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}

<style>
  :root {
    --font-main: 'Inter', sans-serif;
    --bg-page: #f3f4f6;
    --bg-card: #ffffff;
    --text-primary: #111827;
    --text-secondary: #6b7280;
    --border-color: #e5e7eb;
    
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    
    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;
    
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);

    /* –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
    --color-present: #10b981;
    --color-late: #f59e0b;
    --color-absent: #ef4444;
    --color-excused: #3b82f6;
  }

  body { background: var(--bg-page); color: var(--text-primary); font-family: var(--font-main); }

  /* –ó–ê–ì–û–õ–û–í–û–ö */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-title h1 { font-size: 24px; font-weight: 700; margin: 0; }
  .page-title span { color: var(--text-secondary); font-size: 14px; }

  .filter-select {
    padding: 8px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-color);
    background: #fff;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    min-width: 200px;
  }

  /* –û–°–ù–û–í–ù–ê–Ø –°–ï–¢–ö–ê */
  .layout-grid {
    display: grid;
    grid-template-columns: 1fr 340px; /* –°—Ç—É–¥–µ–Ω—Ç—ã —Å–ª–µ–≤–∞, –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ */
    gap: 24px;
    align-items: start;
  }
  @media (max-width: 1000px) { .layout-grid { grid-template-columns: 1fr; } }

  /* –ö–ê–†–¢–û–ß–ö–ò –°–¢–£–î–ï–ù–¢–û–í */
  .students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 16px;
  }

  .student-card {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    padding: 16px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer; /* –í—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ */
    user-select: none;
  }
  
  /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –∏ –≤—ã–±–æ—Ä–µ */
  .student-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); border-color: #c7d2fe; }
  
  /* –ö–æ–≥–¥–∞ —á–µ–∫–±–æ–∫—Å –≤–Ω—É—Ç—Ä–∏ –≤—ã–±—Ä–∞–Ω */
  .student-card.selected {
    border-color: var(--primary-color);
    background-color: #eef2ff;
    box-shadow: 0 0 0 1px var(--primary-color);
  }

  .st-header { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; }
  
  .st-avatar {
    width: 40px; height: 40px;
    border-radius: 50%;
    background: #f3f4f6;
    color: var(--primary-color);
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 14px;
    flex-shrink: 0;
  }
  .student-card.selected .st-avatar { background: var(--primary-color); color: #fff; }

  .st-info { display: flex; flex-direction: column; overflow: hidden; }
  .st-name { font-weight: 600; font-size: 15px; line-height: 1.2; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .st-uid { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.04); padding: 2px 6px; border-radius: 4px; align-self: flex-start; }

  .st-footer { margin-top: auto; display: flex; align-items: center; justify-content: space-between; padding-top: 12px; border-top: 1px solid #f3f4f6; }
  
  /* –°–∫—Ä—ã—Ç—ã–π —á–µ–∫–±–æ–∫—Å, —Ä–∞–±–æ—Ç–∞–µ–º —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å .selected —Ä–æ–¥–∏—Ç–µ–ª—è */
  .st-checkbox { width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer; }
  
  .btn-quick-status {
    background: #fff;
    border: 1px solid var(--border-color);
    padding: 6px 10px;
    border-radius: var(--radius-sm);
    font-size: 12px;
    font-weight: 600;
    color: var(--text-secondary);
    display: flex; align-items: center; gap: 6px;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-quick-status:hover { background: #f9fafb; color: var(--text-primary); border-color: #d1d5db; }
  
  /* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (Sticky) */
  .control-panel {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 20px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .panel-section-title {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    font-weight: 700;
    margin-bottom: 10px;
    display: flex; align-items: center; justify-content: space-between;
  }

  /* –¢–µ–∫—É—â–∞—è –ø–∞—Ä–∞ */
  .current-lesson-card {
    background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
    color: white;
    padding: 16px;
    border-radius: var(--radius-md);
    margin-bottom: 8px;
  }
  .cl-label { font-size: 11px; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.05em; }
  .cl-title { font-size: 16px; font-weight: 700; margin: 4px 0 2px; }
  .cl-time { font-size: 13px; font-weight: 500; opacity: 0.9; }

  /* Toggle Switch (Select All) */
  .toggle-label {
    display: flex; align-items: center; gap: 8px;
    font-size: 13px; font-weight: 500; cursor: pointer;
  }

  /* Period Chips */
  .periods-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
  .period-chip {
    display: inline-flex;
    cursor: pointer;
    position: relative;
  }
  .period-chip input { display: none; }
  .period-chip span {
    padding: 6px 12px;
    background: #f3f4f6;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    transition: 0.2s;
    border: 1px solid transparent;
  }
  .period-chip input:checked + span {
    background: var(--text-primary);
    color: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  /* Status Selector Grid */
  .status-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  
  .status-option { cursor: pointer; position: relative; }
  .status-option input { display: none; }
  
  .status-box {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: #fff;
    transition: 0.2s;
    height: 100%;
  }
  .status-box i { font-size: 18px; margin-bottom: 4px; }
  .status-box span { font-size: 12px; font-weight: 600; }

  /* –¶–≤–µ—Ç–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ */
  .status-option input[value="present"]:checked + .status-box { background: #ecfdf5; border-color: var(--color-present); color: var(--color-present); }
  .status-option input[value="late"]:checked + .status-box { background: #fffbeb; border-color: var(--color-late); color: var(--color-late); }
  .status-option input[value="absent"]:checked + .status-box { background: #fef2f2; border-color: var(--color-absent); color: var(--color-absent); }
  .status-option input[value="excused"]:checked + .status-box { background: #eff6ff; border-color: var(--color-excused); color: var(--color-excused); }

  .btn-submit-bulk {
    width: 100%;
    padding: 12px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
    transition: 0.2s;
    margin-top: 10px;
  }
  .btn-submit-bulk:hover { background: var(--primary-hover); transform: translateY(-1px); }

  /* –ú–µ–Ω—é –±—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ (Dropdown) */
  .popover-menu {
    position: absolute;
    bottom: 45px; right: 0; /* –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–≤–µ—Ä—Ö, —á—Ç–æ–±—ã –Ω–µ —É—Ö–æ–¥–∏–ª–æ –∑–∞ —ç–∫—Ä–∞–Ω */
    background: #fff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 50;
    min-width: 180px;
    display: none;
    padding: 4px;
    animation: fadeIn 0.15s ease;
  }
  .popover-menu.open { display: block; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(5px);} to{opacity:1; transform:translateY(0);} }

  .popover-item {
    width: 100%; text-align: left;
    background: transparent; border: none;
    padding: 8px 12px;
    font-size: 13px; font-weight: 500; color: var(--text-primary);
    cursor: pointer; border-radius: 6px;
    display: flex; align-items: center; gap: 8px;
  }
  .popover-item:hover { background: #f3f4f6; }
  
  .reason-select {
    width: 100%;
    margin-top: 8px;
    padding: 8px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 13px;
    background: #fff;
  }

</style>

<div class="page-header">
  <div class="page-title">
    <h1>–û—Ç–º–µ—Ç–∫–∞ –ø—Ä–∏—Ö–æ–¥–∞</h1>
    <span>–°–µ–≥–æ–¥–Ω—è: {{ today }}</span>
  </div>

  <form method="get" action="{{ url_for('checkin_bp.checkin_page') }}">
    <select class="filter-select" name="g" onchange="this.form.requestSubmit()">
      <option value="" {{ (selected_group or '') == '' and 'selected' or '' }}>–í—Å–µ –≥—Ä—É–ø–ø—ã</option>
      {% for g in groups_available or [] %}
        <option value="{{ g }}" {{ g == (selected_group or '') and 'selected' or '' }}>{{ g }}</option>
      {% endfor %}
    </select>
  </form>
</div>

<form action="{{ url_for('checkin_bp.do_checkin_bulk') }}" method="post" id="bulkForm">
<input type="hidden" name="g" value="{{ selected_group or '' }}">

<div class="layout-grid">
  
  <div>
    {% if students|length == 0 %}
      <div style="text-align:center; padding: 40px; color: var(--text-secondary);">
        –ù–µ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è. –í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É.
      </div>
    {% endif %}

    <div class="students-grid" id="studentsBox">
      {% for s in students %}
      <div class="student-card" onclick="toggleCard(this)" data-id="{{ s.id }}">
        <div class="st-header">
          <div class="st-avatar">{{ s.full_name[:1] }}</div>
          <div class="st-info">
            <span class="st-name" title="{{ s.full_name }}">{{ s.full_name }}</span>
            <span class="st-uid">{{ s.uid }}</span>
          </div>
        </div>

        <div class="st-footer">
          <label class="toggle-label" onclick="event.stopPropagation()">
             <input type="checkbox" class="st-checkbox" name="student_ids" value="{{ s.id }}">
             <span style="font-size:12px; color:var(--text-secondary);">–í—ã–±—Ä–∞—Ç—å</span>
          </label>

          <div style="position:relative;">
            <button type="button" class="btn-quick-status" onclick="toggleMenu(event, 'menu-{{ s.id }}')">
              –°—Ç–∞—Ç—É—Å... ‚ñæ
            </button>
            
            <div class="popover-menu" id="menu-{{ s.id }}" onclick="event.stopPropagation()">
               <button type="button" class="popover-item" data-status="present" onclick="quickStatus(this)">
                 <span style="color:var(--color-present)">‚óè</span> –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª
               </button>
               <button type="button" class="popover-item" data-status="late" onclick="quickStatus(this)">
                 <span style="color:var(--color-late)">‚óè</span> –û–ø–æ–∑–¥–∞–ª
               </button>
               <button type="button" class="popover-item" data-status="absent" onclick="quickStatus(this)">
                 <span style="color:var(--color-absent)">‚óè</span> –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª
               </button>
               <button type="button" class="popover-item" data-status="excused" data-ask-reason="1" onclick="quickStatus(this)">
                 <span style="color:var(--color-excused)">‚óè</span> –£–≤–∞–∂–∏—Ç–µ–ª—å–Ω–∞—è
               </button>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <aside class="control-panel">
    
    {% if current_index is not none and current_index >= 0 and current_index < schedule|length %}
      {% set p = schedule[current_index] %}
      <div class="current-lesson-card" id="currentLessonInfo">
        <div class="cl-label">–°–µ–π—á–∞—Å –∏–¥–µ—Ç</div>
        <div class="cl-title">{{ p.title }}</div>
        <div class="cl-time">{{ p.start }} ‚Äì {{ p.end }}</div>
      </div>
      <div id="has-current" data-value="1" style="display:none;"></div>
    {% else %}
      <div style="background:#f3f4f6; border-radius:12px; padding:16px; text-align:center; color:var(--text-secondary);">
        <div style="font-weight:600; font-size:14px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–∞—Ä—ã</div>
        <div style="font-size:12px;">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>
      </div>
      <div id="has-current" data-value="0" style="display:none;"></div>
    {% endif %}

    <div>
      <div class="panel-section-title">
        <span>–ö–æ–≥–æ –æ—Ç–º–µ—Ç–∏—Ç—å?</span>
        <label class="toggle-label" style="text-transform:none; font-weight:400;">
          <input type="checkbox" id="allStudents"> –í—Å–µ—Ö
        </label>
      </div>
      <div style="font-size:12px; color:var(--text-secondary); line-height:1.4;">
        –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—Å–µ—Ö¬ª.
      </div>
    </div>

    <div>
      <div class="panel-section-title">
        <span>–ù–∞ –∫–∞–∫–∏–µ –ø–∞—Ä—ã?</span>
        <label class="toggle-label" style="text-transform:none; font-weight:400;">
           <input type="checkbox" id="allPeriods"> –í—Å–µ
        </label>
      </div>
      <div class="periods-wrap">
        {% for p in schedule %}
          {% if p.code.startswith('p') %}
            <label class="period-chip" title="{{ p.start }}‚Äì{{ p.end }}">
              <input type="checkbox" name="period_codes" value="{{ p.code }}">
              <span>{{ p.title }}</span>
            </label>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <div>
      <div class="panel-section-title">–ö–∞–∫–æ–π —Å—Ç–∞—Ç—É—Å?</div>
      <div class="status-selector">
        <label class="status-option">
          <input type="radio" name="status" value="present">
          <div class="status-box"><i>‚úì</i><span>–ë—ã–ª</span></div>
        </label>
        <label class="status-option">
          <input type="radio" name="status" value="late">
          <div class="status-box"><i>‚è±</i><span>–û–ø–æ–∑–¥–∞–ª</span></div>
        </label>
        <label class="status-option">
          <input type="radio" name="status" value="absent">
          <div class="status-box"><i>‚õî</i><span>–ù/–ë</span></div>
        </label>
        <label class="status-option">
          <input type="radio" name="status" value="excused" id="excusedBulk">
          <div class="status-box"><i>üìù</i><span>–£–≤–∞–∂.</span></div>
        </label>
      </div>
      
      <select name="reason" id="bulkReason" class="reason-select" disabled>
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É...</option>
        {% for r in excused_reasons %}
          <option value="{{ r }}">{{ r|capitalize }}</option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn-submit-bulk">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button type="reset" class="btn-quick-status" style="justify-content:center; width:100%; border:none;">–°–±—Ä–æ—Å–∏—Ç—å</button>
    
  </aside>
</div>
</form>

<script>
  // --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –ö–ê–†–¢–û–ß–ï–ö ---
  
  // –ö–ª–∏–∫ –ø–æ –≤—Å–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ (–∫—Ä–æ–º–µ –∫–Ω–æ–ø–æ–∫) –≤–∫–ª—é—á–∞–µ—Ç —á–µ–∫–±–æ–∫—Å
  function toggleCard(card) {
    const checkbox = card.querySelector('.st-checkbox');
    checkbox.checked = !checkbox.checked;
    updateCardVisual(card, checkbox.checked);
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–∞
  function updateCardVisual(card, isChecked) {
    if(isChecked) card.classList.add('selected');
    else card.classList.remove('selected');
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Å–∞–º–æ–º—É —á–µ–∫–±–æ–∫—Å—É (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è)
  document.querySelectorAll('.st-checkbox').forEach(cb => {
    cb.addEventListener('click', (e) => {
      e.stopPropagation(); // –Ω–µ –≤—Å–ø–ª—ã–≤–∞–µ–º –¥–æ toggleCard
      updateCardVisual(e.target.closest('.student-card'), e.target.checked);
    });
  });

  // "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤"
  document.getElementById('allStudents')?.addEventListener('change', function() {
    const isChecked = this.checked;
    document.querySelectorAll('.student-card').forEach(card => {
       const cb = card.querySelector('.st-checkbox');
       cb.checked = isChecked;
       updateCardVisual(card, isChecked);
    });
  });

  // "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ –ø–∞—Ä—ã"
  document.getElementById('allPeriods')?.addEventListener('change', function() {
    const isChecked = this.checked;
    document.querySelectorAll('input[name="period_codes"]').forEach(cb => cb.checked = isChecked);
  });

  // –õ–æ–≥–∏–∫–∞ "–ü—Ä–∏—á–∏–Ω—ã" –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –æ—Ç–º–µ—Ç–∫–∏
  const excusedBulk = document.getElementById('excusedBulk');
  const bulkReason = document.getElementById('bulkReason');
  document.querySelectorAll('input[name="status"]').forEach(radio => {
    radio.addEventListener('change', () => {
      if (excusedBulk.checked) {
        bulkReason.disabled = false;
      } else {
        bulkReason.disabled = true;
        bulkReason.value = "";
      }
    });
  });


  // --- –õ–û–ì–ò–ö–ê –ë–´–°–¢–†–û–ì–û –°–¢–ê–¢–£–°–ê (AJAX) ---
  
  const HAS_CURRENT = document.getElementById('has-current')?.getAttribute('data-value') === '1';

  function toggleMenu(event, menuId) {
    event.stopPropagation();
    // –ó–∞–∫—Ä—ã—Ç—å –¥—Ä—É–≥–∏–µ
    document.querySelectorAll('.popover-menu.open').forEach(m => {
       if(m.id !== menuId) m.classList.remove('open');
    });
    const menu = document.getElementById(menuId);
    menu.classList.toggle('open');
  }

  // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
  document.addEventListener('click', () => {
    document.querySelectorAll('.popover-menu.open').forEach(m => m.classList.remove('open'));
  });

  async function quickStatus(btn) {
    if (!HAS_CURRENT) {
      alert('–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–∞—Ä—ã. –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.');
      return;
    }

    const status = btn.dataset.status;
    const askReason = btn.dataset.askReason === '1';
    
    // –ù–∞—Ö–æ–¥–∏–º ID —Å—Ç—É–¥–µ–Ω—Ç–∞
    // btn -> popover -> div(wrapper) -> footer -> card
    // –ù–æ —É –Ω–∞—Å btn –≤–Ω—É—Ç—Ä–∏ –º–µ–Ω—é, –º–µ–Ω—é –ø–æ ID —Å–≤—è–∑–∞–Ω–æ. –ü—Ä–æ—â–µ –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–π .student-card –µ—Å–ª–∏ –º–µ–Ω—é –≤–Ω—É—Ç—Ä–∏ DOM –∫–∞—Ä—Ç–æ—á–∫–∏
    const card = btn.closest('.student-card');
    const sid = card.dataset.id;
    
    let reason = '';
    if (askReason) {
      reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É (sick/family/other):', 'sick');
      if (reason === null) return; // Cancel
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
    btn.closest('.popover-menu').classList.remove('open');

    // –í–∏–∑—É–∞–ª—å–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (–º–∏–≥–∞–Ω–∏–µ)
    card.style.opacity = '0.7';

    let fd = new FormData();
    fd.append('student_id', sid);
    fd.append('status', status);
    if(reason) fd.append('reason', reason);

    try {
      const res = await fetch('{{ url_for("checkin_bp.do_checkin_quick") }}', { method:'POST', body: fd });
      const j = await res.json();
      if(!res.ok || !j.ok) throw new Error(j.error || '–û—à–∏–±–∫–∞');
      
      // –£—Å–ø–µ—Ö - –≤–∏–∑—É–∞–ª—å–Ω–æ –º–∏–≥–Ω—É—Ç—å –∑–µ–ª–µ–Ω—ã–º –±–æ—Ä–¥–µ—Ä–æ–º
      const originalBorder = card.style.borderColor;
      card.style.borderColor = 'var(--color-present)';
      setTimeout(() => { card.style.borderColor = ''; card.style.opacity = '1'; }, 600);
      
    } catch(err) {
      alert('–û—à–∏–±–∫–∞: ' + err.message);
      card.style.opacity = '1';
    }
  }

</script>

{% endblock %}